{% extends "base.html" %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Início</a></li>
    <li class="breadcrumb-item active" aria-current="page">Eventos</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Header com melhor design -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1 fw-bold text-primary">
      {% if is_admin %}
        <i class="bi bi-calendar-event me-2"></i>Todos os Eventos
      {% else %}
        <i class="bi bi-calendar-heart me-2"></i>Meus Eventos
      {% endif %}
    </h2>
    <p class="text-muted mb-0">Gerencie e acompanhe seus eventos de forma eficiente</p>
  </div>
  <a href="{{ url_for('novo_evento') }}" class="btn btn-primary btn-lg shadow-sm">
    <i class="bi bi-plus-circle me-2"></i>Novo Evento
  </a>
</div>

<!-- Filtros aprimorados -->
{% set period = request.args.get('period', '90dias') %}
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body py-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between">
      <div class="d-flex align-items-center mb-2 mb-md-0">
        <i class="bi bi-funnel text-primary me-2"></i>
        <span class="fw-medium text-dark me-3">Filtrar por período:</span>
        <div class="btn-group btn-group-sm" role="group">
          <a href="?period=hoje" class="btn btn-outline-primary {% if period == 'hoje' %}active{% endif %}">Hoje</a>
          <a href="?period=ontem" class="btn btn-outline-primary {% if period == 'ontem' %}active{% endif %}">Ontem</a>
          <a href="?period=7dias" class="btn btn-outline-primary {% if period == '7dias' %}active{% endif %}">7 Dias</a>
          <a href="?period=mes" class="btn btn-outline-primary {% if period == 'mes' %}active{% endif %}">Este Mês</a>
          <a href="?period=90dias" class="btn btn-outline-primary {% if period == '90dias' %}active{% endif %}">90 Dias</a>
          <a href="?period=custom" class="btn btn-outline-primary {% if period == 'custom' %}active{% endif %}">Personalizado</a>
        </div>
      </div>
      
      {% if period == 'custom' %}
        <form method="get" class="d-flex align-items-center gap-2">
          <input type="hidden" name="period" value="custom">
          <input type="date" name="data_inicio" class="form-control form-control-sm" 
                 value="{{ data_inicio or request.args.get('data_inicio', '') }}" 
                 style="width: 140px;">
          <span class="text-muted">até</span>
          <input type="date" name="data_fim" class="form-control form-control-sm" 
                 value="{{ data_fim or request.args.get('data_fim', '') }}" 
                 style="width: 140px;">
          <button type="submit" class="btn btn-sm btn-primary">
            <i class="bi bi-search me-1"></i>Filtrar
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

{% if eventos %}
  <!-- Contador de eventos -->
  <div class="d-flex align-items-center mb-3">
    <div class="badge bg-light text-dark fs-6 px-3 py-2">
      <i class="bi bi-calendar-check me-1"></i>
      {{ eventos|length }} evento{{ 's' if eventos|length != 1 else '' }} encontrado{{ 's' if eventos|length != 1 else '' }}
    </div>
  </div>

  <div class="row g-4">
    {% for evento in eventos %}
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card evento-card h-100 border-0 shadow-sm" 
             data-aos="fade-up" data-aos-delay="{{ loop.index0 * 100 }}">
          
          <!-- Header do card com gradiente padronizado (CLICÁVEL) -->
          <div class="card-header border-0 p-0 position-relative clickable-zone" 
               data-bs-toggle="modal" 
               data-bs-target="#modalDetalhes{{ evento.id_evento }}"
               style="cursor: pointer;">
            <div class="evento-header bg-primary-gradient text-white p-4 rounded-top">
              
              <!-- Status badge no canto superior direito -->
              <div class="position-absolute top-0 end-0 mt-2 me-2">
                <span class="badge 
                  {% if evento.status == 'a realizar' %}bg-warning text-dark
                  {% elif evento.status == 'em andamento' %}bg-info
                  {% elif evento.status == 'realizado' %}bg-success
                  {% else %}bg-secondary{% endif %} fw-medium px-2 py-1">
                  {% if evento.status == 'a realizar' %}
                    <i class="bi bi-clock me-1"></i>A Realizar
                  {% elif evento.status == 'em andamento' %}
                    <i class="bi bi-play-circle me-1"></i>Em Andamento
                  {% elif evento.status == 'realizado' %}
                    <i class="bi bi-check-circle me-1"></i>Realizado
                  {% else %}
                    <i class="bi bi-question-circle me-1"></i>{{ evento.status.capitalize() }}
                  {% endif %}
                </span>
              </div>
              
              <h5 class="card-title mb-2 fw-bold text-truncate" title="{{ evento.nome }}">
                {{ evento.nome }}
              </h5>
              
              <!-- Datas em destaque -->
              <div class="d-flex align-items-center text-white-50">
                <i class="bi bi-calendar3 me-2"></i>
                <span class="small">
                  {{ evento.data_inicio.strftime('%d/%m/%Y') }} 
                  {% if evento.data_inicio != evento.data_fim %}
                    - {{ evento.data_fim.strftime('%d/%m/%Y') }}
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
          
          <div class="card-body p-4">
            <!-- Informações básicas com ícones (CLICÁVEL) -->
            <div class="evento-info mb-4 clickable-zone" 
                 data-bs-toggle="modal" 
                 data-bs-target="#modalDetalhes{{ evento.id_evento }}"
                 style="cursor: pointer;">
              <div class="info-item d-flex align-items-center mb-2">
                <div class="info-icon bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                  <i class="bi bi-geo-alt"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium text-dark">{{ evento.cidade }}/{{ evento.estado }}</div>
                  {% if evento.endereco %}
                    <div class="text-muted small">{{ evento.endereco }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="info-item d-flex align-items-center mb-2">
                <div class="info-icon bg-success bg-opacity-10 text-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                  <i class="bi bi-building"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium text-dark">{{ evento.circo.nome if evento.circo else 'Circo não definido' }}</div>
                  <div class="text-muted small">Circo responsável</div>
                </div>
              </div>
              
              <div class="info-item d-flex align-items-center">
                <div class="info-icon bg-info bg-opacity-10 text-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                  <i class="bi bi-person-badge"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium text-dark">{{ evento.produtor.nome if evento.produtor else 'Produtor não definido' }}</div>
                  <div class="text-muted small">Produtor responsável</div>
                </div>
              </div>
            </div>
            
            <!-- Ações rápidas otimizadas para mobile (NÃO CLICÁVEL) -->
            <div class="evento-actions mb-3 non-clickable-zone">
              <!-- Ações principais com foco mobile -->
              <div class="action-grid-primary mb-3">
                <button type="button" class="btn-action-mobile btn-danger-mobile" 
                        data-bs-toggle="modal" data-bs-target="#modalAdicionarDespesa{{ evento.id_evento }}"
                        data-action="despesa" data-evento="{{ evento.id_evento }}"
                        onclick="event.stopPropagation();">
                  <div class="btn-action-mobile-content">
                    <i class="bi bi-credit-card"></i>
                    <span class="btn-action-mobile-text">Despesa</span>
                    <div class="btn-action-mobile-subtitle">Adicionar gasto</div>
                  </div>
                  <div class="btn-action-mobile-ripple"></div>
                  </button>
                
                <button type="button" class="btn-action-mobile btn-success-mobile" 
                        data-bs-toggle="modal" data-bs-target="#modalAdicionarReceita{{ evento.id_evento }}"
                        data-action="receita" data-evento="{{ evento.id_evento }}"
                        onclick="event.stopPropagation();">
                  <div class="btn-action-mobile-content">
                    <i class="bi bi-cash-coin"></i>
                    <span class="btn-action-mobile-text">Receita</span>
                    <div class="btn-action-mobile-subtitle">Adicionar entrada</div>
                </div>
                  <div class="btn-action-mobile-ripple"></div>
                  </button>
              </div>
              
              <!-- Ações secundárias com design simplificado -->
              <div class="action-grid-secondary">
                  <a href="{{ url_for('equipe_evento', id_evento=evento.id_evento) }}" 
                   class="btn-action-secondary-mobile btn-primary-secondary"
                   onclick="event.stopPropagation();">
                  <i class="bi bi-people"></i>
                  <span>Equipe</span>
                </a>
                
                  <a href="{{ url_for('elenco_evento', id_evento=evento.id_evento) }}" 
                   class="btn-action-secondary-mobile btn-warning-secondary"
                   onclick="event.stopPropagation();">
                  <i class="bi bi-person-video"></i>
                  <span>Elenco</span>
                </a>
                
                  <a href="{{ url_for('fornecedor_evento', id_evento=evento.id_evento) }}" 
                   class="btn-action-secondary-mobile btn-info-secondary"
                   onclick="event.stopPropagation();">
                  <i class="bi bi-shop"></i>
                  <span>Fornecedores</span>
                </a>
                
                  <a href="{{ url_for('veiculos_evento', id_evento=evento.id_evento) }}" 
                   class="btn-action-secondary-mobile btn-success-secondary"
                   onclick="event.stopPropagation();">
                  <i class="bi bi-car-front"></i>
                  <span>Veículos</span>
                </a>
              </div>
            </div>
            
            <!-- Footer com menu de ações mobile-friendly (NÃO CLICÁVEL) -->
            <div class="evento-footer pt-3 border-top non-clickable-zone">
              <div class="d-flex justify-content-between align-items-center">
                <button class="btn-mobile-secondary" 
                        data-bs-toggle="modal" data-bs-target="#modalDetalhes{{ evento.id_evento }}"
                        onclick="event.stopPropagation();">
                  <i class="bi bi-eye"></i>
                  <span>Detalhes</span>
              </button>
                
                <a href="{{ url_for('editar_evento', id=evento.id_evento) }}" 
                   class="btn-mobile-primary"
                   onclick="event.stopPropagation();">
                  <i class="bi bi-pencil-square"></i>
                  <span>Editar</span>
                </a>
              
              <div class="dropdown">
                  <button class="btn-mobile-menu" type="button" 
                          data-bs-toggle="dropdown" aria-expanded="false" 
                          id="dropdownMenuButton{{ evento.id_evento }}"
                          onclick="event.stopPropagation();">
                    <i class="bi bi-three-dots-vertical"></i>
                    <span>Menu</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownMenuButton{{ evento.id_evento }}">
                  <li>
                    <a href="{{ url_for('editar_evento', id=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-pencil me-2 text-primary"></i>Editar Evento
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('relatorio_faturamento_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-bar-chart me-2 text-info"></i>Relatório Financeiro
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('relatorio_fechamento_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-clipboard-check me-2 text-warning"></i>Fechamento de Evento
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalAdicionarDespesa{{ evento.id_evento }}">
                      <i class="bi bi-credit-card me-2 text-danger"></i>Adicionar Despesa
                    </a>
                  </li>
                  <li>
                    <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalAdicionarReceita{{ evento.id_evento }}">
                      <i class="bi bi-cash-coin me-2 text-info"></i>Adicionar Receita
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a href="{{ url_for('equipe_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-people me-2 text-primary"></i>Gerenciar Equipe
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('elenco_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-person-video me-2 text-warning"></i>Gerenciar Elenco
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('fornecedor_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-shop me-2 text-success"></i>Gerenciar Fornecedores
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('veiculos_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-car-front me-2 text-success"></i>Gerenciar Veículos
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a href="#" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#modalExcluir{{ evento.id_evento }}">
                      <i class="bi bi-trash me-2"></i>Excluir Evento
                    </a>
                  </li>
                </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Adicionar Despesa -->
      <div class="modal fade" id="modalAdicionarDespesa{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-credit-card me-2"></i>Adicionar Despesa
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="adicionarDespesaCompleta(event, '{{ evento.id_evento }}')" enctype="multipart/form-data">
              <div class="modal-body p-4">
                <div class="alert alert-light border-start border-danger border-4 mb-4">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle text-danger me-2"></i>
                    <div>
                      <strong>{{ evento.nome }}</strong>
                      <div class="text-muted small">{{ evento.cidade }}/{{ evento.estado }} • {{ evento.data_inicio.strftime('%d/%m/%Y') }}</div>
                    </div>
                  </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label fw-medium">Categoria da Despesa</label>
                    <select name="categoria_despesa" class="form-select" required 
                            onchange="carregarDespesasPorCategoria(this, '{{ evento.id_evento }}')">
                      <option value="">Selecione uma categoria...</option>
                      {% for categoria in categorias_despesa %}
                      <option value="{{ categoria.id_categoria_despesa }}">{{ categoria.nome }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Despesa</label>
                    <select name="despesa_id" class="form-select" required>
                      <option value="">Primeiro selecione a categoria...</option>
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Data de Vencimento</label>
                    <input type="date" name="data_vencimento" class="form-control" required value="{{ current_date }}">
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Data de Pagamento</label>
                    <input type="date" name="data_pagamento" class="form-control">
                    <small class="text-muted">Opcional - preencha apenas se já foi pago</small>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Valor (R$)</label>
                    <input type="text" name="valor" class="form-control" required placeholder="0,00"
                           oninput="formatarMoeda(this)">
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Fornecedor</label>
                    <select name="fornecedor_id" class="form-select">
                      <option value="">Selecione um fornecedor...</option>
                      {% for fornecedor in fornecedores %}
                      <option value="{{ fornecedor.id_fornecedor }}">{{ fornecedor.nome }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Status</label>
                    <select name="status_pagamento" class="form-select" required>
                      <option value="pendente">Pendente</option>
                      <option value="pago">Pago</option>
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Forma de Pagamento</label>
                    <select name="forma_pagamento" class="form-select" required>
                      <option value="débito">Débito</option>
                      <option value="crédito">Crédito</option>
                      <option value="espécie">Espécie</option>
                      <option value="pix">Pix</option>
                    </select>
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Pago por</label>
                    <input type="text" name="pago_por" class="form-control">
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Comprovante</label>
                    <!-- Comprovante atual (se existir) -->
                    <div id="comprovante_atual_info_{{ evento.id_evento }}" class="mb-3 d-none">
                      <div class="alert alert-info d-flex align-items-center">
                        <i class="bi bi-file-earmark-text text-info me-2"></i>
                        <div class="flex-grow-1">
                          <small class="text-muted d-block">Comprovante anexado:</small>
                          <span class="fw-medium" id="comprovante_atual_nome_{{ evento.id_evento }}">arquivo_atual.pdf</span>
                        </div>
                        <div class="btn-group">
                          <button type="button" class="btn btn-sm btn-outline-primary" onclick="visualizarComprovante('{{ evento.id_evento }}')" title="Visualizar arquivo">
                            <i class="bi bi-eye"></i>
                          </button>
                          <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirComprovanteAtual('{{ evento.id_evento }}')" title="Remover arquivo">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Input para novo comprovante -->
                    <input type="file" name="comprovante" class="form-control" id="modal_despesa_comprovante_{{ evento.id_evento }}"
                           accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                    <input type="hidden" id="comprovante_atual_arquivo_{{ evento.id_evento }}" name="comprovante_atual">
                    <div class="form-text">
                      <small><i class="bi bi-info-circle"></i> Anexe nota fiscal, recibo, comprovante PIX, etc. (máx. 16MB)</small>
                    </div>
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Observações</label>
                    <textarea name="observacoes" class="form-control" rows="3"></textarea>
                  </div>
                  
                  <div class="col-12">
                    <div class="form-check">
                      <input type="checkbox" name="despesa_cabeca" class="form-check-input" id="despesa_cabeca_{{ evento.id_evento }}" value="1">
                      <label class="form-check-label fw-medium" for="despesa_cabeca_{{ evento.id_evento }}">
                        Despesa da cabeça
                      </label>
                    </div>
                  </div>
                  
                  <!-- Campos de quantidade para despesas de alimentação -->
                  <div class="row" id="modal-campos-alimentacao-{{ evento.id_evento }}" style="display: none;">
                    <div class="col-12 mb-2">
                      <div class="alert alert-info alert-sm">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Despesa de Alimentação:</strong> Preencha as informações adicionais abaixo
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label fw-medium">Quantidade de Dias</label>
                      <div class="input-group">
                        <input type="number" name="qtd_dias" class="form-control" id="modal_qtd_dias_{{ evento.id_evento }}" min="1" placeholder="Ex: 5">
                        <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
                      </div>
                      <div class="form-text">
                        <small class="text-muted">Quantidade de dias que a alimentação deve cobrir</small>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label fw-medium">Quantidade de Pessoas</label>
                      <div class="input-group">
                        <input type="number" name="qtd_pessoas" class="form-control" id="modal_qtd_pessoas_{{ evento.id_evento }}" min="1" placeholder="Ex: 10">
                        <span class="input-group-text"><i class="bi bi-people"></i></span>
                      </div>
                      <div class="form-text">
                        <small class="text-muted">Número de pessoas que serão alimentadas</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-danger">
                  <i class="bi bi-plus-circle me-2"></i>Adicionar Despesa
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal Adicionar Receita -->
      <div class="modal fade" id="modalAdicionarReceita{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-cash-coin me-2"></i>Adicionar Receita
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="adicionarReceitaRapida(event, '{{ evento.id_evento }}')">
              <div class="modal-body p-4">
                <div class="alert alert-light border-start border-info border-4 mb-4">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle text-info me-2"></i>
                    <div>
                      <strong>{{ evento.nome }}</strong>
                      <div class="text-muted small">{{ evento.cidade }}/{{ evento.estado }} • {{ evento.data_inicio.strftime('%d/%m/%Y') }}</div>
                    </div>
                  </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label fw-medium">Categoria da Receita</label>
                    <select name="categoria_receita" class="form-select" required 
                            onchange="carregarReceitasPorCategoria(this, '{{ evento.id_evento }}')">
                      <option value="">Selecione uma categoria...</option>
                      {% for categoria in categorias_receita %}
                      <option value="{{ categoria.id_categoria_receita }}">{{ categoria.nome }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Receita</label>
                    <select name="receita_id" class="form-select" required>
                      <option value="">Primeiro selecione a categoria...</option>
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Data</label>
                    <input type="date" name="data" class="form-control" required value="{{ current_date }}">
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Valor (R$)</label>
                    <input type="text" name="valor" class="form-control" required placeholder="0,00"
                           oninput="formatarMoeda(this)">
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Observações</label>
                    <textarea name="observacoes" class="form-control" rows="3"></textarea>
                  </div>
                </div>
              </div>
              <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-info">
                  <i class="bi bi-plus-circle me-2"></i>Adicionar Receita
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal Detalhes Completo -->
      <div class="modal fade" id="modalDetalhes{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-eye me-2"></i>Detalhes Completos do Evento
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="max-height: 80vh; overflow-y: auto;">
              <!-- Loading State -->
              <div id="loadingDetalhes{{ evento.id_evento }}" class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando detalhes do evento...</p>
              </div>
              
              <!-- Content Container -->
              <div id="contentDetalhes{{ evento.id_evento }}" class="d-none">
                <!-- Header do evento -->
                <div class="bg-light p-4 border-bottom">
                  <div class="text-center">
                    <h4 class="text-primary fw-bold mb-2" id="eventoNome{{ evento.id_evento }}">{{ evento.nome }}</h4>
                    <div class="d-flex justify-content-center align-items-center gap-3 text-muted flex-wrap">
                      <span id="eventoDatas{{ evento.id_evento }}"><i class="bi bi-calendar3 me-1"></i>{{ evento.data_inicio.strftime('%d/%m/%Y') }} - {{ evento.data_fim.strftime('%d/%m/%Y') }}</span>
                      <span id="eventoLocal{{ evento.id_evento }}"><i class="bi bi-geo-alt me-1"></i>{{ evento.cidade }}/{{ evento.estado }}</span>
                      <span id="eventoStatus{{ evento.id_evento }}"></span>
                    </div>
                  </div>
                </div>
              
                <div class="container-fluid p-4">
                  <!-- Tabs de navegação -->
                  <ul class="nav nav-pills nav-fill mb-4" id="detalhesTab{{ evento.id_evento }}" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="info-tab{{ evento.id_evento }}" data-bs-toggle="pill" 
                              data-bs-target="#info{{ evento.id_evento }}" type="button" role="tab">
                        <i class="bi bi-info-circle me-2"></i>Informações
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="receitas-tab{{ evento.id_evento }}" data-bs-toggle="pill" 
                              data-bs-target="#receitas{{ evento.id_evento }}" type="button" role="tab">
                        <i class="bi bi-cash-coin me-2"></i>Receitas
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="despesas-tab{{ evento.id_evento }}" data-bs-toggle="pill" 
                              data-bs-target="#despesas{{ evento.id_evento }}" type="button" role="tab">
                        <i class="bi bi-credit-card me-2"></i>Despesas
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="financeiro-tab{{ evento.id_evento }}" data-bs-toggle="pill" 
                              data-bs-target="#financeiro{{ evento.id_evento }}" type="button" role="tab">
                        <i class="bi bi-calculator me-2"></i>Resumo Financeiro
                      </button>
                    </li>
                  </ul>

                  <!-- Tab content -->
                  <div class="tab-content" id="detalhesTabContent{{ evento.id_evento }}">
                    <!-- Tab Informações -->
                    <div class="tab-pane fade show active" id="info{{ evento.id_evento }}" role="tabpanel">
              <div class="row g-4">
                <!-- Informações Gerais -->
                <div class="col-md-6">
                  <div class="card border-0 bg-light h-100">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-info-circle me-2"></i>Informações Gerais
                      </h6>
                              <div class="info-item mb-2">
                        <strong>Status:</strong> 
                                <span id="statusBadge{{ evento.id_evento }}" class="badge ms-1"></span>
                      </div>
                              <div class="info-item mb-2">
                                <strong>Data Início:</strong> <span id="dataInicio{{ evento.id_evento }}"></span>
                      </div>
                              <div class="info-item mb-2">
                                <strong>Data Fim:</strong> <span id="dataFim{{ evento.id_evento }}"></span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Localização -->
                <div class="col-md-6">
                  <div class="card border-0 bg-light h-100">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-geo-alt me-2"></i>Localização
                      </h6>
                              <div class="info-item mb-2">
                                <strong>Cidade:</strong> <span id="cidade{{ evento.id_evento }}"></span>
                      </div>
                              <div class="info-item mb-2">
                                <strong>Estado:</strong> <span id="estado{{ evento.id_evento }}"></span>
                      </div>
                              <div class="info-item mb-2">
                                <strong>Endereço:</strong> <span id="endereco{{ evento.id_evento }}"></span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Responsáveis -->
                <div class="col-12">
                  <div class="card border-0 bg-light">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-people me-2"></i>Responsáveis
                      </h6>
                      <div class="row">
                        <div class="col-md-6 mb-2">
                                  <strong>Circo:</strong> <span id="circoNome{{ evento.id_evento }}"></span>
                        </div>
                        <div class="col-md-6 mb-2">
                                  <strong>Produtor:</strong> <span id="produtorNome{{ evento.id_evento }}"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                        <!-- Observações -->
                        <div class="col-12" id="observacoesContainer{{ evento.id_evento }}" style="display: none;">
                  <div class="card border-0 bg-light">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-chat-left-text me-2"></i>Observações
                      </h6>
                              <p class="mb-0" id="observacoes{{ evento.id_evento }}"></p>
                    </div>
                  </div>
                </div>
                      </div>
                    </div>

                    <!-- Tab Receitas -->
                    <div class="tab-pane fade" id="receitas{{ evento.id_evento }}" role="tabpanel">
                      <div class="row">
                        <div class="col-12">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Receitas do Evento</h5>
                            <span class="badge bg-success fs-6" id="totalReceitas{{ evento.id_evento }}">R$ 0,00</span>
                          </div>
                          <div id="receitasContainer{{ evento.id_evento }}">
                            <!-- Receitas serão carregadas aqui -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Tab Despesas -->
                    <div class="tab-pane fade" id="despesas{{ evento.id_evento }}" role="tabpanel">
                      <div class="row">
                        <div class="col-12">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Despesas do Evento</h5>
                            <span class="badge bg-danger fs-6" id="totalDespesas{{ evento.id_evento }}">R$ 0,00</span>
                          </div>
                          <div id="despesasContainer{{ evento.id_evento }}">
                            <!-- Despesas serão carregadas aqui -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Tab Resumo Financeiro -->
                    <div class="tab-pane fade" id="financeiro{{ evento.id_evento }}" role="tabpanel">
                      <div class="row g-4">
                        <!-- Card Receitas -->
                        <div class="col-md-4">
                          <div class="card border-0 bg-success bg-opacity-10 h-100">
                            <div class="card-body text-center">
                              <i class="bi bi-cash-coin text-success mb-3" style="font-size: 2.5rem;"></i>
                              <h6 class="text-success fw-bold">Total Receitas</h6>
                              <h4 class="text-success fw-bold" id="financeiroReceitas{{ evento.id_evento }}">R$ 0,00</h4>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Card Despesas -->
                        <div class="col-md-4">
                          <div class="card border-0 bg-danger bg-opacity-10 h-100">
                            <div class="card-body text-center">
                              <i class="bi bi-credit-card text-danger mb-3" style="font-size: 2.5rem;"></i>
                              <h6 class="text-danger fw-bold">Total Despesas</h6>
                              <h4 class="text-danger fw-bold" id="financeiroDespesas{{ evento.id_evento }}">R$ 0,00</h4>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Card Resultado -->
                        <div class="col-md-4">
                          <div class="card border-0 bg-primary bg-opacity-10 h-100">
                            <div class="card-body text-center">
                              <i class="bi bi-graph-up text-primary mb-3" style="font-size: 2.5rem;"></i>
                              <h6 class="text-primary fw-bold">Resultado (Lucro)</h6>
                              <h4 class="fw-bold" id="financeiroResultado{{ evento.id_evento }}">R$ 0,00</h4>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Detalhamento do Fechamento -->
                        <div class="col-12">
                          <div class="card border-0 bg-light">
                            <div class="card-header bg-transparent border-0">
                              <h6 class="text-primary fw-bold mb-0">
                                <i class="bi bi-calculator me-2"></i>Detalhamento do Fechamento
                              </h6>
                            </div>
                            <div class="card-body">
                              <div class="row g-3">
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between">
                                    <span>Despesas de Cabeça:</span>
                                    <span class="fw-bold" id="despesasCabeca{{ evento.id_evento }}">R$ 0,00</span>
                                  </div>
                                </div>
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between">
                                    <span>Total Líquido:</span>
                                    <span class="fw-bold" id="totalLiquido{{ evento.id_evento }}">R$ 0,00</span>
                                  </div>
                                </div>
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between">
                                    <span>50% Show:</span>
                                    <span class="fw-bold" id="cinquentaPorcento{{ evento.id_evento }}">R$ 0,00</span>
                                  </div>
                                </div>
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between">
                                    <span>Reembolso Mídias:</span>
                                    <span class="fw-bold" id="reembolsoMidias{{ evento.id_evento }}">R$ 0,00</span>
                                  </div>
                                </div>
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between">
                                    <span>Repasse Total:</span>
                                    <span class="fw-bold text-info" id="repasseTotal{{ evento.id_evento }}">R$ 0,00</span>
                                  </div>
                                </div>
                                <div class="col-md-6">
                                  <div class="d-flex justify-content-between">
                                    <span>Despesas Sócrates:</span>
                                    <span class="fw-bold" id="despesasSocrates{{ evento.id_evento }}">R$ 0,00</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer border-0 bg-light">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-2"></i>Fechar
              </button>
              <a href="{{ url_for('editar_evento', id=evento.id_evento) }}" class="btn btn-primary">
                <i class="bi bi-pencil me-2"></i>Editar Evento
              </a>
              <a href="{{ url_for('relatorio_fechamento_evento', id_evento=evento.id_evento) }}" class="btn btn-info">
                <i class="bi bi-file-text me-2"></i>Relatório Completo
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Excluir -->
      <div class="modal fade" id="modalExcluir{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclusão
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
              <div class="text-center">
                <div class="mb-3">
                  <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                </div>
                <h5 class="mb-3">Tem certeza que deseja excluir este evento?</h5>
                <div class="alert alert-warning">
                  <strong>{{ evento.nome }}</strong><br>
                  <small class="text-muted">{{ evento.cidade }}/{{ evento.estado }} • {{ evento.data_inicio.strftime('%d/%m/%Y') }}</small>
                </div>
                <p class="text-muted">Esta ação não pode ser desfeita. Todos os dados relacionados ao evento serão perdidos permanentemente.</p>
              </div>
            </div>
            <div class="modal-footer border-0 bg-light">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-2"></i>Cancelar
              </button>
              <a href="{{ url_for('excluir_evento', id=evento.id_evento) }}" class="btn btn-danger">
                <i class="bi bi-trash me-2"></i>Sim, Excluir
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <!-- Estado vazio aprimorado -->
  <div class="text-center py-5">
    <div class="mb-4">
      <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
    </div>
    <h4 class="text-muted mb-3">Nenhum evento encontrado</h4>
    <p class="text-muted mb-4">
      {% if period == 'custom' %}
        Não há eventos no período selecionado.
      {% else %}
        Não há eventos para o filtro "{{ period }}" selecionado.
      {% endif %}
    </p>
    <div class="d-flex justify-content-center gap-2">
      <a href="{{ url_for('novo_evento') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Criar Primeiro Evento
      </a>
      <a href="?period=90dias" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-clockwise me-2"></i>Ver Últimos 90 Dias
      </a>
    </div>
  </div>
{% endif %}

<!-- Estilos específicos da página -->
<style>
/* Gradiente padronizado para headers dos cards */
.bg-primary-gradient {
  background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
}

/* Zonas clicáveis e não-clicáveis */
.clickable-zone {
  cursor: pointer;
  border-radius: 8px;
  transition: background-color 0.2s ease;
}

.clickable-zone:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.clickable-zone:active {
  background-color: rgba(255, 255, 255, 0.2);
}

.non-clickable-zone {
  position: relative;
  z-index: 10;
  cursor: default;
}

/* Animações e transições */
.evento-card {
  transition: all 0.3s ease;
  border-radius: 16px !important;
  overflow: hidden;
}

.evento-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
}

.evento-header {
  position: relative;
  overflow: hidden;
}

.evento-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
  pointer-events: none;
}

/* Botões de ação */
.btn-action {
  padding: 12px 8px;
  border-radius: 12px;
  transition: all 0.2s ease;
  border-width: 2px;
}

.btn-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-action-sm {
  padding: 8px 4px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.btn-action-sm:hover {
  transform: translateY(-1px);
}

/* Info items */
.info-item {
  transition: all 0.2s ease;
}

.info-item:hover {
  transform: translateX(4px);
}

.info-icon {
  transition: all 0.2s ease;
}

.info-item:hover .info-icon {
  transform: scale(1.1);
}

/* Modais */
.modal-content {
  border-radius: 16px;
  overflow: hidden;
}

.modal-header {
  padding: 24px;
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  padding: 20px 24px;
}

/* Filtros */
.btn-outline-primary.active {
  background-color: var(--bs-primary);
  border-color: var(--bs-primary);
  color: white;
}

/* Responsividade aprimorada */
@media (max-width: 768px) {
  .evento-card {
    margin-bottom: 1rem;
  }
  
  .btn-action {
    padding: 10px 6px;
    font-size: 0.85rem;
  }
  
  .btn-action-sm {
    padding: 6px 3px;
    font-size: 0.7rem;
  }
  
  .info-icon {
    width: 28px !important;
    height: 28px !important;
  }
  
  .modal-dialog {
    margin: 0.5rem;
  }
}

/* Loading states */
.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Animações de entrada */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fadeInUp 0.6s ease forwards;
}

/* Badges personalizados */
.badge {
  border-radius: 20px;
  padding: 6px 12px;
  font-weight: 500;
}

/* Dropdowns */
.dropdown-menu {
  border-radius: 12px;
  border: none;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  padding: 8px 0;
}

.dropdown-item {
  padding: 10px 20px;
  transition: all 0.2s ease;
}

.dropdown-item:hover {
  background-color: #f8fafc;
  transform: translateX(4px);
}

.dropdown-divider {
  margin: 8px 0;
}
</style>

<script>
// Função para formatar valor como moeda
function formatarMoeda(input) {
    // Remove tudo que não é dígito
    let valor = input.value.replace(/\D/g, '');
    
    // Se não tem valor, limpa o campo
    if (!valor) {
        input.value = '';
        return;
    }
    
    // Converte para número e formata
    valor = parseInt(valor);
    
    // Formatar como moeda brasileira
    let valorFormatado = (valor / 100).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    input.value = valorFormatado;
}

// Função para converter valor formatado para número
function converterMoedaParaNumero(valorFormatado) {
    if (!valorFormatado) return 0;
    
    // Remove pontos de milhares e substitui vírgula por ponto
    return parseFloat(valorFormatado.replace(/\./g, '').replace(',', '.'));
}

// Função para carregar despesas por categoria
function carregarDespesasPorCategoria(selectCategoria, eventoId) {
    const categoriaId = selectCategoria.value;
    const selectDespesa = selectCategoria.closest('form').querySelector('[name="despesa_id"]');
    
    console.log('🔍 Carregando despesas para categoria:', categoriaId);
    
    // Limpar opções
    selectDespesa.innerHTML = '<option value="">Carregando...</option>';
    
    if (!categoriaId) {
        selectDespesa.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
        return;
    }
    
    // Fazer requisição para buscar despesas da categoria
    fetch(`/api/despesas-por-categoria/${categoriaId}`)
        .then(response => {
            console.log('📡 Resposta da API:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('📋 Despesas recebidas:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            selectDespesa.innerHTML = '<option value="">Selecione uma despesa...</option>';
            
            if (data.length === 0) {
                selectDespesa.innerHTML = '<option value="">Nenhuma despesa encontrada para esta categoria</option>';
                return;
            }
            
            data.forEach(despesa => {
                const option = document.createElement('option');
                option.value = despesa.id_despesa;
                option.textContent = despesa.nome;
                if (despesa.valor_medio) {
                    option.setAttribute('data-valor-medio', despesa.valor_medio.toFixed(2).replace('.', ','));
                }
                selectDespesa.appendChild(option);
            });
            
            // Remover listeners existentes e adicionar novos
            selectDespesa.removeEventListener('change', preencherValorMedio);
            selectDespesa.removeEventListener('change', function() { verificarDespesaAlimentacaoEventos(this, eventoId); });
            
            selectDespesa.addEventListener('change', preencherValorMedio);
            selectDespesa.addEventListener('change', function() { 
                console.log('🔄 Despesa selecionada, verificando alimentação...');
                verificarDespesaAlimentacaoEventos(this, eventoId); 
            });
        })
        .catch(error => {
            console.error('❌ Erro ao carregar despesas:', error);
            selectDespesa.innerHTML = '<option value="">Erro ao carregar despesas</option>';
            mostrarNotificacao(`❌ Erro ao carregar despesas: ${error.message}`, 'danger');
        });
}

// Função separada para preencher valor médio
function preencherValorMedio() {
    const selectedOption = this.selectedOptions[0];
    const valorMedio = selectedOption.getAttribute('data-valor-medio');
    const inputValor = this.closest('form').querySelector('[name="valor"]');
    
    // Não preencher automaticamente - deixar o campo limpo para o usuário inserir
    // if (valorMedio && inputValor && !inputValor.value) {
    //     inputValor.value = valorMedio;
    // }
    
    // Apenas limpar o campo quando trocar de despesa
    if (inputValor) {
        inputValor.value = '';
        inputValor.placeholder = valorMedio ? `Sugestão: R$ ${valorMedio}` : '0,00';
    }
}

// Função para verificar se a despesa selecionada é de alimentação
function verificarDespesaAlimentacaoEventos(selectDespesa, eventoId) {
    console.log('🔍 === VERIFICANDO ALIMENTAÇÃO EVENTOS ===');
    
    const despesaId = selectDespesa.value;
    const camposAlimentacao = document.getElementById(`modal-campos-alimentacao-${eventoId}`);
    const qtdDiasInput = document.getElementById(`modal_qtd_dias_${eventoId}`);
    const qtdPessoasInput = document.getElementById(`modal_qtd_pessoas_${eventoId}`);
    
    console.log('📋 Elementos encontrados:', {
        eventoId: eventoId,
        despesaId: despesaId,
        camposAlimentacao: !!camposAlimentacao,
        qtdDiasInput: !!qtdDiasInput,
        qtdPessoasInput: !!qtdPessoasInput
    });
    
    if (despesaId && despesaId != '0') {
        console.log('🔄 Fazendo requisição para API...');
        
        // Buscar informações da despesa selecionada
        fetch(`/api/despesa-detalhes/${despesaId}`)
            .then(response => {
                console.log('📡 Resposta da API recebida:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('📊 Dados da API:', data);
                
                if (data.flag_alimentacao) {
                    console.log('✅ É despesa de alimentação! Mostrando campos...');
                    
                    // Mostrar campos de quantidade
                    if (camposAlimentacao) {
                        console.log('🟡 Aplicando estilo ao elemento...');
                        camposAlimentacao.style.display = 'block';
                        camposAlimentacao.style.backgroundColor = '#ffffcc'; // Destaque amarelo para debug
                        camposAlimentacao.style.border = '2px solid #ffc107'; // Borda amarela visível
                        camposAlimentacao.style.padding = '15px'; // Padding para visibilidade
                        camposAlimentacao.style.marginTop = '10px'; // Margem
                        console.log('✅ Campos exibidos com destaque AMARELO');
                    } else {
                        console.error('❌ Elemento modal-campos-alimentacao não encontrado!');
                    }
                    
                    // Tornar campos obrigatórios
                    if (qtdDiasInput) {
                        qtdDiasInput.setAttribute('required', 'required');
                        console.log('✅ Campo qtd_dias marcado como obrigatório');
                    }
                    if (qtdPessoasInput) {
                        qtdPessoasInput.setAttribute('required', 'required');
                        console.log('✅ Campo qtd_pessoas marcado como obrigatório');
                    }
                } else {
                    console.log('❌ NÃO é despesa de alimentação. Escondendo campos...');
                    
                    // Esconder campos de quantidade
                    if (camposAlimentacao) {
                        camposAlimentacao.style.display = 'none';
                    }
                    
                    // Remover obrigatoriedade e limpar valores
                    if (qtdDiasInput) {
                        qtdDiasInput.removeAttribute('required');
                        qtdDiasInput.value = '';
                    }
                    if (qtdPessoasInput) {
                        qtdPessoasInput.removeAttribute('required');
                        qtdPessoasInput.value = '';
                    }
                }
            })
            .catch(error => {
                console.error('❌ Erro ao verificar despesa:', error);
                
                // Em caso de erro, esconder campos
                if (camposAlimentacao) {
                    camposAlimentacao.style.display = 'none';
                }
                if (qtdDiasInput) qtdDiasInput.removeAttribute('required');
                if (qtdPessoasInput) qtdPessoasInput.removeAttribute('required');
            });
    } else {
        console.log('⚠️ Nenhuma despesa selecionada. Escondendo campos...');
        
        // Nenhuma despesa selecionada, esconder campos
        if (camposAlimentacao) {
            camposAlimentacao.style.display = 'none';
        }
        if (qtdDiasInput) {
            qtdDiasInput.removeAttribute('required');
            qtdDiasInput.value = '';
        }
        if (qtdPessoasInput) {
            qtdPessoasInput.removeAttribute('required');
            qtdPessoasInput.value = '';
        }
    }
    
    console.log('🏁 === FIM DA VERIFICAÇÃO EVENTOS ===');
}

// Função para carregar receitas por categoria
function carregarReceitasPorCategoria(selectCategoria, eventoId) {
    const categoriaId = selectCategoria.value;
    const selectReceita = selectCategoria.closest('form').querySelector('[name="receita_id"]');
    
    // Limpar opções
    selectReceita.innerHTML = '<option value="">Carregando...</option>';
    
    if (!categoriaId) {
        selectReceita.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
        return;
    }
    
    // Fazer requisição para buscar receitas da categoria
    fetch(`/api/receitas-por-categoria/${categoriaId}`)
        .then(response => response.json())
        .then(data => {
            selectReceita.innerHTML = '<option value="">Selecione uma receita...</option>';
            
            data.forEach(receita => {
                const option = document.createElement('option');
                option.value = receita.id_receita;
                option.textContent = receita.nome;
                selectReceita.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar receitas:', error);
            selectReceita.innerHTML = '<option value="">Erro ao carregar receitas</option>';
        });
}

// Função para adicionar despesa completa (com upload)
function adicionarDespesaCompleta(event, eventoId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Converter eventoId para número se for string
    const eventoIdNum = parseInt(eventoId);
    
    // Converter valor formatado para número
    const valorFormatado = formData.get('valor');
    const valorNumerico = converterMoedaParaNumero(valorFormatado);
    
    // Atualizar o valor no FormData
    formData.set('valor', valorNumerico.toString());
    
    // Garantir que o despesa_id seja um número
    formData.set('despesa_id', parseInt(formData.get('despesa_id')));
    
    // Adicionar fornecedor_id com o nome correto para o backend
    if (formData.get('fornecedor_id')) {
        formData.set('id_fornecedor', formData.get('fornecedor_id'));
    }
    
    // Desabilitar botão durante envio
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>Adicionando...';
    
    // Enviar dados como FormData (suporta upload de arquivo)
    fetch(`/eventos/${eventoIdNum}/salvar-despesa`, {
        method: 'POST',
        body: formData  // FormData não precisa de Content-Type manual
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Mostrar sucesso
            mostrarNotificacao('✅ Despesa adicionada com sucesso!', 'success');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();
            
            // Limpar formulário
            form.reset();
            
            // Resetar dropdowns
            const selectDespesa = form.querySelector('[name="despesa_id"]');
            selectDespesa.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
            
            // Limpar campo de comprovante e esconder info do comprovante atual
            const comprovanteField = document.getElementById(`modal_despesa_comprovante_${eventoId}`);
            if (comprovanteField) {
                comprovanteField.value = '';
            }
            const comprovanteInfo = document.getElementById(`comprovante_atual_info_${eventoId}`);
            if (comprovanteInfo) {
                comprovanteInfo.classList.add('d-none');
            }
            
            // Se foi informado um comprovante, mostrar na notificação
            if (result.comprovante) {
                mostrarNotificacao('✅ Despesa e comprovante adicionados com sucesso!', 'success');
            }
        } else {
            mostrarNotificacao('❌ Erro: ' + result.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarNotificacao('❌ Erro ao adicionar despesa: ' + error.message, 'danger');
    })
    .finally(() => {
        // Reabilitar botão
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Função para adicionar receita rápida
function adicionarReceitaRapida(event, eventoId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Converter eventoId para número se for string
    const eventoIdNum = parseInt(eventoId);
    
    // Converter valor formatado para número
    const valorFormatado = formData.get('valor');
    const valorNumerico = converterMoedaParaNumero(valorFormatado);
    
    // Criar objeto JSON com os dados
    const dados = {
        receita_id: parseInt(formData.get('receita_id')),
        data: formData.get('data'),
        valor: valorNumerico.toString(),
        observacoes: formData.get('observacoes') || ''
    };
    
    // Desabilitar botão durante envio
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>Adicionando...';
    
    // Enviar dados como JSON
    fetch(`/eventos/${eventoIdNum}/salvar-receita`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Mostrar sucesso
            mostrarNotificacao('✅ Receita adicionada com sucesso!', 'success');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();
            
            // Limpar formulário
            form.reset();
            
            // Resetar dropdowns
            const selectReceita = form.querySelector('[name="receita_id"]');
            selectReceita.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
        } else {
            mostrarNotificacao('❌ Erro: ' + result.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarNotificacao('❌ Erro ao adicionar receita: ' + error.message, 'danger');
    })
    .finally(() => {
        // Reabilitar botão
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Função para mostrar notificações
function mostrarNotificacao(mensagem, tipo) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    alertDiv.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Remover após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Função para visualizar comprovante atual
function visualizarComprovante(eventoId) {
    const nomeArquivo = document.getElementById(`comprovante_atual_arquivo_${eventoId}`).value;
    if (nomeArquivo) {
        window.open(`/uploads/comprovantes/${nomeArquivo}`, '_blank');
    }
}

// Função para excluir comprovante atual
function excluirComprovanteAtual(eventoId) {
    if (!confirm('Tem certeza que deseja excluir o comprovante atual? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    // Buscar ID da despesa evento (seria necessário para implementar a exclusão)
    // Por enquanto, apenas esconder a interface do comprovante
    const comprovanteInfo = document.getElementById(`comprovante_atual_info_${eventoId}`);
    const comprovanteArquivo = document.getElementById(`comprovante_atual_arquivo_${eventoId}`);
    
    if (comprovanteInfo && comprovanteArquivo) {
        comprovanteInfo.classList.add('d-none');
        comprovanteArquivo.value = '';
        mostrarNotificacao('✅ Comprovante marcado para exclusão', 'success');
    }
}

// Função simples para garantir que os dropdowns funcionem
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 Inicializando dropdowns...');
    
    // Aguardar carregamento completo
    setTimeout(function() {
        // Forçar inicialização de todos os dropdowns
        const dropdownElements = document.querySelectorAll('[data-bs-toggle="dropdown"]');
        console.log('📋 Dropdowns encontrados:', dropdownElements.length);
        
        dropdownElements.forEach(function(element, index) {
            try {
                // Verificar se o Bootstrap está disponível
                if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
                    // Destruir instância existente
                    const existingInstance = bootstrap.Dropdown.getInstance(element);
                    if (existingInstance) {
                        existingInstance.dispose();
                    }
                    
                    // Criar nova instância
                    const dropdown = new bootstrap.Dropdown(element);
                    console.log(`✅ Dropdown ${index + 1} inicializado`);
                    
                    // Adicionar eventos para debug
                    element.addEventListener('show.bs.dropdown', function() {
                        console.log('🔓 Dropdown abrindo:', element.id);
                    });
                    
                    element.addEventListener('hide.bs.dropdown', function() {
                        console.log('🔒 Dropdown fechando:', element.id);
                    });
                    
                } else {
                    console.error('❌ Bootstrap não disponível');
                }
            } catch (error) {
                console.error(`❌ Erro no dropdown ${index + 1}:`, error);
            }
        });
        
        // Teste adicional: verificar se podemos abrir manualmente
        dropdownElements.forEach(function(element) {
            element.addEventListener('click', function(e) {
                console.log('🖱️ Clique detectado no dropdown:', element.id);
                
                // Fallback manual se necessário
                const dropdown = bootstrap.Dropdown.getInstance(element);
                if (!dropdown) {
                    console.log('⚠️ Criando instância no clique');
                    try {
                        new bootstrap.Dropdown(element);
                    } catch (error) {
                        console.error('❌ Erro ao criar instância:', error);
                    }
                }
            });
        });
        
    }, 200);
});

// Debug: monitorar mudanças no DOM
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target;
            if (target.classList.contains('dropdown-menu')) {
                console.log('📋 Mudança no menu dropdown:', target.classList.contains('show') ? 'ABERTO' : 'FECHADO');
            }
        }
    });
});

// Observar todos os menus dropdown
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const menus = document.querySelectorAll('.dropdown-menu');
        menus.forEach(function(menu) {
            observer.observe(menu, { attributes: true });
        });
    }, 300);
    
    // Limpar formulários quando modais forem abertos
    const modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
        modal.addEventListener('show.bs.modal', function() {
            const form = modal.querySelector('form');
            if (form) {
                // Resetar formulário
                form.reset();
                
                // Resetar dropdowns para estado inicial
                const selectDespesa = form.querySelector('[name="despesa_id"]');
                const selectReceita = form.querySelector('[name="receita_id"]');
                
                if (selectDespesa) {
                    selectDespesa.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
                }
                
                if (selectReceita) {
                    selectReceita.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
                }
                
                // Limpar placeholder do valor
                const inputValor = form.querySelector('[name="valor"]');
                if (inputValor) {
                    inputValor.placeholder = '0,00';
                }
            }
        });
    });
});

// JavaScript para UX Mobile
document.addEventListener('DOMContentLoaded', function() {
    // Melhorar UX dos botões mobile
    function initMobileButtons() {
        // Adicionar efeito ripple aos botões principais
        const mobileButtons = document.querySelectorAll('.btn-action-mobile');
        
        mobileButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // Criar efeito ripple
                const ripple = this.querySelector('.btn-action-mobile-ripple');
                if (ripple) {
                    ripple.style.transform = 'scale(0)';
                    ripple.style.transition = 'none';
                    
                    setTimeout(() => {
                        ripple.style.transition = 'transform 0.6s ease-out';
                        ripple.style.transform = 'scale(1)';
                    }, 10);
                    
                    // Reset após animação
                    setTimeout(() => {
                        ripple.style.transform = 'scale(0)';
                    }, 600);
                }
                
                // Haptic feedback para dispositivos compatíveis
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            });

            // Melhorar feedback tátil
            button.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98)';
            });

            button.addEventListener('touchend', function() {
                this.style.transform = '';
            });
        });

        // Adicionar feedback aos botões secundários
        const secondaryButtons = document.querySelectorAll('.btn-action-secondary-mobile');
        
        secondaryButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Haptic feedback mais suave
                if (navigator.vibrate) {
                    navigator.vibrate(5);
                }
            });

            button.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.96)';
                this.style.backgroundColor = 'var(--gray-50)';
            });

            button.addEventListener('touchend', function() {
                this.style.transform = '';
                this.style.backgroundColor = '';
            });
        });

        // Melhorar botões do footer
        const footerButtons = document.querySelectorAll('.btn-mobile-secondary, .btn-mobile-primary, .btn-mobile-menu');
        
        footerButtons.forEach(button => {
            button.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.96)';
                this.style.opacity = '0.8';
            });

            button.addEventListener('touchend', function() {
                this.style.transform = '';
                this.style.opacity = '';
            });
        });
    }

    // Melhorar carregamento de modais com loading state
    function initModalLoadingStates() {
        const modalTriggers = document.querySelectorAll('[data-bs-toggle="modal"]');
        
        modalTriggers.forEach(trigger => {
            trigger.addEventListener('click', function() {
                // Adicionar estado de loading ao botão
                const originalContent = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Carregando...';
                this.disabled = true;
                
                // Restaurar depois de 1 segundo (tempo típico para o modal abrir)
                setTimeout(() => {
                    this.innerHTML = originalContent;
                    this.disabled = false;
                }, 1000);
            });
        });
    }

    // Adicionar swipe gesture para cards de evento (opcional)
    function initSwipeGestures() {
        const eventoCards = document.querySelectorAll('.evento-card');
        
        eventoCards.forEach(card => {
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;

            card.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });

            card.addEventListener('touchmove', function(e) {
                if (!startX || !startY) return;
                
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
                
                const diffX = startX - currentX;
                const diffY = startY - currentY;
                
                // Se o swipe horizontal for maior que o vertical e maior que 50px
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    // Adicionar indicação visual sutil
                    if (diffX > 0) {
                        // Swipe left - mostrar ações
                        card.style.transform = 'translateX(-5px)';
                        card.style.boxShadow = 'var(--shadow-lg)';
                    } else {
                        // Swipe right - voltar
                        card.style.transform = 'translateX(5px)';
                    }
                }
            });

            card.addEventListener('touchend', function() {
                // Reset
                card.style.transform = '';
                card.style.boxShadow = '';
                startX = 0;
                startY = 0;
            });
        });
    }

    // Inicializar todas as melhorias
    initMobileButtons();
    initModalLoadingStates();
    initSwipeGestures();

    // Debugging para desenvolvedores (remover em produção)
    console.log('🎨 UX Mobile melhorada carregada com sucesso!');
    console.log('📱 Recursos disponíveis:', {
        hapticFeedback: !!navigator.vibrate,
        touchDevice: 'ontouchstart' in window,
        screenSize: `${window.innerWidth}x${window.innerHeight}`
    });
});

// Função para carregar detalhes completos do evento
function carregarDetalhesEvento(eventoId) {
  // Mostrar loading
  document.getElementById('loadingDetalhes' + eventoId).classList.remove('d-none');
  document.getElementById('contentDetalhes' + eventoId).classList.add('d-none');
  
  // Fazer requisição para buscar detalhes
  fetch(`/api/evento/${eventoId}/detalhes-completos`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        preencherDetalhesEvento(eventoId, data);
        // Esconder loading e mostrar conteúdo
        document.getElementById('loadingDetalhes' + eventoId).classList.add('d-none');
        document.getElementById('contentDetalhes' + eventoId).classList.remove('d-none');
      } else {
        console.error('Erro ao carregar detalhes:', data.message);
        alert('Erro ao carregar detalhes do evento: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Erro na requisição:', error);
      alert('Erro ao carregar detalhes do evento');
      document.getElementById('loadingDetalhes' + eventoId).classList.add('d-none');
    });
}

// Função para preencher os detalhes do evento
function preencherDetalhesEvento(eventoId, data) {
  const evento = data.evento;
  const receitas = data.receitas;
  const despesas = data.despesas;
  const financeiro = data.financeiro;
  
  // Preencher informações básicas
  document.getElementById('eventoNome' + eventoId).textContent = evento.nome;
  document.getElementById('eventoDatas' + eventoId).innerHTML = `<i class="bi bi-calendar3 me-1"></i>${evento.data_inicio} - ${evento.data_fim}`;
  document.getElementById('eventoLocal' + eventoId).innerHTML = `<i class="bi bi-geo-alt me-1"></i>${evento.cidade}/${evento.estado}`;
  
  // Status badge
  const statusBadge = document.getElementById('statusBadge' + eventoId);
  let statusClass = 'bg-secondary';
  if (evento.status === 'a realizar') statusClass = 'bg-warning text-dark';
  else if (evento.status === 'em andamento') statusClass = 'bg-info';
  else if (evento.status === 'realizado') statusClass = 'bg-success';
  
  statusBadge.className = `badge ms-1 ${statusClass}`;
  statusBadge.textContent = evento.status.charAt(0).toUpperCase() + evento.status.slice(1);
  
  // Informações detalhadas
  document.getElementById('dataInicio' + eventoId).textContent = evento.data_inicio;
  document.getElementById('dataFim' + eventoId).textContent = evento.data_fim;
  document.getElementById('cidade' + eventoId).textContent = evento.cidade || '—';
  document.getElementById('estado' + eventoId).textContent = evento.estado || '—';
  document.getElementById('endereco' + eventoId).textContent = evento.endereco || '—';
  document.getElementById('circoNome' + eventoId).textContent = evento.circo_nome || '—';
  document.getElementById('produtorNome' + eventoId).textContent = evento.produtor_nome || '—';
  
  // Observações
  const obsContainer = document.getElementById('observacoesContainer' + eventoId);
  if (evento.observacoes) {
    document.getElementById('observacoes' + eventoId).textContent = evento.observacoes;
    obsContainer.style.display = 'block';
  } else {
    obsContainer.style.display = 'none';
  }
  
  // Receitas
  document.getElementById('totalReceitas' + eventoId).textContent = formatarMoeda(receitas.total);
  preencherReceitas(eventoId, receitas.categorias);
  
  // Despesas
  document.getElementById('totalDespesas' + eventoId).textContent = formatarMoeda(despesas.total);
  preencherDespesas(eventoId, despesas.categorias);
  
  // Resumo financeiro
  document.getElementById('financeiroReceitas' + eventoId).textContent = formatarMoeda(financeiro.total_receitas);
  document.getElementById('financeiroDespesas' + eventoId).textContent = formatarMoeda(financeiro.total_despesas);
  
  const resultado = financeiro.resultado_show;
  const resultadoElement = document.getElementById('financeiroResultado' + eventoId);
  resultadoElement.textContent = formatarMoeda(resultado);
  resultadoElement.className = `fw-bold ${resultado >= 0 ? 'text-success' : 'text-danger'}`;
  
  // Detalhamento do fechamento
  document.getElementById('despesasCabeca' + eventoId).textContent = formatarMoeda(financeiro.despesas_cabeca);
  document.getElementById('totalLiquido' + eventoId).textContent = formatarMoeda(financeiro.total_liquido);
  document.getElementById('cinquentaPorcento' + eventoId).textContent = formatarMoeda(financeiro.cinquenta_porcento_show);
  document.getElementById('reembolsoMidias' + eventoId).textContent = formatarMoeda(financeiro.reembolso_midias);
  document.getElementById('repasseTotal' + eventoId).textContent = formatarMoeda(financeiro.repasse_total);
  document.getElementById('despesasSocrates' + eventoId).textContent = formatarMoeda(financeiro.total_despesas_socrates);
}

// Função para preencher receitas por categoria
function preencherReceitas(eventoId, categorias) {
  const container = document.getElementById('receitasContainer' + eventoId);
  
  if (categorias.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-4">Nenhuma receita encontrada para este evento.</p>';
    return;
  }
  
  let html = '';
  categorias.forEach(categoria => {
    html += `
      <div class="card mb-3 border-0 bg-light">
        <div class="card-header bg-success bg-opacity-10 border-0">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 text-success fw-bold">${categoria.categoria_nome}</h6>
            <span class="badge bg-success">${formatarMoeda(categoria.total_categoria)}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Receita</th>
                  <th>Data</th>
                  <th class="text-end">Valor</th>
                </tr>
              </thead>
              <tbody>`;
    
    categoria.itens.forEach(item => {
      html += `
        <tr>
          <td>${item.receita_nome}</td>
          <td>${item.data}</td>
          <td class="text-end fw-bold text-success">${formatarMoeda(item.valor)}</td>
        </tr>`;
    });
    
    html += `
              </tbody>
            </table>
          </div>
        </div>
      </div>`;
  });
  
  container.innerHTML = html;
}

// Função para preencher despesas por categoria
function preencherDespesas(eventoId, categorias) {
  const container = document.getElementById('despesasContainer' + eventoId);
  
  if (categorias.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-4">Nenhuma despesa encontrada para este evento.</p>';
    return;
  }
  
  let html = '';
  categorias.forEach(categoria => {
    html += `
      <div class="card mb-3 border-0 bg-light">
        <div class="card-header bg-danger bg-opacity-10 border-0">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 text-danger fw-bold">${categoria.categoria_nome}</h6>
            <span class="badge bg-danger">${formatarMoeda(categoria.total_categoria)}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Despesa</th>
                  <th>Data</th>
                  <th>Status</th>
                  <th>Fornecedor</th>
                  <th>Cabeça</th>
                  <th class="text-end">Valor</th>
                </tr>
              </thead>
              <tbody>`;
    
    categoria.itens.forEach(item => {
      const statusBadge = item.status_pagamento === 'pago' ? 'bg-success' : 
                         item.status_pagamento === 'pendente' ? 'bg-warning text-dark' : 'bg-secondary';
      
      html += `
        <tr>
          <td>${item.despesa_nome}</td>
          <td>${item.data}</td>
          <td><span class="badge ${statusBadge}">${item.status_pagamento}</span></td>
          <td>${item.fornecedor_nome || '—'}</td>
          <td>${item.despesa_cabeca ? '<i class="bi bi-check-circle text-success"></i>' : '—'}</td>
          <td class="text-end fw-bold text-danger">${formatarMoeda(item.valor)}</td>
        </tr>`;
    });
    
    html += `
              </tbody>
            </table>
          </div>
        </div>
      </div>`;
  });
  
  container.innerHTML = html;
}

// Função auxiliar para formatar moeda
function formatarMoeda(valor) {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(valor);
}

// Event listener para quando o modal for aberto
document.addEventListener('DOMContentLoaded', function() {
  // Adicionar event listeners para todos os modais de detalhes
  const modais = document.querySelectorAll('[id^="modalDetalhes"]');
  
  modais.forEach(modal => {
    modal.addEventListener('show.bs.modal', function(event) {
      const eventoId = event.relatedTarget?.getAttribute('data-evento-id') || 
                      modal.id.replace('modalDetalhes', '');
      
      if (eventoId) {
        carregarDetalhesEvento(eventoId);
      }
    });
  });
});

// Utility function para detectar dispositivos móveis
function isMobileDevice() {
    return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
}

// Adicionar classe CSS baseada no tipo de dispositivo
if (isMobileDevice()) {
    document.documentElement.classList.add('mobile-device');
} else {
    document.documentElement.classList.add('desktop-device');
}
</script>

{% endblock %}
