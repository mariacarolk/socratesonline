{% extends "base.html" %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">In√≠cio</a></li>
    <li class="breadcrumb-item active" aria-current="page">Eventos</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Header com melhor design -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="mb-1 fw-bold text-primary">
      {% if is_admin %}
        <i class="bi bi-calendar-event me-2"></i>Todos os Eventos
      {% else %}
        <i class="bi bi-calendar-heart me-2"></i>Meus Eventos
      {% endif %}
    </h2>
    <p class="text-muted mb-0">Gerencie e acompanhe seus eventos de forma eficiente</p>
  </div>
  <a href="{{ url_for('novo_evento') }}" class="btn btn-primary btn-lg shadow-sm">
    <i class="bi bi-plus-circle me-2"></i>Novo Evento
  </a>
</div>

<!-- Filtros aprimorados -->
{% set period = request.args.get('period', '90dias') %}
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body py-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between">
      <div class="d-flex align-items-center mb-2 mb-md-0">
        <i class="bi bi-funnel text-primary me-2"></i>
        <span class="fw-medium text-dark me-3">Filtrar por per√≠odo:</span>
        <div class="btn-group btn-group-sm" role="group">
          <a href="?period=hoje" class="btn btn-outline-primary {% if period == 'hoje' %}active{% endif %}">Hoje</a>
          <a href="?period=ontem" class="btn btn-outline-primary {% if period == 'ontem' %}active{% endif %}">Ontem</a>
          <a href="?period=7dias" class="btn btn-outline-primary {% if period == '7dias' %}active{% endif %}">7 Dias</a>
          <a href="?period=mes" class="btn btn-outline-primary {% if period == 'mes' %}active{% endif %}">Este M√™s</a>
          <a href="?period=90dias" class="btn btn-outline-primary {% if period == '90dias' %}active{% endif %}">90 Dias</a>
          <a href="?period=custom" class="btn btn-outline-primary {% if period == 'custom' %}active{% endif %}">Personalizado</a>
        </div>
      </div>
      
      {% if period == 'custom' %}
        <form method="get" class="d-flex align-items-center gap-2">
          <input type="hidden" name="period" value="custom">
          <input type="date" name="data_inicio" class="form-control form-control-sm" 
                 value="{{ data_inicio or request.args.get('data_inicio', '') }}" 
                 style="width: 140px;">
          <span class="text-muted">at√©</span>
          <input type="date" name="data_fim" class="form-control form-control-sm" 
                 value="{{ data_fim or request.args.get('data_fim', '') }}" 
                 style="width: 140px;">
          <button type="submit" class="btn btn-sm btn-primary">
            <i class="bi bi-search me-1"></i>Filtrar
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

{% if eventos %}
  <!-- Contador de eventos -->
  <div class="d-flex align-items-center mb-3">
    <div class="badge bg-light text-dark fs-6 px-3 py-2">
      <i class="bi bi-calendar-check me-1"></i>
      {{ eventos|length }} evento{{ 's' if eventos|length != 1 else '' }} encontrado{{ 's' if eventos|length != 1 else '' }}
    </div>
  </div>

  <div class="row g-4">
    {% for evento in eventos %}
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card h-100 border-0 shadow-sm evento-card" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 100 }}">
          <!-- Header do card com gradiente baseado no status -->
          <div class="card-header border-0 p-0 position-relative">
            <div class="evento-header 
              {% if evento.status == 'a realizar' %}bg-warning-gradient
              {% elif evento.status == 'em andamento' %}bg-info-gradient
              {% elif evento.status == 'realizado' %}bg-success-gradient
              {% else %}bg-secondary-gradient{% endif %} 
              text-white p-4 rounded-top">
              
              <!-- Status badge no canto superior direito -->
              <div class="position-absolute top-0 end-0 mt-2 me-2">
                <span class="badge bg-white bg-opacity-90 text-dark fw-medium px-2 py-1">
                  {% if evento.status == 'a realizar' %}
                    <i class="bi bi-clock me-1"></i>A Realizar
                  {% elif evento.status == 'em andamento' %}
                    <i class="bi bi-play-circle me-1"></i>Em Andamento
                  {% elif evento.status == 'realizado' %}
                    <i class="bi bi-check-circle me-1"></i>Realizado
                  {% else %}
                    <i class="bi bi-question-circle me-1"></i>{{ evento.status.capitalize() }}
                  {% endif %}
                </span>
              </div>
              
              <h5 class="card-title mb-2 fw-bold text-truncate" title="{{ evento.nome }}">
                {{ evento.nome }}
              </h5>
              
              <!-- Datas em destaque -->
              <div class="d-flex align-items-center text-white-50">
                <i class="bi bi-calendar3 me-2"></i>
                <span class="small">
                  {{ evento.data_inicio.strftime('%d/%m/%Y') }} 
                  {% if evento.data_inicio != evento.data_fim %}
                    - {{ evento.data_fim.strftime('%d/%m/%Y') }}
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
          
          <div class="card-body p-4">
            <!-- Informa√ß√µes b√°sicas com √≠cones -->
            <div class="evento-info mb-4">
              <div class="info-item d-flex align-items-center mb-2">
                <div class="info-icon bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                  <i class="bi bi-geo-alt"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium text-dark">{{ evento.cidade }}/{{ evento.estado }}</div>
                  {% if evento.endereco %}
                    <div class="text-muted small">{{ evento.endereco }}</div>
                  {% endif %}
                </div>
              </div>
              
              <div class="info-item d-flex align-items-center mb-2">
                <div class="info-icon bg-success bg-opacity-10 text-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                  <i class="bi bi-building"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium text-dark">{{ evento.circo.nome if evento.circo else 'Circo n√£o definido' }}</div>
                  <div class="text-muted small">Circo respons√°vel</div>
                </div>
              </div>
              
              <div class="info-item d-flex align-items-center">
                <div class="info-icon bg-info bg-opacity-10 text-info rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                  <i class="bi bi-person-badge"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-medium text-dark">{{ evento.produtor.nome if evento.produtor else 'Produtor n√£o definido' }}</div>
                  <div class="text-muted small">Produtor respons√°vel</div>
                </div>
              </div>
            </div>
            
            <!-- A√ß√µes r√°pidas redesenhadas -->
            <div class="evento-actions mb-3">
              <div class="row g-2 mb-3">
                <!-- A√ß√µes principais (maiores) -->
                <div class="col-6">
                  <button type="button" class="btn btn-outline-danger w-100 btn-action" 
                          data-bs-toggle="modal" data-bs-target="#modalAdicionarDespesa{{ evento.id_evento }}">
                    <i class="bi bi-credit-card d-block mb-1"></i>
                    <span class="small fw-medium">Despesa</span>
                  </button>
                </div>
                <div class="col-6">
                  <button type="button" class="btn btn-outline-info w-100 btn-action" 
                          data-bs-toggle="modal" data-bs-target="#modalAdicionarReceita{{ evento.id_evento }}">
                    <i class="bi bi-cash-coin d-block mb-1"></i>
                    <span class="small fw-medium">Receita</span>
                  </button>
                </div>
              </div>
              
              <!-- A√ß√µes secund√°rias (menores) -->
              <div class="row g-1">
                <div class="col-4">
                  <a href="{{ url_for('equipe_evento', id_evento=evento.id_evento) }}" 
                     class="btn btn-outline-primary btn-sm w-100 btn-action-sm">
                    <i class="bi bi-people d-block mb-1" style="font-size: 0.9rem;"></i>
                    <span style="font-size: 0.7rem;">Equipe</span>
                  </a>
                </div>
                <div class="col-4">
                  <a href="{{ url_for('elenco_evento', id_evento=evento.id_evento) }}" 
                     class="btn btn-outline-warning btn-sm w-100 btn-action-sm">
                    <i class="bi bi-person-video d-block mb-1" style="font-size: 0.9rem;"></i>
                    <span style="font-size: 0.7rem;">Elenco</span>
                  </a>
                </div>
                <div class="col-4">
                  <a href="{{ url_for('fornecedor_evento', id_evento=evento.id_evento) }}" 
                     class="btn btn-outline-success btn-sm w-100 btn-action-sm">
                    <i class="bi bi-shop d-block mb-1" style="font-size: 0.9rem;"></i>
                    <span style="font-size: 0.7rem;">Fornecedores</span>
                  </a>
                </div>
              </div>
            </div>
            
            <!-- Footer com menu de a√ß√µes -->
            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
              <button class="btn btn-outline-primary btn-sm" 
                      data-bs-toggle="modal" data-bs-target="#modalDetalhes{{ evento.id_evento }}">
                <i class="bi bi-eye me-1"></i>Ver Detalhes
              </button>
              
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown" aria-expanded="false" id="dropdownMenuButton{{ evento.id_evento }}">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownMenuButton{{ evento.id_evento }}">
                  <li>
                    <a href="{{ url_for('editar_evento', id=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-pencil me-2 text-primary"></i>Editar Evento
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('relatorio_faturamento_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-bar-chart me-2 text-info"></i>Relat√≥rio Financeiro
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('relatorio_fechamento_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-clipboard-check me-2 text-warning"></i>Fechamento de Evento
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalAdicionarDespesa{{ evento.id_evento }}">
                      <i class="bi bi-credit-card me-2 text-danger"></i>Adicionar Despesa
                    </a>
                  </li>
                  <li>
                    <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#modalAdicionarReceita{{ evento.id_evento }}">
                      <i class="bi bi-cash-coin me-2 text-info"></i>Adicionar Receita
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a href="{{ url_for('equipe_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-people me-2 text-primary"></i>Gerenciar Equipe
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('elenco_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-person-video me-2 text-warning"></i>Gerenciar Elenco
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('fornecedor_evento', id_evento=evento.id_evento) }}" class="dropdown-item">
                      <i class="bi bi-shop me-2 text-success"></i>Gerenciar Fornecedores
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a href="#" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#modalExcluir{{ evento.id_evento }}">
                      <i class="bi bi-trash me-2"></i>Excluir Evento
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Adicionar Despesa -->
      <div class="modal fade" id="modalAdicionarDespesa{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-credit-card me-2"></i>Adicionar Despesa
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="adicionarDespesaRapida(event, '{{ evento.id_evento }}')">
              <div class="modal-body p-4">
                <div class="alert alert-light border-start border-danger border-4 mb-4">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle text-danger me-2"></i>
                    <div>
                      <strong>{{ evento.nome }}</strong>
                      <div class="text-muted small">{{ evento.cidade }}/{{ evento.estado }} ‚Ä¢ {{ evento.data_inicio.strftime('%d/%m/%Y') }}</div>
                    </div>
                  </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label fw-medium">Categoria da Despesa</label>
                    <select name="categoria_despesa" class="form-select" required 
                            onchange="carregarDespesasPorCategoria(this, '{{ evento.id_evento }}')">
                      <option value="">Selecione uma categoria...</option>
                      {% for categoria in categorias_despesa %}
                      <option value="{{ categoria.id_categoria_despesa }}">{{ categoria.nome }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Despesa</label>
                    <select name="despesa_id" class="form-select" required>
                      <option value="">Primeiro selecione a categoria...</option>
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Data</label>
                    <input type="date" name="data" class="form-control" required value="{{ current_date }}">
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Valor (R$)</label>
                    <input type="text" name="valor" class="form-control" required placeholder="0,00"
                           oninput="formatarMoeda(this)">
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Fornecedor</label>
                    <select name="fornecedor_id" class="form-select">
                      <option value="">Selecione um fornecedor...</option>
                      {% for fornecedor in fornecedores %}
                      <option value="{{ fornecedor.id_fornecedor }}">{{ fornecedor.nome }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Status</label>
                    <select name="status_pagamento" class="form-select" required>
                      <option value="pendente">Pendente</option>
                      <option value="pago">Pago</option>
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Forma de Pagamento</label>
                    <select name="forma_pagamento" class="form-select" required>
                      <option value="d√©bito">D√©bito</option>
                      <option value="cr√©dito">Cr√©dito</option>
                      <option value="esp√©cie">Esp√©cie</option>
                      <option value="pix">Pix</option>
                    </select>
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Pago por</label>
                    <input type="text" name="pago_por" class="form-control">
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Observa√ß√µes</label>
                    <textarea name="observacoes" class="form-control" rows="3"></textarea>
                  </div>
                  
                  <div class="col-12">
                    <div class="form-check">
                      <input type="checkbox" name="despesa_cabeca" class="form-check-input" id="despesa_cabeca_{{ evento.id_evento }}" value="1">
                      <label class="form-check-label fw-medium" for="despesa_cabeca_{{ evento.id_evento }}">
                        Despesa da cabe√ßa
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-danger">
                  <i class="bi bi-plus-circle me-2"></i>Adicionar Despesa
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal Adicionar Receita -->
      <div class="modal fade" id="modalAdicionarReceita{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-cash-coin me-2"></i>Adicionar Receita
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="adicionarReceitaRapida(event, '{{ evento.id_evento }}')">
              <div class="modal-body p-4">
                <div class="alert alert-light border-start border-info border-4 mb-4">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle text-info me-2"></i>
                    <div>
                      <strong>{{ evento.nome }}</strong>
                      <div class="text-muted small">{{ evento.cidade }}/{{ evento.estado }} ‚Ä¢ {{ evento.data_inicio.strftime('%d/%m/%Y') }}</div>
                    </div>
                  </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label fw-medium">Categoria da Receita</label>
                    <select name="categoria_receita" class="form-select" required 
                            onchange="carregarReceitasPorCategoria(this, '{{ evento.id_evento }}')">
                      <option value="">Selecione uma categoria...</option>
                      {% for categoria in categorias_receita %}
                      <option value="{{ categoria.id_categoria_receita }}">{{ categoria.nome }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Receita</label>
                    <select name="receita_id" class="form-select" required>
                      <option value="">Primeiro selecione a categoria...</option>
                    </select>
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Data</label>
                    <input type="date" name="data" class="form-control" required value="{{ current_date }}">
                  </div>
                  
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Valor (R$)</label>
                    <input type="text" name="valor" class="form-control" required placeholder="0,00"
                           oninput="formatarMoeda(this)">
                  </div>
                  
                  <div class="col-12">
                    <label class="form-label fw-medium">Observa√ß√µes</label>
                    <textarea name="observacoes" class="form-control" rows="3"></textarea>
                  </div>
                </div>
              </div>
              <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-info">
                  <i class="bi bi-plus-circle me-2"></i>Adicionar Receita
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal Detalhes aprimorado -->
      <div class="modal fade" id="modalDetalhes{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-gradient-primary text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-eye me-2"></i>Detalhes do Evento
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
              <!-- Header do evento -->
              <div class="text-center mb-4 p-4 bg-light rounded-3">
                <h4 class="text-primary fw-bold mb-2">{{ evento.nome }}</h4>
                <div class="d-flex justify-content-center align-items-center gap-3 text-muted">
                  <span><i class="bi bi-calendar3 me-1"></i>{{ evento.data_inicio.strftime('%d/%m/%Y') }} - {{ evento.data_fim.strftime('%d/%m/%Y') }}</span>
                  <span><i class="bi bi-geo-alt me-1"></i>{{ evento.cidade }}/{{ evento.estado }}</span>
                </div>
              </div>
              
              <div class="row g-4">
                <!-- Informa√ß√µes Gerais -->
                <div class="col-md-6">
                  <div class="card border-0 bg-light h-100">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-info-circle me-2"></i>Informa√ß√µes Gerais
                      </h6>
                      <div class="mb-2">
                        <strong>Status:</strong> 
                        <span class="badge 
                          {% if evento.status == 'a realizar' %}bg-warning text-dark
                          {% elif evento.status == 'em andamento' %}bg-info
                          {% elif evento.status == 'realizado' %}bg-success
                          {% else %}bg-secondary{% endif %} ms-1">
                          {{ evento.status.capitalize() }}
                        </span>
                      </div>
                      <div class="mb-2">
                        <strong>Data In√≠cio:</strong> {{ evento.data_inicio.strftime('%d/%m/%Y') }}
                      </div>
                      <div class="mb-2">
                        <strong>Data Fim:</strong> {{ evento.data_fim.strftime('%d/%m/%Y') }}
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Localiza√ß√£o -->
                <div class="col-md-6">
                  <div class="card border-0 bg-light h-100">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-geo-alt me-2"></i>Localiza√ß√£o
                      </h6>
                      <div class="mb-2">
                        <strong>Cidade:</strong> {{ evento.cidade or '‚Äî' }}
                      </div>
                      <div class="mb-2">
                        <strong>Estado:</strong> {{ evento.estado or '‚Äî' }}
                      </div>
                      <div class="mb-2">
                        <strong>Endere√ßo:</strong> {{ evento.endereco or '‚Äî' }}
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Respons√°veis -->
                <div class="col-12">
                  <div class="card border-0 bg-light">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-people me-2"></i>Respons√°veis
                      </h6>
                      <div class="row">
                        <div class="col-md-6 mb-2">
                          <strong>Circo:</strong> {{ evento.circo.nome if evento.circo else '‚Äî' }}
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>Produtor:</strong> {{ evento.produtor.nome if evento.produtor else '‚Äî' }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                {% if evento.observacoes %}
                <div class="col-12">
                  <div class="card border-0 bg-light">
                    <div class="card-body">
                      <h6 class="text-primary fw-bold mb-3">
                        <i class="bi bi-chat-left-text me-2"></i>Observa√ß√µes
                      </h6>
                      <p class="mb-0">{{ evento.observacoes }}</p>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            <div class="modal-footer border-0 bg-light">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-2"></i>Fechar
              </button>
              <a href="{{ url_for('editar_evento', id=evento.id_evento) }}" class="btn btn-primary">
                <i class="bi bi-pencil me-2"></i>Editar Evento
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Excluir -->
      <div class="modal fade" id="modalExcluir{{ evento.id_evento }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-0">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Exclus√£o
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
              <div class="text-center">
                <div class="mb-3">
                  <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                </div>
                <h5 class="mb-3">Tem certeza que deseja excluir este evento?</h5>
                <div class="alert alert-warning">
                  <strong>{{ evento.nome }}</strong><br>
                  <small class="text-muted">{{ evento.cidade }}/{{ evento.estado }} ‚Ä¢ {{ evento.data_inicio.strftime('%d/%m/%Y') }}</small>
                </div>
                <p class="text-muted">Esta a√ß√£o n√£o pode ser desfeita. Todos os dados relacionados ao evento ser√£o perdidos permanentemente.</p>
              </div>
            </div>
            <div class="modal-footer border-0 bg-light">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-2"></i>Cancelar
              </button>
              <a href="{{ url_for('excluir_evento', id=evento.id_evento) }}" class="btn btn-danger">
                <i class="bi bi-trash me-2"></i>Sim, Excluir
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <!-- Estado vazio aprimorado -->
  <div class="text-center py-5">
    <div class="mb-4">
      <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
    </div>
    <h4 class="text-muted mb-3">Nenhum evento encontrado</h4>
    <p class="text-muted mb-4">
      {% if period == 'custom' %}
        N√£o h√° eventos no per√≠odo selecionado.
      {% else %}
        N√£o h√° eventos para o filtro "{{ period }}" selecionado.
      {% endif %}
    </p>
    <div class="d-flex justify-content-center gap-2">
      <a href="{{ url_for('novo_evento') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Criar Primeiro Evento
      </a>
      <a href="?period=90dias" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-clockwise me-2"></i>Ver √öltimos 90 Dias
      </a>
    </div>
  </div>
{% endif %}

<!-- Estilos espec√≠ficos da p√°gina -->
<style>
/* Gradientes para headers dos cards */
.bg-warning-gradient {
  background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
}
.bg-info-gradient {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}
.bg-success-gradient {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}
.bg-secondary-gradient {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}

/* Anima√ß√µes e transi√ß√µes */
.evento-card {
  transition: all 0.3s ease;
  border-radius: 16px !important;
  overflow: hidden;
}

.evento-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
}

.evento-header {
  position: relative;
  overflow: hidden;
}

.evento-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
  pointer-events: none;
}

/* Bot√µes de a√ß√£o */
.btn-action {
  padding: 12px 8px;
  border-radius: 12px;
  transition: all 0.2s ease;
  border-width: 2px;
}

.btn-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-action-sm {
  padding: 8px 4px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.btn-action-sm:hover {
  transform: translateY(-1px);
}

/* Info items */
.info-item {
  transition: all 0.2s ease;
}

.info-item:hover {
  transform: translateX(4px);
}

.info-icon {
  transition: all 0.2s ease;
}

.info-item:hover .info-icon {
  transform: scale(1.1);
}

/* Modais */
.modal-content {
  border-radius: 16px;
  overflow: hidden;
}

.modal-header {
  padding: 24px;
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  padding: 20px 24px;
}

/* Filtros */
.btn-outline-primary.active {
  background-color: var(--bs-primary);
  border-color: var(--bs-primary);
  color: white;
}

/* Responsividade aprimorada */
@media (max-width: 768px) {
  .evento-card {
    margin-bottom: 1rem;
  }
  
  .btn-action {
    padding: 10px 6px;
    font-size: 0.85rem;
  }
  
  .btn-action-sm {
    padding: 6px 3px;
    font-size: 0.7rem;
  }
  
  .info-icon {
    width: 28px !important;
    height: 28px !important;
  }
  
  .modal-dialog {
    margin: 0.5rem;
  }
}

/* Loading states */
.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Anima√ß√µes de entrada */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fadeInUp 0.6s ease forwards;
}

/* Badges personalizados */
.badge {
  border-radius: 20px;
  padding: 6px 12px;
  font-weight: 500;
}

/* Dropdowns */
.dropdown-menu {
  border-radius: 12px;
  border: none;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  padding: 8px 0;
}

.dropdown-item {
  padding: 10px 20px;
  transition: all 0.2s ease;
}

.dropdown-item:hover {
  background-color: #f8fafc;
  transform: translateX(4px);
}

.dropdown-divider {
  margin: 8px 0;
}
</style>

<script>
// Fun√ß√£o para formatar valor como moeda
function formatarMoeda(input) {
    // Remove tudo que n√£o √© d√≠gito
    let valor = input.value.replace(/\D/g, '');
    
    // Se n√£o tem valor, limpa o campo
    if (!valor) {
        input.value = '';
        return;
    }
    
    // Converte para n√∫mero e formata
    valor = parseInt(valor);
    
    // Formatar como moeda brasileira
    let valorFormatado = (valor / 100).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    input.value = valorFormatado;
}

// Fun√ß√£o para converter valor formatado para n√∫mero
function converterMoedaParaNumero(valorFormatado) {
    if (!valorFormatado) return 0;
    
    // Remove pontos de milhares e substitui v√≠rgula por ponto
    return parseFloat(valorFormatado.replace(/\./g, '').replace(',', '.'));
}

// Fun√ß√£o para carregar despesas por categoria
function carregarDespesasPorCategoria(selectCategoria, eventoId) {
    const categoriaId = selectCategoria.value;
    const selectDespesa = selectCategoria.closest('form').querySelector('[name="despesa_id"]');
    
    console.log('üîç Carregando despesas para categoria:', categoriaId);
    
    // Limpar op√ß√µes
    selectDespesa.innerHTML = '<option value="">Carregando...</option>';
    
    if (!categoriaId) {
        selectDespesa.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
        return;
    }
    
    // Fazer requisi√ß√£o para buscar despesas da categoria
    fetch(`/api/despesas-por-categoria/${categoriaId}`)
        .then(response => {
            console.log('üì° Resposta da API:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìã Despesas recebidas:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            selectDespesa.innerHTML = '<option value="">Selecione uma despesa...</option>';
            
            if (data.length === 0) {
                selectDespesa.innerHTML = '<option value="">Nenhuma despesa encontrada para esta categoria</option>';
                return;
            }
            
            data.forEach(despesa => {
                const option = document.createElement('option');
                option.value = despesa.id_despesa;
                option.textContent = despesa.nome;
                if (despesa.valor_medio) {
                    option.setAttribute('data-valor-medio', despesa.valor_medio.toFixed(2).replace('.', ','));
                }
                selectDespesa.appendChild(option);
            });
            
            // Remover listeners existentes e adicionar novo
            selectDespesa.removeEventListener('change', preencherValorMedio);
            selectDespesa.addEventListener('change', preencherValorMedio);
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar despesas:', error);
            selectDespesa.innerHTML = '<option value="">Erro ao carregar despesas</option>';
            mostrarNotificacao(`‚ùå Erro ao carregar despesas: ${error.message}`, 'danger');
        });
}

// Fun√ß√£o separada para preencher valor m√©dio
function preencherValorMedio() {
    const selectedOption = this.selectedOptions[0];
    const valorMedio = selectedOption.getAttribute('data-valor-medio');
    const inputValor = this.closest('form').querySelector('[name="valor"]');
    
    // N√£o preencher automaticamente - deixar o campo limpo para o usu√°rio inserir
    // if (valorMedio && inputValor && !inputValor.value) {
    //     inputValor.value = valorMedio;
    // }
    
    // Apenas limpar o campo quando trocar de despesa
    if (inputValor) {
        inputValor.value = '';
        inputValor.placeholder = valorMedio ? `Sugest√£o: R$ ${valorMedio}` : '0,00';
    }
}

// Fun√ß√£o para carregar receitas por categoria
function carregarReceitasPorCategoria(selectCategoria, eventoId) {
    const categoriaId = selectCategoria.value;
    const selectReceita = selectCategoria.closest('form').querySelector('[name="receita_id"]');
    
    // Limpar op√ß√µes
    selectReceita.innerHTML = '<option value="">Carregando...</option>';
    
    if (!categoriaId) {
        selectReceita.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
        return;
    }
    
    // Fazer requisi√ß√£o para buscar receitas da categoria
    fetch(`/api/receitas-por-categoria/${categoriaId}`)
        .then(response => response.json())
        .then(data => {
            selectReceita.innerHTML = '<option value="">Selecione uma receita...</option>';
            
            data.forEach(receita => {
                const option = document.createElement('option');
                option.value = receita.id_receita;
                option.textContent = receita.nome;
                selectReceita.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar receitas:', error);
            selectReceita.innerHTML = '<option value="">Erro ao carregar receitas</option>';
        });
}

// Fun√ß√£o para adicionar despesa r√°pida
function adicionarDespesaRapida(event, eventoId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Converter eventoId para n√∫mero se for string
    const eventoIdNum = parseInt(eventoId);
    
    // Converter valor formatado para n√∫mero
    const valorFormatado = formData.get('valor');
    const valorNumerico = converterMoedaParaNumero(valorFormatado);
    
    // Criar objeto JSON com os dados
    const dados = {
        despesa_id: parseInt(formData.get('despesa_id')),
        data: formData.get('data'),
        valor: valorNumerico.toString(),
        id_fornecedor: formData.get('id_fornecedor') || null,
        status_pagamento: formData.get('status_pagamento') || 'pendente',
        forma_pagamento: formData.get('forma_pagamento') || 'd√©bito',
        pago_por: formData.get('pago_por') || '',
        observacoes: formData.get('observacoes') || '',
        despesa_cabeca: formData.get('despesa_cabeca') === '1',
        is_fixa: false  // Despesas do popup s√£o sempre vari√°veis
    };
    
    // Desabilitar bot√£o durante envio
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>Adicionando...';
    
    // Enviar dados como JSON
    fetch(`/eventos/${eventoIdNum}/salvar-despesa`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Mostrar sucesso
            mostrarNotificacao('‚úÖ Despesa adicionada com sucesso!', 'success');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();
            
            // Limpar formul√°rio
            form.reset();
            
            // Resetar dropdowns
            const selectDespesa = form.querySelector('[name="despesa_id"]');
            selectDespesa.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
        } else {
            mostrarNotificacao('‚ùå Erro: ' + result.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarNotificacao('‚ùå Erro ao adicionar despesa: ' + error.message, 'danger');
    })
    .finally(() => {
        // Reabilitar bot√£o
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Fun√ß√£o para adicionar receita r√°pida
function adicionarReceitaRapida(event, eventoId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Converter eventoId para n√∫mero se for string
    const eventoIdNum = parseInt(eventoId);
    
    // Converter valor formatado para n√∫mero
    const valorFormatado = formData.get('valor');
    const valorNumerico = converterMoedaParaNumero(valorFormatado);
    
    // Criar objeto JSON com os dados
    const dados = {
        receita_id: parseInt(formData.get('receita_id')),
        data: formData.get('data'),
        valor: valorNumerico.toString(),
        observacoes: formData.get('observacoes') || ''
    };
    
    // Desabilitar bot√£o durante envio
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>Adicionando...';
    
    // Enviar dados como JSON
    fetch(`/eventos/${eventoIdNum}/salvar-receita`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Mostrar sucesso
            mostrarNotificacao('‚úÖ Receita adicionada com sucesso!', 'success');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();
            
            // Limpar formul√°rio
            form.reset();
            
            // Resetar dropdowns
            const selectReceita = form.querySelector('[name="receita_id"]');
            selectReceita.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
        } else {
            mostrarNotificacao('‚ùå Erro: ' + result.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarNotificacao('‚ùå Erro ao adicionar receita: ' + error.message, 'danger');
    })
    .finally(() => {
        // Reabilitar bot√£o
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Fun√ß√£o para mostrar notifica√ß√µes
function mostrarNotificacao(mensagem, tipo) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    alertDiv.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Remover ap√≥s 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Fun√ß√£o simples para garantir que os dropdowns funcionem
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Inicializando dropdowns...');
    
    // Aguardar carregamento completo
    setTimeout(function() {
        // For√ßar inicializa√ß√£o de todos os dropdowns
        const dropdownElements = document.querySelectorAll('[data-bs-toggle="dropdown"]');
        console.log('üìã Dropdowns encontrados:', dropdownElements.length);
        
        dropdownElements.forEach(function(element, index) {
            try {
                // Verificar se o Bootstrap est√° dispon√≠vel
                if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
                    // Destruir inst√¢ncia existente
                    const existingInstance = bootstrap.Dropdown.getInstance(element);
                    if (existingInstance) {
                        existingInstance.dispose();
                    }
                    
                    // Criar nova inst√¢ncia
                    const dropdown = new bootstrap.Dropdown(element);
                    console.log(`‚úÖ Dropdown ${index + 1} inicializado`);
                    
                    // Adicionar eventos para debug
                    element.addEventListener('show.bs.dropdown', function() {
                        console.log('üîì Dropdown abrindo:', element.id);
                    });
                    
                    element.addEventListener('hide.bs.dropdown', function() {
                        console.log('üîí Dropdown fechando:', element.id);
                    });
                    
                } else {
                    console.error('‚ùå Bootstrap n√£o dispon√≠vel');
                }
            } catch (error) {
                console.error(`‚ùå Erro no dropdown ${index + 1}:`, error);
            }
        });
        
        // Teste adicional: verificar se podemos abrir manualmente
        dropdownElements.forEach(function(element) {
            element.addEventListener('click', function(e) {
                console.log('üñ±Ô∏è Clique detectado no dropdown:', element.id);
                
                // Fallback manual se necess√°rio
                const dropdown = bootstrap.Dropdown.getInstance(element);
                if (!dropdown) {
                    console.log('‚ö†Ô∏è Criando inst√¢ncia no clique');
                    try {
                        new bootstrap.Dropdown(element);
                    } catch (error) {
                        console.error('‚ùå Erro ao criar inst√¢ncia:', error);
                    }
                }
            });
        });
        
    }, 200);
});

// Debug: monitorar mudan√ßas no DOM
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target;
            if (target.classList.contains('dropdown-menu')) {
                console.log('üìã Mudan√ßa no menu dropdown:', target.classList.contains('show') ? 'ABERTO' : 'FECHADO');
            }
        }
    });
});

// Observar todos os menus dropdown
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const menus = document.querySelectorAll('.dropdown-menu');
        menus.forEach(function(menu) {
            observer.observe(menu, { attributes: true });
        });
    }, 300);
    
    // Limpar formul√°rios quando modais forem abertos
    const modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
        modal.addEventListener('show.bs.modal', function() {
            const form = modal.querySelector('form');
            if (form) {
                // Resetar formul√°rio
                form.reset();
                
                // Resetar dropdowns para estado inicial
                const selectDespesa = form.querySelector('[name="despesa_id"]');
                const selectReceita = form.querySelector('[name="receita_id"]');
                
                if (selectDespesa) {
                    selectDespesa.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
                }
                
                if (selectReceita) {
                    selectReceita.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
                }
                
                // Limpar placeholder do valor
                const inputValor = form.querySelector('[name="valor"]');
                if (inputValor) {
                    inputValor.placeholder = '0,00';
                }
            }
        });
    });
});
</script>

{% endblock %}
