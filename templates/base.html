<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sócrates Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Fonte moderna Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS Modernizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style-modern.css') }}">
</head>
<body>
    <!-- Navbar Mobile -->
    <nav class="navbar-mobile d-md-none">
        <div class="container-fluid">
            <button id="toggle-sidebar" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-list fs-5"></i>
            </button>
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <img src="{{ url_for('static', filename='logo.png') }}" height="30" alt="Logo">
            </a>
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle fs-5"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Overlay para sidebar mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="layout">
        <div class="sidebar" id="sidebar">
            <a href="{{ url_for('dashboard') }}" class="d-block text-center mb-4">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="img-fluid">
            </a>

            {% set categoria = session['categoria'] %}
            
            {# TEMPORÁRIO: Ocultar menu para usuários não-root - REMOVER FUTURAMENTE #}
            {# Função is_root_user() agora está disponível globalmente via context_processor #}
            
            {# Dashboard - oculto temporariamente para não-root #}
            {% if is_root_user() %}
            <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            {% endif %}
            
            {# Eventos - oculto temporariamente para não-root #}
            {% if is_root_user() %}
            <a class="nav-link {% if request.endpoint == 'listar_eventos' %}active{% endif %}" href="{{ url_for('listar_eventos') }}">
                <i class="bi bi-calendar-event"></i> Eventos
            </a>
            {% endif %}

            {# Cadastros - liberado parcialmente para administrativos, completo para root #}
            {% if categoria == 'administrativo' or is_root_user() %}
            <div class="w-100">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#submenuCadastros" role="button" aria-expanded="false" aria-controls="submenuCadastros">
                    <span><i class="bi bi-pencil-square"></i> Cadastros</span>
                    <i class="bi bi-chevron-down small"></i>
                </a>
                <div class="collapse ps-3" id="submenuCadastros">
                    {# Colaboradores e Categorias - liberado para todos administrativos #}
                    <a class="nav-link {% if request.endpoint == 'cadastrar_colaborador' %}active{% endif %}" href="{{ url_for('cadastrar_colaborador') }}">
                        <i class="bi bi-people"></i> Colaboradores
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_categoria_colaborador' %}active{% endif %}" href="{{ url_for('cadastrar_categoria_colaborador') }}">
                        <i class="bi bi-tags"></i> Categorias Colaboradores
                    </a>
                    
                    {# Demais cadastros - apenas para root temporariamente #}
                    {% if is_root_user() %}
                    <a class="nav-link {% if request.endpoint == 'cadastrar_circo' %}active{% endif %}" href="{{ url_for('cadastrar_circo') }}">
                        <i class="bi bi-building"></i> Circos
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_elenco' %}active{% endif %}" href="{{ url_for('cadastrar_elenco') }}">
                        <i class="bi bi-person-badge"></i> Elencos
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_veiculo' %}active{% endif %}" href="{{ url_for('cadastrar_veiculo') }}">
                        <i class="bi bi-truck"></i> Veículos
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_categoria_veiculo' %}active{% endif %}" href="{{ url_for('cadastrar_categoria_veiculo') }}">
                        <i class="bi bi-tags"></i> Categorias Veículo
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_fornecedor' %}active{% endif %}" href="{{ url_for('cadastrar_fornecedor') }}">
                        <i class="bi bi-shop"></i> Fornecedores
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_categoria_fornecedor' %}active{% endif %}" href="{{ url_for('cadastrar_categoria_fornecedor') }}">
                        <i class="bi bi-tags"></i> Categorias Fornecedor
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_receita' %}active{% endif %}" href="{{ url_for('cadastrar_receita') }}">
                        <i class="bi bi-cash-coin"></i> Receitas
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_categoria_receita' %}active{% endif %}" href="{{ url_for('cadastrar_categoria_receita') }}">
                        <i class="bi bi-tags"></i> Categorias Receita
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_despesa' %}active{% endif %}" href="{{ url_for('cadastrar_despesa') }}">
                        <i class="bi bi-credit-card"></i> Despesas 
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_categoria_despesa' %}active{% endif %}" href="{{ url_for('cadastrar_categoria_despesa') }}">
                        <i class="bi bi-tags"></i> Categorias Despesa
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_parametro' %}active{% endif %}" href="{{ url_for('cadastrar_parametro') }}">
                        <i class="bi bi-gear"></i> Parâmetros
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Gestão Financeira Empresa - oculto temporariamente para não-root #}
            {% if is_root_user() %}
            <div class="w-100">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#submenuGestaoFinanceira" role="button" aria-expanded="false" aria-controls="submenuGestaoFinanceira">
                    <span><i class="bi bi-bank"></i> Gestão Financeira Empresa</span>
                    <i class="bi bi-chevron-down small"></i>
                </a>
                <div class="collapse ps-3" id="submenuGestaoFinanceira">
                    <a class="nav-link {% if request.endpoint == 'despesas_empresa' %}active{% endif %}" href="{{ url_for('despesas_empresa') }}">
                        <i class="bi bi-credit-card-2-back"></i> Informar Despesa da Empresa
                    </a>
                    <a class="nav-link {% if request.endpoint == 'receitas_empresa' %}active{% endif %}" href="{{ url_for('receitas_empresa') }}">
                        <i class="bi bi-cash-coin"></i> Informar Receita da Empresa
                    </a>
                    <a class="nav-link {% if request.endpoint == 'financeiro_mes' %}active{% endif %}" href="{{ url_for('financeiro_mes') }}">
                        <i class="bi bi-calendar-plus"></i> Financeiro Mês
                    </a>
                </div>
            </div>
            {% endif %}

            {# Relatórios - oculto temporariamente para não-root #}
            {% if is_root_user() %}
            <div class="w-100">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#submenuRelatorios" role="button" aria-expanded="false" aria-controls="submenuRelatorios">
                    <span><i class="bi bi-bar-chart"></i> Relatórios</span>
                    <i class="bi bi-chevron-down small"></i>
                </a>
                <div class="collapse ps-3" id="submenuRelatorios">
                    <a class="nav-link {% if request.endpoint == 'relatorios_lucratividade_mensal' %}active{% endif %}" href="{{ url_for('relatorios_lucratividade_mensal') }}">
                        <i class="bi bi-calendar-month"></i> Lucratividade Mensal
                    </a>
                    <a class="nav-link {% if request.endpoint == 'relatorios_faturamento_evento' %}active{% endif %}" href="{{ url_for('relatorios_faturamento_evento') }}">
                        <i class="bi bi-calendar-check"></i> Faturamento por Evento
                    </a>
                    <a class="nav-link {% if request.endpoint == 'relatorios_fechamento_evento' %}active{% endif %}" href="{{ url_for('relatorios_fechamento_evento') }}">
                        <i class="bi bi-clipboard-check"></i> Fechamento por Evento
                    </a>
                    <a class="nav-link {% if request.endpoint == 'relatorio_despesas_fixas' %}active{% endif %}" href="{{ url_for('relatorio_despesas_fixas') }}">
                        <i class="bi bi-receipt"></i> Despesas Fixas
                    </a>
                    <a class="nav-link {% if request.endpoint == 'relatorio_veiculos' %}active{% endif %}" href="{{ url_for('relatorio_veiculos') }}">
                        <i class="bi bi-car-front"></i> Veículos e Eventos
                    </a>
                    <a class="nav-link {% if request.endpoint == 'relatorio_custo_frota' %}active{% endif %}" href="{{ url_for('relatorio_custo_frota') }}">
                        <i class="bi bi-fuel-pump"></i> Custo da Frota
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Menu Marketing para Promotores de Vendas, Administradores e Root -->
            
            {% if is_admin_user() or is_promotor_user() or is_root_user() %}
                {% set show_marketing = true %}
            {% endif %}
            
            {% if show_marketing %}
            <div class="w-100">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#submenuMarketing" role="button" aria-expanded="false" aria-controls="submenuMarketing">
                    <span><i class="fas fa-bullhorn"></i> Marketing</span>
                    <i class="bi bi-chevron-down small"></i>
                </a>
                <div class="collapse ps-3" id="submenuMarketing">
                    <a class="nav-link {% if request.endpoint == 'marketing_dashboard' %}active{% endif %}" href="{{ url_for('marketing_dashboard') }}">
                        <i class="fas fa-chart-line"></i> Dashboard Escolas
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_escola' %}active{% endif %}" href="{{ url_for('cadastrar_escola') }}">
                        <i class="bi bi-building"></i> Gerenciar Escolas
                    </a>
                    <a class="nav-link {% if request.endpoint == 'cadastrar_visita_escola' %}active{% endif %}" href="{{ url_for('cadastrar_visita_escola') }}">
                        <i class="bi bi-calendar-event"></i> Visitas às Escolas
                    </a>
                </div>
            </div>
            {% endif %}

            {% if session['categoria'] == 'administrativo' or is_root_user %}
            <div class="w-100">
                <a class="nav-link d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#submenuAdministrativo" role="button" aria-expanded="false" aria-controls="submenuAdministrativo">
                    <span><i class="bi bi-gear"></i> Administrativo</span>
                    <i class="bi bi-chevron-down small"></i>
                </a>
                <div class="collapse ps-3" id="submenuAdministrativo">
                    <a class="nav-link {% if request.endpoint == 'listar_logs' %}active{% endif %}" href="{{ url_for('listar_logs') }}">
                        <i class="bi bi-file-text"></i> Logs do Sistema
                    </a>
                </div>
            </div>
            {% endif %}

            <div class="mt-auto pt-4">
                <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> Sair</a>
            </div>
        </div>

        <div class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {% block breadcrumbs %}{% endblock %}
            
            {% block content %}{% endblock %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/table-sort.js') }}"></script>
    <script src="{{ url_for('static', filename='js/masks.js') }}"></script>
    <script src="{{ url_for('static', filename='js/responsive-tables.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-forms.js') }}"></script>
    <script>
        // Sistema de navegação mobile melhorado
        document.addEventListener('DOMContentLoaded', function() {
            const toggleSidebar = document.getElementById('toggle-sidebar');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const mainContent = document.querySelector('.main-content');
            let touchStartX = 0;
            let touchEndX = 0;
            let isScrolling = false;
            
            // Detectar se é dispositivo móvel
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.body.classList.add('mobile-device');
            }
            
            // Toggle sidebar com animação melhorada
            if (toggleSidebar) {
                toggleSidebar.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleSidebarState();
                    
                    // Adicionar feedback tátil
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                });
            }
            
            function toggleSidebarState() {
                const isOpen = sidebar.classList.contains('show');
                
                if (isOpen) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            }
            
            function openSidebar() {
                sidebar.classList.add('show');
                sidebarOverlay.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Focar no primeiro link para acessibilidade
                const firstLink = sidebar.querySelector('.nav-link');
                if (firstLink) {
                    setTimeout(() => firstLink.focus(), 300);
                }
            }
            
            function closeSidebar() {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
                document.body.style.overflow = '';
                
                // Retornar foco para o botão de toggle
                if (toggleSidebar) {
                    toggleSidebar.focus();
                }
            }
            
            // Fechar sidebar ao clicar no overlay
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    closeSidebar();
                });
            }
            
            // Fechar sidebar ao clicar em um link (mobile)
            const navLinks = sidebar.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768 && !this.hasAttribute('data-bs-toggle')) {
                        setTimeout(() => closeSidebar(), 150);
                    }
                });
            });
            
            // Gestos de swipe para abrir/fechar sidebar
            if ('ontouchstart' in window) {
                // Swipe para abrir (da borda esquerda)
                document.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                    isScrolling = false;
                }, { passive: true });
                
                document.addEventListener('touchmove', function(e) {
                    if (Math.abs(e.changedTouches[0].screenY - e.changedTouches[0].screenY) > 10) {
                        isScrolling = true;
                    }
                }, { passive: true });
                
                document.addEventListener('touchend', function(e) {
                    if (isScrolling) return;
                    
                    touchEndX = e.changedTouches[0].screenX;
                    const swipeDistance = touchEndX - touchStartX;
                    const isFromLeftEdge = touchStartX < 30;
                    const isSwipeRight = swipeDistance > 100;
                    const isSwipeLeft = swipeDistance < -100;
                    
                    // Abrir sidebar com swipe da borda esquerda
                    if (isFromLeftEdge && isSwipeRight && !sidebar.classList.contains('show')) {
                        openSidebar();
                    }
                    
                    // Fechar sidebar com swipe para esquerda
                    if (isSwipeLeft && sidebar.classList.contains('show')) {
                        closeSidebar();
                    }
                }, { passive: true });
            }
            
            // Ajustar ao redimensionar com debounce
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    if (window.innerWidth > 768) {
                        closeSidebar();
                    }
                }, 250);
            });
            
            // Melhorar acessibilidade com teclado
            document.addEventListener('keydown', function(e) {
                // Fechar sidebar com ESC
                if (e.key === 'Escape' && sidebar.classList.contains('show')) {
                    closeSidebar();
                }
                
                // Navegar no sidebar com setas
                if (sidebar.classList.contains('show') && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                    e.preventDefault();
                    const focusedElement = document.activeElement;
                    const navLinks = Array.from(sidebar.querySelectorAll('.nav-link'));
                    const currentIndex = navLinks.indexOf(focusedElement);
                    
                    if (currentIndex !== -1) {
                        const nextIndex = e.key === 'ArrowDown' 
                            ? (currentIndex + 1) % navLinks.length
                            : (currentIndex - 1 + navLinks.length) % navLinks.length;
                        navLinks[nextIndex].focus();
                    }
                }
            });
            
            // Melhorar performance com intersection observer
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('fade-in');
                        }
                    });
                }, { threshold: 0.1 });
                
                // Observar cards e elementos animáveis
                setTimeout(() => {
                    document.querySelectorAll('.card, .dashboard-card').forEach(el => {
                        observer.observe(el);
                    });
                }, 100);
            }
            
            // Adicionar indicador de carregamento para navegação
            const links = document.querySelectorAll('a[href]:not([href^="#"]):not([href^="javascript:"]):not([target="_blank"])');
            links.forEach(link => {
                link.addEventListener('click', function() {
                    if (this.hostname === window.location.hostname) {
                        // Adicionar classe de carregamento
                        document.body.classList.add('page-loading');
                        
                        // Remover após timeout para prevenir travamento
                        setTimeout(() => {
                            document.body.classList.remove('page-loading');
                        }, 3000);
                    }
                });
            });
        });
        
        // Adicionar estilos para indicador de carregamento
        const style = document.createElement('style');
        style.textContent = `
            .page-loading::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, transparent, var(--accent), transparent);
                background-size: 200% 100%;
                animation: loadingBar 1s linear infinite;
                z-index: 9999;
            }
            
            @keyframes loadingBar {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
    <!-- Script para funcionalidade de valor médio das despesas -->
    <script src="{{ url_for('static', filename='js/valor-medio-despesas.js') }}"></script>
    <!-- Script para modal unificado de despesas -->
    <script src="{{ url_for('static', filename='js/despesa-modal.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
