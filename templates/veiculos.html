{% extends 'base.html' %}
{% block content %}

{% if not form.id_categoria_veiculo.choices or form.id_categoria_veiculo.choices|length == 0 %}
<div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <div>
        <strong>Aten√ß√£o!</strong> √â necess√°rio cadastrar pelo menos uma categoria de ve√≠culo antes de poder cadastrar ve√≠culos.
        <a href="{{ url_for('cadastrar_categoria_veiculo') }}" class="btn btn-sm btn-outline-warning ms-2">
            <i class="bi bi-plus me-1"></i>Cadastrar Categoria
        </a>
    </div>
</div>
{% else %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Cadastro de Ve√≠culo</h5>
    </div>
    <div class="card-body">
        <form method="POST" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.nome.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.nome(class="form-control", placeholder="Nome/Identifica√ß√£o do ve√≠culo", required=true) }}
                        <span class="input-group-text"><i class="bi bi-truck"></i></span>
                        <div class="invalid-feedback">
                            Por favor, informe o nome do ve√≠culo.
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.id_categoria_veiculo.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.id_categoria_veiculo(class="form-select", required=true) }}
                        <span class="input-group-text"><i class="bi bi-tag"></i></span>
                        <div class="invalid-feedback">
                            Por favor, selecione uma categoria.
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    {{ form.marca.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.marca(class="form-control", placeholder="Marca do ve√≠culo") }}
                        <span class="input-group-text"><i class="bi bi-building"></i></span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.modelo.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.modelo(class="form-control", placeholder="Modelo do ve√≠culo") }}
                        <span class="input-group-text"><i class="bi bi-car-front"></i></span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.ano.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.ano(class="form-control", placeholder="Ano do ve√≠culo") }}
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    {{ form.placa.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.placa(class="form-control", placeholder="Placa do ve√≠culo") }}
                        <span class="input-group-text"><i class="bi bi-credit-card-2-front"></i></span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.cor.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.cor(class="form-control", placeholder="Cor do ve√≠culo") }}
                        <span class="input-group-text"><i class="bi bi-palette"></i></span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.combustivel.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.combustivel(class="form-select") }}
                        <span class="input-group-text"><i class="bi bi-fuel-pump"></i></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    {{ form.capacidade_passageiros.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.capacidade_passageiros(class="form-control", placeholder="N√∫mero de passageiros") }}
                        <span class="input-group-text"><i class="bi bi-people"></i></span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.media_km_litro.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.media_km_litro(class="form-control", placeholder="Ex: 8,5") }}
                        <span class="input-group-text">km/L</span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.observacoes.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.observacoes(class="form-control", placeholder="Observa√ß√µes", rows=3) }}
                        <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Ve√≠culos</h5>
        <div>
            <button class="btn btn-sm btn-outline-primary" id="btnExportar">
                <i class="bi bi-download me-1"></i>Exportar
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if veiculos %}
        <!-- Campo de Busca -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar ve√≠culos..." onkeyup="searchTable()">
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover table-striped sortable-table" id="veiculosTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Marca/Modelo</th>
                        <th>Ano</th>
                        <th>Placa</th>
                        <th>Categoria</th>
                        <th>M√©dia km/L</th>
                        <th class="text-center no-sort" style="width: 150px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in veiculos %}
                    <tr>
                        <td>{{ v.nome }}</td>
                        <td>{{ v.marca or '‚Äî' }}{% if v.marca and v.modelo %}/{% endif %}{{ v.modelo or '‚Äî' }}</td>
                        <td>{{ v.ano or '‚Äî' }}</td>
                        <td>{{ v.placa or '‚Äî' }}</td>
                        <td>{{ v.categoria.nome if v.categoria else '‚Äî' }}</td>
                        <td>{{ "{:.1f}".format(v.media_km_litro) if v.media_km_litro else '‚Äî' }}</td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('editar_veiculo', id=v.id_veiculo) }}" class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                
                                <!-- Dropdown para servi√ßos -->
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Servi√ßos">
                                        <i class="bi bi-tools"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <button class="dropdown-item" onclick="abrirModalServicos('multas', {{ v.id_veiculo }}, '{{ v.nome }}')">
                                                <i class="bi bi-exclamation-triangle text-warning me-2"></i>Multas
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" onclick="abrirModalServicos('ipva', {{ v.id_veiculo }}, '{{ v.nome }}')">
                                                <i class="bi bi-receipt text-primary me-2"></i>IPVA
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" onclick="abrirModalServicos('licenciamento', {{ v.id_veiculo }}, '{{ v.nome }}')">
                                                <i class="bi bi-card-checklist text-success me-2"></i>Licenciamento
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" onclick="abrirModalServicos('manutencao', {{ v.id_veiculo }}, '{{ v.nome }}')">
                                                <i class="bi bi-gear text-info me-2"></i>Manuten√ß√£o
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                
                                <a href="{{ url_for('excluir_veiculo', id=v.id_veiculo) }}" class="btn btn-sm btn-outline-danger" 
                                   onclick="return confirm('Tem certeza que deseja excluir este ve√≠culo?')" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>Nenhum ve√≠culo cadastrado.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Script de filtros avan√ßados -->
<script src="{{ url_for('static', filename='js/advanced-filters.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar sistema de filtros avan√ßados
        if (document.getElementById('veiculosTable')) {
            initializeAdvancedFilters('veiculosTable', 'Ve√≠culos');
        }
        
        // Valida√ß√£o de formul√°rio
        const forms = document.querySelectorAll('.needs-validation');
        
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    });

    // Fun√ß√£o de busca em tempo real
    function searchTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('veiculosTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = tbody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            let row = rows[i];
            let shouldShow = false;
            
            // Busca em todas as colunas de texto (exceto a √∫ltima que s√£o as a√ß√µes)
            const cells = row.getElementsByTagName('td');
            for (let j = 0; j < cells.length - 1; j++) {
                const cellText = cells[j].textContent || cells[j].innerText;
                if (cellText.toLowerCase().indexOf(filter) > -1) {
                    shouldShow = true;
                    break;
                }
            }
            
            row.style.display = shouldShow ? '' : 'none';
        }
    }

    // Vari√°veis globais para o modal
    let modalTipoServico = '';
    let modalVeiculoId = '';

    // Fun√ß√£o para abrir modal de servi√ßos completo
    function abrirModalServicos(tipoServico, idVeiculo, nomeVeiculo) {
        console.log(`[DEBUG] abrirModalServicos chamado: ${tipoServico}, veiculo: ${idVeiculo}, nome: ${nomeVeiculo}`);
        
        const modalElement = document.getElementById('modalServicosCompleto');
        const modalTitle = document.getElementById('modalServicosLabel');
        const modalContent = document.getElementById('modalServicosContent');
        
        if (!modalElement) {
            console.error('Modal de servi√ßos n√£o encontrado!');
            return;
        }

        // Armazenar vari√°veis globais
        modalTipoServico = tipoServico;
        modalVeiculoId = idVeiculo;
        
        // Exportar para window para acesso global
        window.modalTipoServico = tipoServico;
        window.modalVeiculoId = idVeiculo;

        // Abrir o modal
        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        // Configurar t√≠tulo
        const titulos = {
            'multas': 'üö® Multas',
            'ipva': 'üìÑ IPVA',
            'licenciamento': '‚úÖ Licenciamento',
            'manutencao': 'üîß Manuten√ß√£o'
        };
        modalTitle.innerHTML = `${titulos[tipoServico]} - ${nomeVeiculo}`;

        // Mostrar loading
        modalContent.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3">Carregando dados...</p>
            </div>
        `;

        // Carregar conte√∫do completo via AJAX
        const urls = {
            'multas': `/cadastros/veiculos/${idVeiculo}/multas?modal=1`,
            'ipva': `/cadastros/veiculos/${idVeiculo}/ipva?modal=1`,
            'licenciamento': `/cadastros/veiculos/${idVeiculo}/licenciamento?modal=1`,
            'manutencao': `/cadastros/veiculos/${idVeiculo}/manutencao?modal=1`
        };

        fetch(urls[tipoServico])
            .then(response => response.text())
            .then(html => {
                modalContent.innerHTML = html;
                
                // Carregar formul√°rio diretamente
                setTimeout(() => {
                    carregarFormularioDirecto(tipoServico, idVeiculo);
                }, 300);
                
                // Reinicializar scripts se necess√°rio
                if (typeof initializeAdvancedFilters === 'function') {
                    setTimeout(() => {
                        const table = modalContent.querySelector('table');
                        if (table) {
                            initializeAdvancedFilters(table.id, titulos[tipoServico]);
                        }
                    }, 100);
                }
            })
            .catch(error => {
                console.error('Erro ao carregar servi√ßos:', error);
                modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Erro ao carregar os dados. Tente novamente.
                    </div>
                `;
            });
    }

    // Fun√ß√£o espec√≠fica para carregar formul√°rio no modal de ve√≠culos
    function carregarFormularioDirecto(tipoServico, idVeiculo, idRegistro) {
        const formContainer = document.getElementById('formContainer');
        
        if (!formContainer) {
            console.error('Container do formul√°rio n√£o encontrado');
            return;
        }

        let url;
        
        // URLs para carregar formul√°rio (novo ou editar)
        if (idRegistro) {
            // Editar registro existente
            const editUrls = {
                'multas': `/cadastros/veiculos/${idVeiculo}/multas/${idRegistro}/editar?modal=1`,
                'ipva': `/cadastros/veiculos/${idVeiculo}/ipva/${idRegistro}/editar?modal=1`,
                'licenciamento': `/cadastros/veiculos/${idVeiculo}/licenciamento/${idRegistro}/editar?modal=1`,
                'manutencao': `/cadastros/veiculos/${idVeiculo}/manutencao/${idRegistro}/editar?modal=1`
            };
            url = editUrls[tipoServico];
        } else {
            // Novo registro
            const newUrls = {
                'multas': `/cadastros/veiculos/${idVeiculo}/multas/nova?modal=1`,
                'ipva': `/cadastros/veiculos/${idVeiculo}/ipva/novo?modal=1`,
                'licenciamento': `/cadastros/veiculos/${idVeiculo}/licenciamento/novo?modal=1`,
                'manutencao': `/cadastros/veiculos/${idVeiculo}/manutencao/nova?modal=1`
            };
            url = newUrls[tipoServico];
        }

        console.log('Carregando formul√°rio:', url);

        // Mostrar loading
        formContainer.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">${idRegistro ? 'Carregando dados...' : 'Carregando formul√°rio...'}</p>
            </div>
        `;

        fetch(url)
            .then(response => {
                console.log(`[${tipoServico.toUpperCase()}] Resposta recebida:`, response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                console.log(`[${tipoServico.toUpperCase()}] HTML recebido (${html.length} chars), inserindo no container`);
                if (html.length < 100) {
                    console.warn(`[${tipoServico.toUpperCase()}] HTML muito pequeno:`, html);
                }
                formContainer.innerHTML = html;
                
                // Inicializar formul√°rio
                setTimeout(() => {
                    console.log(`[${tipoServico.toUpperCase()}] Tentando inicializar formul√°rio...`);
                    if (typeof window.initializarFormularioModal === 'function') {
                        try {
                            window.initializarFormularioModal(tipoServico);
                            console.log(`[${tipoServico.toUpperCase()}] Formul√°rio inicializado com sucesso`);
                        } catch (error) {
                            console.error(`[${tipoServico.toUpperCase()}] Erro ao inicializar formul√°rio:`, error);
                        }
                    } else {
                        console.error(`[${tipoServico.toUpperCase()}] Fun√ß√£o initializarFormularioModal n√£o encontrada`);
                    }
                }, 100);
            })
            .catch(error => {
                console.error('Erro ao carregar formul√°rio:', error);
                formContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Erro ao carregar formul√°rio: ${error.message}
                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="carregarFormularioDirecto('${tipoServico}', ${idVeiculo}, ${idRegistro || 'null'})">
                            Tentar Novamente
                        </button>
                    </div>
                `;
            });
    }

    // Fun√ß√£o para inicializar formul√°rio no modal (adaptada para modal de ve√≠culos)
    window.initializarFormularioModal = function(tipo) {
        console.log(`[${tipo.toUpperCase()}] Inicializando formul√°rio modal...`);
        
        // Valida√ß√£o de formul√°rio
        const form = document.querySelector('#modalServicosContent form');
        if (form) {
            console.log(`[${tipo.toUpperCase()}] Formul√°rio encontrado, adicionando valida√ß√£o`);
            form.classList.add('needs-validation');
            
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                
                if (!form.checkValidity()) {
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }
                
                // Enviar formul√°rio via AJAX
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar mensagem de sucesso
                        alert(data.message || 'Salvo com sucesso!');
                        
                        // Recarregar o conte√∫do do modal
                        const modalContent = document.getElementById('modalServicosContent');
                        const tipoServico = modalTipoServico;
                        const idVeiculo = modalVeiculoId;
                        
                        // Recarregar conte√∫do completo
                        const urls = {
                            'multas': `/cadastros/veiculos/${idVeiculo}/multas?modal=1`,
                            'ipva': `/cadastros/veiculos/${idVeiculo}/ipva?modal=1`,
                            'licenciamento': `/cadastros/veiculos/${idVeiculo}/licenciamento?modal=1`,
                            'manutencao': `/cadastros/veiculos/${idVeiculo}/manutencao?modal=1`
                        };
                        
                        fetch(urls[tipoServico])
                            .then(response => response.text())
                            .then(html => {
                                modalContent.innerHTML = html;
                            });
                    } else {
                        // Mostrar erros do formul√°rio
                        if (data.errors) {
                            mostrarErrosFormulario(data.errors);
                        } else {
                            alert(data.message || 'Erro ao salvar dados.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao enviar formul√°rio:', error);
                    alert('Erro ao salvar dados. Tente novamente.');
                });
            });
        }
        
        // Inicializar c√°lculos autom√°ticos conforme o tipo
        if (tipo === 'ipva' || tipo === 'licenciamento') {
            initCalculoAutomaticoValorTotal(tipo);
        } else if (tipo === 'manutencao') {
            initCalculoAutomaticoManutencao();
        }
        
        // Aplicar m√°scaras de moeda (excluindo campos de ano)
        aplicarMascaraMoeda('#modalServicosContent input[type="number"]:not([name="ano_exercicio"])');
        aplicarMascaraMoeda('#modalServicosContent input[name*="valor"]');
    };

    // Fun√ß√µes auxiliares para c√°lculos (vers√µes simplificadas)
    function initCalculoAutomaticoValorTotal(tipo) {
        const valorPrincipal = document.querySelector(`#modalServicosContent input[name="valor_${tipo === 'ipva' ? 'ipva' : 'licenciamento'}"]`);
        const valorTaxa = document.querySelector('#modalServicosContent input[name="valor_taxa_detran"]');
        const valorMulta = document.querySelector('#modalServicosContent input[name="valor_multa_juros"]');
        const valorTotal = document.querySelector('#modalServicosContent input[name="valor_total"]');
        
        function calcularTotal() {
            const principal = parseFloat(valorPrincipal?.value) || 0;
            const taxa = parseFloat(valorTaxa?.value) || 0;
            const multa = parseFloat(valorMulta?.value) || 0;
            if (valorTotal) {
                valorTotal.value = (principal + taxa + multa).toFixed(2);
            }
        }
        
        valorPrincipal?.addEventListener('input', calcularTotal);
        valorTaxa?.addEventListener('input', calcularTotal);
        valorMulta?.addEventListener('input', calcularTotal);
    }

    function initCalculoAutomaticoManutencao() {
        const valorServico = document.querySelector('#modalServicosContent input[name="valor_servico"]');
        const valorPecas = document.querySelector('#modalServicosContent input[name="valor_pecas"]');
        const valorTotal = document.querySelector('#modalServicosContent input[name="valor_total"]');
        
        function calcularTotal() {
            const servico = parseFloat(valorServico?.value) || 0;
            const pecas = parseFloat(valorPecas?.value) || 0;
            if (valorTotal) {
                valorTotal.value = (servico + pecas).toFixed(2);
            }
        }
        
        valorServico?.addEventListener('input', calcularTotal);
        valorPecas?.addEventListener('input', calcularTotal);
    }

    function mostrarErrosFormulario(errors) {
        for (const field in errors) {
            const input = document.querySelector(`#modalServicosContent [name="${field}"]`);
            if (input) {
                input.classList.add('is-invalid');
                
                // Remover feedback anterior
                const existingFeedback = input.parentNode.querySelector('.invalid-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                // Adicionar novo feedback
                const feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                feedback.textContent = errors[field][0];
                input.parentNode.appendChild(feedback);
            }
        }
    }

    function aplicarMascaraMoeda(selector) {
        const elementos = document.querySelectorAll(selector);
        elementos.forEach(elemento => {
            elemento.addEventListener('input', function() {
                // Implementa√ß√£o b√°sica de m√°scara de moeda
                let value = this.value.replace(/\D/g, '');
                value = (value / 100).toFixed(2);
                this.value = value;
            });
        });
    }
</script>

<!-- Modal para Servi√ßos Completos -->
<div class="modal fade" id="modalServicosCompleto" tabindex="-1" aria-labelledby="modalServicosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalServicosLabel">
                    <i class="bi bi-tools me-2"></i>Servi√ßos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalServicosContent">
                    <!-- Conte√∫do ser√° carregado via AJAX -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-3">Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} 