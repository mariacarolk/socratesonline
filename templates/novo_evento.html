{% extends "base.html" %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Início</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('listar_eventos') }}">Eventos</a></li>
    {% if is_editing %}
      <li class="breadcrumb-item active" aria-current="page">Editar Evento</li>
    {% else %}
      <li class="breadcrumb-item active" aria-current="page">Novo Evento</li>
    {% endif %}
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            {% if is_editing %}
                Editar Evento
            {% else %}
              Novo Evento
            {% endif %}
          </h2>
        </div>
        <div class="card-body">
        <form method="POST" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            
            <!-- Campos hidden para despesas cabeça -->
            <div id="despesas-cabeca-hidden"></div>
            
            <!-- Dados Básicos do Evento -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    {{ form.nome.label(class="form-label") }}
                    <div class="input-group">
                  {{ form.nome(class="form-control", placeholder="Nome do evento") }}
                        <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                        </div>
                {% if form.nome.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.nome.errors %}
                      {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}
                </div>
              
                <div class="col-md-3 mb-3">
                    {{ form.data_inicio.label(class="form-label") }}
                    <div class="input-group">
                  {{ form.data_inicio(class="form-control", type="date") }}
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        </div>
                {% if form.data_inicio.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.data_inicio.errors %}
                      {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}
                </div>
              
                <div class="col-md-3 mb-3">
                    {{ form.data_fim.label(class="form-label") }}
                    <div class="input-group">
                  {{ form.data_fim(class="form-control", type="date") }}
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        </div>
                {% if form.data_fim.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.data_fim.errors %}
                      {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}
                </div>

              <div class="col-md-3 mb-3">
                    {{ form.estado.label(class="form-label") }}
                    <div class="input-group">
                  {{ form.estado(class="form-select", id="estado") }}
                        <span class="input-group-text"><i class="bi bi-map"></i></span>
                        </div>
                    <div class="form-text">Selecione primeiro o estado</div>
                {% if form.estado.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.estado.errors %}
                      {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}
                </div>

              <div class="col-md-3 mb-3">
                {{ form.cidade.label(class="form-label") }}
                    <div class="input-group">
                  {{ form.cidade(class="form-control", placeholder="Selecione primeiro um estado", id="cidade", disabled=true) }}
                  <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                        </div>
                {% if form.cidade.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.cidade.errors %}
                      {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                    {{ form.endereco.label(class="form-label") }}
                    <div class="input-group">
                  {{ form.endereco(class="form-control", placeholder="Endereço completo") }}
                        <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                        </div>
                {% if form.endereco.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.endereco.errors %}
                      {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                    {{ form.id_circo.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.id_circo(class="form-select") }}
                        <span class="input-group-text"><i class="bi bi-building"></i></span>
                    </div>
                {% if form.id_circo.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.id_circo.errors %}
                      {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
              </div>
              
                <div class="col-md-6 mb-3">
                    {{ form.id_produtor.label(class="form-label") }}
                    <div class="input-group">
                  {{ form.id_produtor(class="form-select") }}
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                        </div>
                {% if form.id_produtor.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.id_produtor.errors %}
                      {{ error }}
                    {% endfor %}
                    </div>
                {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                    {{ form.status.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.status(class="form-select") }}
                        <span class="input-group-text"><i class="bi bi-flag"></i></span>
                    </div>
                {% if form.status.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.status.errors %}
                      {{ error }}
            {% endfor %}
                </div>
                                        {% endif %}
                </div>

              <div class="col-12 mb-3">
                    {{ form.observacoes.label(class="form-label") }}
                {{ form.observacoes(class="form-control", rows="3", placeholder="Observações sobre o evento") }}
                {% if form.observacoes.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.observacoes.errors %}
                      {{ error }}
                            {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Seção de Receitas - Apenas no modo edição -->
            {% if is_editing %}
            <div class="row mb-3">
              <div class="col-12">
                <h5 class="text-success mb-2">
                  <i class="bi bi-cash-coin me-1"></i>Receitas do Evento
                </h5>

            {% for categoria in categorias_receita %}
                <div class="card mb-2">
                  <div class="card-header bg-success text-white py-2">
                    <h5 class="mb-0 fw-bold text-uppercase" style="font-size: 14px; letter-spacing: 0.5px;">
                      <i class="bi bi-cash-stack me-2"></i>{{ categoria.nome }}
                    </h5>
                </div>
                  <div class="card-body py-2">
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered table-compact">
                        <thead class="table-light">
                          <tr>
                            <th style="width: 30%;">Receita</th>
                            <th style="width: 15%;">Data</th>
                            <th style="width: 15%;">Valor</th>
                            <th style="width: 20%;">Observações</th>
                            <th style="width: 20%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                          <!-- Receitas já cadastradas dessa categoria -->
                          {% for receita in receitas_salvas %}
                            {% if receita.receita.categoria.id_categoria_receita == categoria.id_categoria_receita %}
                            <tr class="table-success" id="receita_salva_row_{{ receita.id_receita_evento }}">
                              <td><strong>{{ receita.receita.nome }}</strong></td>
                              <td>
                                <span class="receita-display">{{ receita.data.strftime('%d/%m/%Y') }}</span>
                                <input type="date" class="form-control form-control-sm receita-edit d-none" 
                                       id="receita_salva_data_{{ receita.id_receita_evento }}" 
                                       value="{{ receita.data.strftime('%Y-%m-%d') }}">
                              </td>
                              <td>
                                <span class="receita-display text-end"><strong>R$ {{ "%.2f"|format(receita.valor) }}</strong></span>
                                <input type="text" class="form-control form-control-sm receita-edit d-none" 
                                       id="receita_salva_valor_{{ receita.id_receita_evento }}" 
                                       value="{{ ("%.2f"|format(receita.valor)|replace('.', ',')) }}"
                                       oninput="formatarMoeda(this)">
                              </td>
                              <td>
                                <span class="receita-display">
                                  <small>{{ receita.observacoes or '—' }}</small>
                                </span>
                                <input type="text" class="form-control form-control-sm receita-edit d-none" 
                                       id="receita_obs_inline_{{ receita.id_receita_evento }}" 
                                       value="{{ receita.observacoes or '' }}"
                                       placeholder="Observações">
                              </td>
                              <td>
                                <div class="d-flex gap-1">
                                  <button type="button" class="btn btn-sm btn-outline-info" 
                                          onclick="verDetalhesReceita({{ receita.id_receita_evento }}, '{{ receita.receita.nome }}', '{{ receita.data.strftime('%d/%m/%Y') }}', '{{ "%.2f"|format(receita.valor) }}', '{{ receita.observacoes or '' }}')" 
                                          title="Ver Detalhes">
                                    <i class="bi bi-eye"></i>
                                  </button>
                                  <button type="button" class="btn btn-sm btn-outline-primary receita-btn-editar" 
                                          onclick="editarReceitaSalva({{ receita.id_receita_evento }})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                  </button>
                                  <button type="button" class="btn btn-sm btn-success receita-btn-salvar d-none" 
                                          onclick="salvarReceitaSalva({{ receita.id_receita_evento }})" title="Salvar">
                                    <i class="bi bi-check"></i>
                                  </button>
                                  <button type="button" class="btn btn-sm btn-outline-danger" 
                                          onclick="excluirReceita({{ receita.id_receita_evento }})" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </div>
                                <!-- Campos ocultos para edição -->
                                <input type="text" class="form-control form-control-sm receita-edit d-none" 
                                       id="receita_salva_obs_{{ receita.id_receita_evento }}" 
                                       value="{{ receita.observacoes or '' }}"
                                       placeholder="Observações" style="margin-top: 5px;">
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}

                          <!-- Receitas não cadastradas dessa categoria -->
                            {% for receita in categorias_receita_dict[categoria.id_categoria_receita] %}
                          {% if receita.id_receita not in receitas_salvas|map(attribute='receita.id_receita')|list %}
                          <tr class="table-light">
                            <td><strong>{{ receita.nome }}</strong></td>
                            <td colspan="4">
                              <button type="button" class="btn btn-sm btn-success w-100" 
                                      onclick="abrirModalReceita('{{ receita.id_receita }}', '{{ categoria.id_categoria_receita }}', '{{ receita.nome }}', '{{ categoria.nome }}')" 
                                      title="Cadastrar Receita">
                                <i class="bi bi-plus me-2"></i>Cadastrar esta receita
                              </button>
                            </td>
                          </tr>
                          {% endif %}
                            {% endfor %}
                          
                          <!-- Subtotal da categoria -->
                          {% set receitas_da_categoria = receitas_salvas|selectattr('receita.categoria.id_categoria_receita', 'equalto', categoria.id_categoria_receita)|list %}
                          {% set categoria_total = receitas_da_categoria|map(attribute='valor')|sum %}
                          <tr class="table-info">
                            <td colspan="2"><strong>Subtotal da Categoria</strong></td>
                            <td><strong>R$ {{ "%.2f"|format(categoria_total) }}</strong></td>
                            <td colspan="2"></td>
                          </tr>
                          
                          <!-- Linha para adicionar nova receita na categoria -->
                          <tr class="table-light">
                            <td colspan="5">
                              <button type="button" class="btn btn-sm btn-outline-success w-100" 
                                      onclick="abrirModalReceita('', '{{ categoria.id_categoria_receita }}', '', '{{ categoria.nome }}')" 
                                      title="Incluir Nova Receita">
                                <i class="bi bi-plus me-2"></i>Incluir nova receita
                              </button>
                            </td>
                          </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
            {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Seção de Despesas - Apenas no modo edição -->
            {% if is_editing %}
            <div class="row mb-3">
              <div class="col-12">
                <h5 class="text-danger mb-2">
                  <i class="bi bi-credit-card me-1"></i>Despesas do Evento
                </h5>

            {% for categoria in categorias_despesa %}
                <div class="card mb-2">
                  <div class="card-header bg-danger text-white py-2">
                    <h5 class="mb-0 fw-bold text-uppercase" style="font-size: 14px; letter-spacing: 0.5px;">
                      <i class="bi bi-credit-card-2-front me-2"></i>{{ categoria.nome }}
                    </h5>
                </div>
                  <div class="card-body py-2">
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered table-compact">
                        <thead class="table-light">
                          <tr>
                            <th style="width: 25%;">Despesa</th>
                            <th style="width: 10%;">Data</th>
                            <th style="width: 10%;">Valor Real</th>
                            <th style="width: 10%;">Valor Pago SO</th>
                            <th style="width: 8%;">Status</th>
                            <th style="width: 8%;">Despesa da Cabeça</th>
                            <th style="width: 14%;">Observações</th>
                            <th style="width: 15%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                          <!-- Despesas já cadastradas dessa categoria - MÚLTIPLAS INSTÂNCIAS -->
                          {% if despesas_evento_por_categoria[categoria.id_categoria_despesa] %}
                            {% for despesa in despesas_evento_por_categoria[categoria.id_categoria_despesa]['fixas'] %}
                          <tr class="table-primary" id="despesa_row_{{ despesa.id_despesa_evento }}">
                            <td><strong>{{ despesa.nome }}</strong> <small class="text-muted">(Fixa)</small></td>
                            <td>
                              <span class="despesa-display">{{ despesa.data_atual|date_br if despesa.data_atual else '' }}</span>
                              <input type="date" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_data_vencimento_{{ despesa.id_despesa }}" 
                                     value="{{ despesa.data_atual }}">
                                </td>
                                <td>
                              <span class="despesa-display"><strong>R$ {{ "%.2f"|format(despesa.valor_atual) }}</strong></span>
                              <input type="text" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_valor_{{ despesa.id_despesa }}" 
                                     value="{{ (despesa.valor_atual|string).replace('.', ',') }}"
                                     oninput="formatarMoeda(this)">
                                </td>
                                <td>
                              <span class="despesa-display">
                                {% if despesa.valor_pago_socrates_atual %}
                                  <strong>R$ {{ "%.2f"|format(despesa.valor_pago_socrates_atual) }}</strong>
                                {% else %}
                                  <span class="text-muted">-</span>
                                {% endif %}
                              </span>
                              <input type="text" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_valor_pago_socrates_{{ despesa.id_despesa }}" 
                                     value="{{ (despesa.valor_pago_socrates_atual|string).replace('.', ',') if despesa.valor_pago_socrates_atual else '' }}"
                                     oninput="formatarMoeda(this)">
                                </td>
                                <td>
                              <span class="despesa-display">
                                <span class="badge bg-{{ 'success' if despesa.status_atual == 'pago' else 'warning' }}" style="font-size: 10px;">
                                  {{ despesa.status_atual|title }}
                                    </span>
                                    </span>
                              <select class="form-select form-select-sm despesa-edit d-none" id="despesa_status_{{ despesa.id_despesa }}">
                                <option value="pendente" {% if despesa.status_atual == 'pendente' %}selected{% endif %}>Pendente</option>
                                <option value="pago" {% if despesa.status_atual == 'pago' %}selected{% endif %}>Pago</option>
                              </select>
                                </td>
                                <td>
                              <span class="despesa-display">
                                <input type="checkbox" class="form-check-input despesa-cabeca" 
                                       id="despesa_cabeca_{{ despesa.id_despesa }}" 
                                       data-despesa-evento-id="{{ despesa.id_despesa_evento }}"
                                       data-evento-id="{{ evento.id_evento if evento else '{{evento.id_evento}}' }}"
                                       onchange="atualizarDespesaCabeca(this)"
                                       {% if despesa.despesa_cabeca_atual %}checked{% endif %}>
                              </span>
                              <input type="checkbox" class="form-check-input despesa-edit d-none" id="despesa_cabeca_edit_{{ despesa.id_despesa }}" {% if despesa.despesa_cabeca_atual %}checked{% endif %}>
                                </td>
                                <td>
                              <span class="despesa-display">
                                <small>{{ despesa.obs_atual or '—' }}</small>
                              </span>
                              <input type="text" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_obs_inline_{{ despesa.id_despesa }}" 
                                     value="{{ despesa.obs_atual or '' }}"
                                     placeholder="Observações">
                                </td>
                                <td>
                              <div class="d-flex gap-1">
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        onclick="verDetalhesDespesa({{ despesa.id_despesa }}, '{{ despesa.nome }}', '{{ despesa.data_atual }}', '{{ "%.2f"|format(despesa.valor_atual) }}', '{{ despesa.fornecedor_atual or "" }}', '{{ despesa.status_atual }}', '{{ despesa.forma_atual }}', '{{ despesa.pago_por_atual or "" }}', '{{ despesa.obs_atual or "" }}', 'Fixa')" 
                                        title="Ver Detalhes">
                                  <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary despesa-btn-editar" 
                                        onclick="editarDespesaModal(this)" 
                                        data-despesa-evento-id="{{ despesa.id_despesa_evento }}"
                                        data-despesa-id="{{ despesa.id_despesa }}"
                                        data-categoria-id="{{ despesa.categoria_id }}"
                                        data-nome="{{ despesa.nome }}"
                                        data-categoria-nome="{{ despesa.categoria_nome }}"
                                        data-is-fixa="true"
                                        data-data="{{ despesa.data_atual }}"
                                        data-valor="{{ ("%.2f"|format(despesa.valor_atual)) if despesa.valor_atual else "" }}"
                                        data-valor-pago-socrates="{{ ("%.2f"|format(despesa.valor_pago_socrates_atual)) if despesa.valor_pago_socrates_atual else "" }}"
                                        data-fornecedor="{{ despesa.fornecedor_nome_atual or "" }}"
                                        data-fornecedor-id="{{ despesa.fornecedor_atual or "" }}"
                                        data-status="{{ despesa.status_atual }}"
                                        data-forma="{{ despesa.forma_atual }}"
                                        data-pago-por="{{ despesa.pago_por_atual or "" }}"
                                        data-obs="{{ despesa.obs_atual or "" }}"
                                        data-despesa-cabeca="{{ despesa.despesa_cabeca_atual }}"
                                        data-comprovante="{{ despesa.comprovante_atual or "" }}"
                                        data-qtd-dias="{{ despesa.qtd_dias_atual or "" }}"
                                        data-qtd-pessoas="{{ despesa.qtd_pessoas_atual or "" }}"
                                        title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                <button type="button" class="btn btn-sm btn-success despesa-btn-salvar d-none" 
                                        onclick="salvarDespesa({{ despesa.id_despesa }}, true)" title="Salvar">
                                  <i class="bi bi-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="excluirDespesa({{ despesa.id_despesa_evento }})" title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                              </div>
                              <!-- Campos ocultos para edição -->
                              <div class="despesa-edit d-none" style="margin-top: 5px;">
                                <select class="form-select form-select-sm mb-1" id="despesa_fornecedor_{{ despesa.id_despesa }}">
                                  <option value="">Selecione...</option>
                                  {% for fornecedor in fornecedores %}
                                  <option value="{{ fornecedor.id_fornecedor }}" {% if fornecedor.id_fornecedor == despesa.fornecedor_atual %}selected{% endif %}>{{ fornecedor.nome }}</option>
                                  {% endfor %}
                                </select>
                                <select class="form-select form-select-sm mb-1" id="despesa_status_{{ despesa.id_despesa }}">
                                  <option value="pendente" {% if despesa.status_atual == 'pendente' %}selected{% endif %}>Pendente</option>
                                  <option value="pago" {% if despesa.status_atual == 'pago' %}selected{% endif %}>Pago</option>
                                </select>
                                <select class="form-select form-select-sm mb-1" id="despesa_forma_{{ despesa.id_despesa }}">
                                  <option value="débito" {{ 'selected' if despesa.forma_atual == 'débito' else '' }}>Débito</option>
                                  <option value="crédito" {{ 'selected' if despesa.forma_atual == 'crédito' else '' }}>Crédito</option>
                                  <option value="espécie" {{ 'selected' if despesa.forma_atual == 'espécie' else '' }}>Espécie</option>
                                  <option value="pix" {{ 'selected' if despesa.forma_atual == 'pix' else '' }}>Pix</option>
                                </select>
                                <input type="text" class="form-control form-control-sm mb-1" 
                                       id="despesa_pago_por_{{ despesa.id_despesa }}" 
                                       value="{{ despesa.pago_por_atual or '' }}"
                                       placeholder="Pago por">
                                <input type="text" class="form-control form-control-sm" 
                                       id="despesa_obs_{{ despesa.id_despesa }}" 
                                       value="{{ despesa.obs_atual or '' }}"
                                       placeholder="Observações">
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}

                            {% for despesa in despesas_evento_por_categoria[categoria.id_categoria_despesa]['variaveis'] %}
                          <tr class="table-success" id="despesa_row_{{ despesa.id_despesa_evento }}">
                            <td><strong>{{ despesa.nome }}</strong> <small class="text-muted">(Variável)</small></td>
                            <td>
                              <span class="despesa-display">{{ despesa.data_atual|date_br if despesa.data_atual else '' }}</span>
                              <input type="date" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_data_vencimento_{{ despesa.id_despesa }}" 
                                     value="{{ despesa.data_atual }}">
                                </td>
                            <td>
                              <span class="despesa-display"><strong>R$ {{ "%.2f"|format(despesa.valor_atual)|replace('.', ',') }}</strong></span>
                              <input type="text" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_valor_{{ despesa.id_despesa }}" 
                                     value="{{ ("%.2f"|format(despesa.valor_atual)|replace('.', ',')) if despesa.valor_atual else '' }}"
                                     oninput="formatarMoeda(this)">
                                </td>
                                <td>
                              <span class="despesa-display">
                                {% if despesa.valor_pago_socrates_atual %}
                                  <strong>R$ {{ "%.2f"|format(despesa.valor_pago_socrates_atual) }}</strong>
                                {% else %}
                                  <span class="text-muted">-</span>
                                {% endif %}
                              </span>
                              <input type="text" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_valor_pago_socrates_{{ despesa.id_despesa }}" 
                                     value="{{ (despesa.valor_pago_socrates_atual|string).replace('.', ',') if despesa.valor_pago_socrates_atual else '' }}"
                                     oninput="formatarMoeda(this)">
                                </td>
                                <td>
                              <span class="despesa-display">
                                <span class="badge bg-{{ 'success' if despesa.status_atual == 'pago' else 'warning' }}" style="font-size: 10px;">
                                  {{ despesa.status_atual|title }}
                                </span>
                              </span>
                              <select class="form-select form-select-sm despesa-edit d-none" id="despesa_status_{{ despesa.id_despesa }}">
                                <option value="pendente" {% if despesa.status_atual == 'pendente' %}selected{% endif %}>Pendente</option>
                                <option value="pago" {% if despesa.status_atual == 'pago' %}selected{% endif %}>Pago</option>
                                    </select>
                                </td>
                                <td>
                              <span class="despesa-display">
                                <input type="checkbox" class="form-check-input despesa-cabeca" 
                                       id="despesa_cabeca_{{ despesa.id_despesa }}" 
                                       data-despesa-evento-id="{{ despesa.id_despesa_evento }}"
                                       data-evento-id="{{ evento.id_evento if evento else '{{evento.id_evento}}' }}"
                                       onchange="atualizarDespesaCabeca(this)"
                                       {% if despesa.despesa_cabeca_atual %}checked{% endif %}>
                              </span>
                              <input type="checkbox" class="form-check-input despesa-edit d-none" id="despesa_cabeca_edit_{{ despesa.id_despesa }}" {% if despesa.despesa_cabeca_atual %}checked{% endif %}>
                                </td>
                                <td>
                              <span class="despesa-display">
                                <small>{{ despesa.obs_atual or '—' }}</small>
                              </span>
                              <input type="text" class="form-control form-control-sm despesa-edit d-none" 
                                     id="despesa_obs_inline_{{ despesa.id_despesa }}" 
                                     value="{{ despesa.obs_atual or '' }}"
                                     placeholder="Observações">
                                </td>
                                <td>
                              <div class="d-flex gap-1">
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        onclick="verDetalhesDespesa({{ despesa.id_despesa }}, '{{ despesa.nome }}', '{{ despesa.data_atual }}', '{{ "%.2f"|format(despesa.valor_atual) }}', '{{ despesa.fornecedor_atual or "" }}', '{{ despesa.status_atual }}', '{{ despesa.forma_atual }}', '{{ despesa.pago_por_atual or "" }}', '{{ despesa.obs_atual or "" }}', 'Variável')" 
                                        title="Ver Detalhes">
                                  <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary despesa-btn-editar" 
                                        onclick="editarDespesaModal(this)" 
                                        data-despesa-evento-id="{{ despesa.id_despesa_evento }}"
                                        data-despesa-id="{{ despesa.id_despesa }}"
                                        data-categoria-id="{{ despesa.categoria_id }}"
                                        data-nome="{{ despesa.nome }}"
                                        data-categoria-nome="{{ despesa.categoria_nome }}"
                                        data-is-fixa="false"
                                        data-data="{{ despesa.data_atual }}"
                                        data-valor="{{ ("%.2f"|format(despesa.valor_atual)) if despesa.valor_atual else "" }}"
                                        data-valor-pago-socrates="{{ ("%.2f"|format(despesa.valor_pago_socrates_atual)) if despesa.valor_pago_socrates_atual else "" }}"
                                        data-fornecedor="{{ despesa.fornecedor_nome_atual or "" }}"
                                        data-fornecedor-id="{{ despesa.fornecedor_atual or "" }}"
                                        data-status="{{ despesa.status_atual }}"
                                        data-forma="{{ despesa.forma_atual }}"
                                        data-pago-por="{{ despesa.pago_por_atual or "" }}"
                                        data-obs="{{ despesa.obs_atual or "" }}"
                                        data-despesa-cabeca="{{ despesa.despesa_cabeca_atual }}"
                                        data-comprovante="{{ despesa.comprovante_atual or "" }}"
                                        data-qtd-dias="{{ despesa.qtd_dias_atual or "" }}"
                                        data-qtd-pessoas="{{ despesa.qtd_pessoas_atual or "" }}"
                                        title="Editar">
                                  <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-success despesa-btn-salvar d-none" 
                                        onclick="salvarDespesa({{ despesa.id_despesa }}, false)" title="Salvar">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="excluirDespesa({{ despesa.id_despesa_evento }})" title="Excluir">
                                  <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                              <!-- Campos ocultos para edição -->
                              <div class="despesa-edit d-none" style="margin-top: 5px;">
                                <select class="form-select form-select-sm mb-1" id="despesa_fornecedor_{{ despesa.id_despesa }}">
                                  <option value="">Selecione...</option>
                                  {% for fornecedor in fornecedores %}
                                  <option value="{{ fornecedor.id_fornecedor }}" {% if fornecedor.id_fornecedor == despesa.fornecedor_atual %}selected{% endif %}>{{ fornecedor.nome }}</option>
                                  {% endfor %}
                                </select>
                                <select class="form-select form-select-sm mb-1" id="despesa_status_{{ despesa.id_despesa }}">
                                  <option value="pendente" {% if despesa.status_atual == 'pendente' %}selected{% endif %}>Pendente</option>
                                  <option value="pago" {% if despesa.status_atual == 'pago' %}selected{% endif %}>Pago</option>
                                </select>
                                <select class="form-select form-select-sm mb-1" id="despesa_forma_{{ despesa.id_despesa }}">
                                  <option value="débito" {% if despesa.forma_atual == 'débito' %}selected{% endif %}>Débito</option>
                                  <option value="crédito" {% if despesa.forma_atual == 'crédito' %}selected{% endif %}>Crédito</option>
                                  <option value="espécie" {% if despesa.forma_atual == 'espécie' %}selected{% endif %}>Espécie</option>
                                  <option value="pix" {% if despesa.forma_atual == 'pix' %}selected{% endif %}>Pix</option>
                                </select>
                                <input type="text" class="form-control form-control-sm mb-1" 
                                       id="despesa_pago_por_{{ despesa.id_despesa }}" 
                                       value="{{ despesa.pago_por_atual or '' }}"
                                       placeholder="Pago por">
                                <input type="text" class="form-control form-control-sm" 
                                       id="despesa_obs_{{ despesa.id_despesa }}" 
                                       value="{{ despesa.obs_atual or '' }}"
                                       placeholder="Observações">
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                          {% endif %}

                          <!-- Despesas não cadastradas dessa categoria -->
                          {% for despesa in categorias_despesa_dict[categoria.id_categoria_despesa]['fixas'] %}
                          {% if not despesa.ja_cadastrada %}
                          <tr class="table-light">
                            <td><strong>{{ despesa.nome }}</strong> <small class="text-muted">(Fixa)</small>
                              {% if despesa.valor_medio %}
                                <br><em class="text-info">Valor médio: R$ {{ "%.2f"|format(despesa.valor_medio) }}</em>
                              {% endif %}
                            </td>
                            <td colspan="6">
                              <button type="button" class="btn btn-sm btn-success w-100" 
                                      onclick="abrirModalDespesaUnificado('{{ despesa.id_despesa }}', '{{ categoria.id_categoria_despesa }}', '{{ despesa.nome }}', '{{ categoria.nome }}', 'true', '{{ despesa.valor_medio if despesa.valor_medio else "" }}')" 
                                      title="Cadastrar Despesa">
                                <i class="bi bi-plus me-2"></i>Cadastrar esta despesa fixa
                              </button>
                            </td>
                          </tr>
                          {% endif %}
                          {% endfor %}

                          {% for despesa in categorias_despesa_dict[categoria.id_categoria_despesa]['variaveis'] %}
                          {% if not despesa.ja_cadastrada %}
                          <tr class="table-light">
                            <td><strong>{{ despesa.nome }}</strong> <small class="text-muted">(Variável)</small>
                              {% if despesa.valor_medio %}
                                <br><em class="text-info">Valor médio: R$ {{ "%.2f"|format(despesa.valor_medio) }}</em>
                              {% endif %}
                            </td>
                            <td colspan="6">
                              <button type="button" class="btn btn-sm btn-success w-100" 
                                      onclick="abrirModalDespesaUnificado('{{ despesa.id_despesa }}', '{{ categoria.id_categoria_despesa }}', '{{ despesa.nome }}', '{{ categoria.nome }}', 'false', '{{ despesa.valor_medio if despesa.valor_medio else "" }}')" 
                                      title="Cadastrar Despesa">
                                <i class="bi bi-plus me-2"></i>Cadastrar esta despesa variável
                              </button>
                            </td>
                          </tr>
                          {% endif %}
                            {% endfor %}
                          
                          <!-- Subtotal da categoria -->
                          {% set categoria_total_despesa = 0 %}
                          {% if despesas_evento_por_categoria[categoria.id_categoria_despesa] %}
                            {% set valores_fixas = despesas_evento_por_categoria[categoria.id_categoria_despesa]['fixas']|map(attribute='valor_atual')|map('float')|sum %}
                            {% set valores_variaveis = despesas_evento_por_categoria[categoria.id_categoria_despesa]['variaveis']|map(attribute='valor_atual')|map('float')|sum %}
                            {% set categoria_total_despesa = valores_fixas + valores_variaveis %}
                          {% endif %}
                          <tr class="table-warning">
                            <td colspan="2"><strong>Subtotal da Categoria</strong></td>
                            <td><strong>R$ {{ "%.2f"|format(categoria_total_despesa) }}</strong></td>
                            <td colspan="4"></td>
                          </tr>
                          
                          <!-- Linha para adicionar nova despesa na categoria -->
                          <tr class="table-light">
                            <td colspan="7">
                              <button type="button" class="btn btn-sm btn-outline-danger w-100" 
                                      onclick="abrirModalDespesaUnificado('', '{{ categoria.id_categoria_despesa }}', '', '{{ categoria.nome }}', 'false', '')" 
                                      title="Incluir Nova Despesa">
                                <i class="bi bi-plus me-2"></i>Incluir nova despesa
                              </button>
                            </td>
                          </tr>
                        </tbody>
                    </table>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <div class="d-flex justify-content-end gap-2">
              <a href="{{ url_for('listar_eventos') }}" class="btn btn-secondary">
                <i class="bi bi-x-circle me-2"></i>Cancelar
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-2"></i>Salvar Evento
                        </button>
                    </div>
        </form>
                </div>
            </div>
    </div>
    </div>
</div>

<!-- Modal Adicionar Receita -->
<div class="modal fade" id="modalAdicionarReceita" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-cash-coin me-2"></i>Adicionar Receita
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form onsubmit="adicionarReceitaEvento(event)">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Categoria da Receita</label>
              <select name="categoria_receita" class="form-select" id="modal_receita_categoria" required>
                <option value="">Selecione uma categoria...</option>
                {% for categoria in categorias_receita %}
                <option value="{{ categoria.id_categoria_receita }}">{{ categoria.nome }}</option>
            {% endfor %}
              </select>
            </div>
            
            <div class="col-12">
              <label class="form-label">Receita</label>
              <select name="receita_id" class="form-select" id="modal_receita_item" required>
                <option value="">Primeiro selecione a categoria...</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Data</label>
              <input type="date" name="data" class="form-control" id="modal_receita_data" required value="{{ current_date }}">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Valor (R$)</label>
              <input type="text" name="valor" class="form-control" id="modal_receita_valor" required placeholder="0,00"
                     oninput="formatarMoeda(this)">
            </div>
            
            <div class="col-12">
              <label class="form-label">Observações</label>
              <textarea name="observacoes" class="form-control" id="modal_receita_obs" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-plus-circle me-2"></i>Adicionar Receita
          </button>
        </div>
        </form>
    </div>
</div>
</div>

<!-- Incluir Modal Unificado -->
{% include 'modal_despesa_unificado.html' %}

<!-- Modal Adicionar Despesa (REMOVIDO - usando modal unificado) -->
<div class="modal fade" id="modalAdicionarDespesaOLD" tabindex="-1" aria-hidden="true" style="display: none !important;">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-credit-card me-2"></i>Adicionar Despesa
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form onsubmit="return false;" enctype="multipart/form-data">
        <div class="modal-body p-4">
          <div class="row g-3">
            <div class="col-12">
                <label class="form-label fw-medium">Categoria da Despesa</label>
              <select name="categoria_despesa" class="form-select" id="modal_despesa_categoria" required>
                <option value="">Selecione uma categoria...</option>
                {% for categoria in categorias_despesa %}
                <option value="{{ categoria.id_categoria_despesa }}">{{ categoria.nome }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-12">
                <label class="form-label fw-medium">Despesa</label>
              <select name="despesa_id" class="form-select" id="modal_despesa_item" required>
                <option value="">Primeiro selecione a categoria...</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <div class="form-check d-flex align-items-center h-100">
                <input type="checkbox" name="despesa_cabeca" class="form-check-input me-2" id="despesa_cabeca_novo_evento" value="1">
                <label class="form-check-label fw-medium" for="despesa_cabeca_novo_evento">
                  Despesa da cabeça
                </label>
              </div>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-medium">Data de Vencimento</label>
              <input type="date" name="data_vencimento" class="form-control" id="modal_despesa_data_vencimento" required value="{{ current_date }}">
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-medium">Data de Pagamento</label>
              <input type="date" name="data_pagamento" class="form-control" id="modal_despesa_data_pagamento">
              <small class="text-muted">Opcional - preencha apenas se já foi pago</small>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-medium">Valor Real (R$)</label>
                <input type="text" name="valor" class="form-control" id="modal_despesa_valor" required placeholder="0,00">
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-medium">Valor Pago Sócrates Online (R$)</label>
                <input type="text" name="valor_pago_socrates" class="form-control" id="modal_despesa_valor_pago_socrates" placeholder="0,00">
            </div>
            
            <div class="col-12">
                <label class="form-label fw-medium">Fornecedor</label>
              <div class="input-group">
                <input type="text" class="form-control" id="modal_despesa_fornecedor_nome" 
                       placeholder="Clique para buscar fornecedor..." readonly>
                <input type="hidden" name="id_fornecedor" id="modal_despesa_fornecedor">
                <button type="button" class="btn btn-outline-secondary" onclick="abrirBuscaFornecedor()">
                  <i class="bi bi-search"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="limparFornecedor()" title="Limpar seleção">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-medium">Status</label>
              <select name="status_pagamento" class="form-select" id="modal_despesa_status" required>
                <option value="pendente">Pendente</option>
                <option value="pago">Pago</option>
              </select>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-medium">Forma de Pagamento</label>
              <select name="forma_pagamento" class="form-select" id="modal_despesa_forma" required>
                <option value="débito">Débito</option>
                <option value="crédito">Crédito</option>
                <option value="espécie">Espécie</option>
                <option value="pix">Pix</option>
              </select>
            </div>
            
            <div class="col-12">
                <label class="form-label fw-medium">Pago por</label>
              <input type="text" name="pago_por" class="form-control" id="modal_despesa_pago_por" placeholder="Nome da pessoa que pagou">
            </div>
            
            <div class="col-12">
                <label class="form-label fw-medium">Comprovante</label>
              
              <!-- Comprovante atual (se existir) -->
              <div id="comprovante_atual_info" class="mb-3 d-none">
                <div class="card border-primary">
                  <div class="card-body py-2">
                    <div class="row align-items-center">
                      <div class="col">
                        <div class="d-flex align-items-center">
                          <i class="bi bi-file-earmark-check text-primary me-2"></i>
                          <div>
                            <small class="text-muted d-block">Comprovante anexado:</small>
                            <span class="fw-medium" id="comprovante_atual_nome">arquivo_atual.pdf</span>
                          </div>
                        </div>
                      </div>
                      <div class="col-auto">
                        <div class="btn-group btn-group-sm">
                          <button type="button" class="btn btn-outline-primary" onclick="visualizarComprovante()" title="Visualizar arquivo">
                            <i class="bi bi-eye"></i>
                          </button>
                          <button type="button" class="btn btn-outline-danger" onclick="excluirComprovanteAtual()" title="Remover arquivo">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <input type="file" name="comprovante" class="form-control" id="modal_despesa_comprovante" 
                     accept=".jpg,.jpeg,.png,.pdf,.doc,.docx">
              <input type="hidden" id="comprovante_atual_arquivo" name="comprovante_atual">
              <div class="form-text">
                <small><i class="bi bi-info-circle"></i> Anexe nota fiscal, recibo, comprovante PIX, etc. (máx. 16MB)</small>
                <br><small class="text-muted">Se anexar um novo arquivo, o anterior será substituído automaticamente.</small>
              </div>
            </div>
            
            <!-- Campos de quantidade para despesas de alimentação -->
            <div class="row" id="modal-campos-alimentacao" style="display: none;">
              <div class="col-12 mb-2">
                <div class="alert alert-info alert-sm">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Despesa de Alimentação:</strong> Preencha as informações adicionais abaixo
                </div>
              </div>
              <div class="col-md-6">
                  <label class="form-label fw-medium">Quantidade de Dias</label>
                <div class="input-group">
                  <input type="number" name="qtd_dias" class="form-control" id="modal_qtd_dias" min="1" placeholder="Ex: 5">
                  <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
                </div>
                <div class="form-text">
                  <small class="text-muted">Quantidade de dias que a alimentação deve cobrir</small>
                </div>
              </div>
              <div class="col-md-6">
                  <label class="form-label fw-medium">Quantidade de Pessoas</label>
                <div class="input-group">
                  <input type="number" name="qtd_pessoas" class="form-control" id="modal_qtd_pessoas" min="1" placeholder="Ex: 10">
                  <span class="input-group-text"><i class="bi bi-people"></i></span>
                </div>
                <div class="form-text">
                  <small class="text-muted">Número de pessoas que serão alimentadas</small>
                </div>
              </div>
            </div>
            
            <div class="col-12">
                <label class="form-label fw-medium">Observações</label>
                <textarea name="observacoes" class="form-control" id="modal_despesa_obs" rows="3"></textarea>
            </div>
              
            </div>
          </div>
        <div class="modal-footer border-0 bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-plus-circle me-2"></i>Adicionar Despesa
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Detalhes Receita -->
<div class="modal fade" id="modalDetalhesReceita" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-cash-coin me-2"></i>Detalhes da Receita
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label"><strong>Receita:</strong></label>
            <p id="detalhe_receita_nome" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Data:</strong></label>
            <p id="detalhe_receita_data" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Valor:</strong></label>
            <p id="detalhe_receita_valor" class="form-control-plaintext text-success"></p>
          </div>
          
          <div class="col-12">
            <label class="form-label"><strong>Observações:</strong></label>
            <p id="detalhe_receita_obs" class="form-control-plaintext"></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalhes Despesa -->
<div class="modal fade" id="modalDetalhesDespesa" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="bi bi-credit-card me-2"></i>Detalhes da Despesa
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label"><strong>Despesa:</strong></label>
            <p id="detalhe_despesa_nome" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Data:</strong></label>
            <p id="detalhe_despesa_data" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Valor:</strong></label>
            <p id="detalhe_despesa_valor" class="form-control-plaintext text-danger"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Fornecedor:</strong></label>
            <p id="detalhe_despesa_fornecedor" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Status:</strong></label>
            <p id="detalhe_despesa_status" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Forma de Pagamento:</strong></label>
            <p id="detalhe_despesa_forma" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-md-6">
            <label class="form-label"><strong>Pago Por:</strong></label>
            <p id="detalhe_despesa_pago_por" class="form-control-plaintext"></p>
          </div>
          
          <div class="col-12">
            <label class="form-label"><strong>Observações:</strong></label>
            <p id="detalhe_despesa_obs" class="form-control-plaintext"></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Busca Fornecedor -->
<div class="modal fade" id="modalBuscaFornecedor" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-search me-2"></i>Buscar Fornecedor
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-12">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" id="busca_fornecedor_input" 
                     placeholder="Digite o nome do fornecedor..." onkeyup="buscarFornecedores()">
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Fornecedores da cidade <strong id="cidade_evento_info"></strong> aparecem primeiro
            </small>
          </div>
        </div>
        
        <div id="lista_fornecedores" class="list-group" style="max-height: 400px; overflow-y: auto;">
          <!-- Lista será preenchida via JavaScript -->
        </div>
        
        <div id="loading_fornecedores" class="text-center py-3 d-none">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <span class="ms-2">Buscando fornecedores...</span>
        </div>
        
        <div id="no_fornecedores" class="text-center py-3 d-none">
          <i class="bi bi-exclamation-circle text-muted"></i>
          <p class="text-muted mb-0">Nenhum fornecedor encontrado</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<style>
.form-label {
  font-weight: 500;
  color: #495057;
}

.input-group-text {
  background-color: #f8f9fa;
  border-color: #ced4da;
}

.card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
  background-color: #fff;
  border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.text-primary {
  color: #0d6efd !important;
}

.btn-primary {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.btn-primary:hover {
  background-color: #0b5ed7;
  border-color: #0a58ca;
}

.btn-secondary {
  background-color: #6c757d;
  border-color: #6c757d;
}

.btn-secondary:hover {
  background-color: #5c636a;
  border-color: #565e64;
}

.invalid-feedback {
  font-size: 0.875em;
  color: #dc3545;
}

.form-control:focus,
.form-select:focus {
  border-color: #86b7fe;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.input-group:focus-within {
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.input-group:focus-within .input-group-text {
  border-color: #86b7fe;
}

.input-group:focus-within .form-control {
  border-color: #86b7fe;
}

.input-group:focus-within .form-select {
  border-color: #86b7fe;
}

/* Estilos para tabelas compactas */
.table-compact {
  font-size: 15px; /* Aumentado de 13px para 15px */
}

.table-compact th,
.table-compact td {
  padding: 0.4rem 0.5rem; /* Aumentado ainda mais o padding */
  vertical-align: middle;
  line-height: 1.4; /* Aumentado line-height */
}

.table-compact .form-control,
.table-compact .form-select {
  font-size: 14px; /* Aumentado de 12px para 14px */
  padding: 0.25rem 0.35rem; /* Aumentado padding */
  height: auto;
  min-height: 32px; /* Aumentado de 28px para 32px */
}

.table-compact .btn {
  font-size: 12px; /* Aumentado de 11px para 12px */
  padding: 0.25rem 0.35rem; /* Aumentado padding */
  line-height: 1.3;
}

.table-compact .badge {
  font-size: 11px !important; /* Aumentado de 9px para 11px */
  padding: 0.25rem 0.35rem; /* Aumentado padding */
}

.table-compact strong {
  font-size: 15px; /* Aumentado de 13px para 15px */
}

.table-compact small {
  font-size: 12px; /* Aumentado de 10px para 12px */
}

.table-compact .text-muted {
  font-size: 13px; /* Aumentado de 11px para 13px */
}
</style>

{% block scripts %}
<script>
// Função para formatar valor como moeda
function formatarMoeda(input) {
    var valor = input.value.replace(/\D/g, '');
    if (!valor) {
        input.value = '';
        return;
    }
    valor = parseInt(valor);
    var valorFormatado = (valor / 100).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    input.value = valorFormatado;
}

// Função para obter ID do evento
function obterEventoId() {
    // Tentar obter da URL (para edição)
    var url = window.location.pathname;
    var match = url.match(/\/eventos\/editar\/(\d+)/);
    if (match) {
        return match[1];
    }
    
    // Para novo evento, retornar null
    return null;
}

// Função para salvar evento automaticamente se necessário
function salvarEventoSeNecessario() {
    return new Promise((resolve, reject) => {
        var eventoId = obterEventoId();
        if (eventoId) {
            // Evento já existe, retornar o ID
            resolve(eventoId);
            return;
        }
        
        // Evento novo - precisa salvar primeiro
        var form = document.querySelector('form');
        var formData = new FormData(form);
        
        // Verificar se os campos obrigatórios estão preenchidos
        var nome = formData.get('nome');
        var dataInicio = formData.get('data_inicio');
        var dataFim = formData.get('data_fim');
        
        if (!nome || !dataInicio || !dataFim) {
            reject('Preencha pelo menos o nome e as datas do evento antes de adicionar receitas/despesas.');
            return;
        }
        
        // Salvar o evento via AJAX
        fetch('/eventos/novo', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                // Se houve redirecionamento, extrair o ID da nova URL
                var newUrl = response.url;
                var match = newUrl.match(/\/eventos\/editar\/(\d+)/);
                if (match) {
                    // Redirecionar para a página de edição
                    window.location.href = newUrl;
                    resolve(match[1]);
                } else {
                    reject('Erro ao salvar evento');
                }
            } else {
                reject('Erro ao salvar evento');
            }
        })
        .catch(error => {
            console.error('Erro ao salvar evento:', error);
            reject('Erro ao salvar evento');
        });
    });
}

// Função para converter moeda formatada para número
function converterMoedaParaNumero(valorFormatado) {
    if (!valorFormatado) return 0;
    return parseFloat(valorFormatado.toString().replace(/\./g, '').replace(',', '.'));
}

// Função para abrir modal de receita
function abrirModalReceita(receitaId, categoriaId, nomeReceita, nomeCategoria) {
    // Limpar formulário
    var form = document.querySelector('#modalAdicionarReceita form');
    form.reset();
    
    // Pré-preencher categoria se fornecida
    if (categoriaId) {
        document.getElementById('modal_receita_categoria').value = categoriaId;
        // Carregar receitas da categoria
        carregarReceitasPorCategoriaModal(categoriaId, receitaId);
    }
    
    // Pré-preencher data
    document.getElementById('modal_receita_data').value = '{{ current_date }}';
    
    // Atualizar título do modal
    var titulo = document.querySelector('#modalAdicionarReceita .modal-title');
    if (nomeReceita) {
        titulo.innerHTML = '<i class="bi bi-cash-coin me-2"></i>Cadastrar: ' + nomeReceita;
    } else {
        titulo.innerHTML = '<i class="bi bi-cash-coin me-2"></i>Nova Receita - ' + (nomeCategoria || 'Selecione categoria');
    }
    
    // Abrir modal
    var modal = new bootstrap.Modal(document.getElementById('modalAdicionarReceita'));
    modal.show();
}

// Função para abrir modal de despesa (usando modal unificado)
function abrirModalDespesa(despesaId, categoriaId, nomeDespesa, nomeCategoria, isFixa, valorMedio) {
    const eventoId = obterEventoId();
    
    if (modalDespesaUnificado) {
        // Preparar dados pré-preenchidos
        const dadosPreenchidos = {};
        
        if (categoriaId) {
            dadosPreenchidos.categoria_id = categoriaId;
        }
        
        if (despesaId) {
            dadosPreenchidos.despesa_id = despesaId;
        }
        
        if (valorMedio && valorMedio !== 'null' && valorMedio !== '0.00') {
            dadosPreenchidos.valor = valorMedio;
        }
        
        // Abrir modal unificado
        modalDespesaUnificado.abrirParaAdicionar('novo_evento', eventoId);
        
        // Preencher dados após abrir
        if (Object.keys(dadosPreenchidos).length > 0) {
            setTimeout(() => {
                modalDespesaUnificado.preencherDados(dadosPreenchidos);
            }, 100);
        }
        
        // Atualizar título se necessário
        if (nomeDespesa) {
            setTimeout(() => {
                document.getElementById('modal-title-text').textContent = 'Cadastrar: ' + nomeDespesa + ' (' + (isFixa === 'true' ? 'Fixa' : 'Variável') + ')';
            }, 100);
        }
    }
}

// Função para carregar receitas por categoria no modal
function carregarReceitasPorCategoriaModal(categoriaId, receitaIdSelecionada) {
    var selectReceita = document.getElementById('modal_receita_item');
    
    // Limpar opções
    selectReceita.innerHTML = '<option value="">Carregando...</option>';
    
    if (!categoriaId) {
        selectReceita.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
    return;
  }
  
    // Fazer requisição para buscar receitas da categoria
    fetch(`/api/receitas-por-categoria/${categoriaId}`)
        .then(response => response.json())
        .then(data => {
            selectReceita.innerHTML = '<option value="">Selecione uma receita...</option>';
            
            data.forEach(receita => {
                const option = document.createElement('option');
                option.value = receita.id_receita;
                option.textContent = receita.nome;
                if (receitaIdSelecionada && receita.id_receita == receitaIdSelecionada) {
                    option.selected = true;
                }
                selectReceita.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar receitas:', error);
            selectReceita.innerHTML = '<option value="">Erro ao carregar receitas</option>';
        });
}

// Função para carregar despesas por categoria no modal
function carregarDespesasPorCategoriaModal(categoriaId, despesaIdSelecionada) {
    var selectDespesa = document.getElementById('modal_despesa_item');
    
    // Limpar opções
    selectDespesa.innerHTML = '<option value="">Carregando...</option>';
    
    if (!categoriaId) {
        selectDespesa.innerHTML = '<option value="">Primeiro selecione a categoria...</option>';
    return;
  }
  
    // Fazer requisição para buscar despesas da categoria
    fetch(`/api/despesas-por-categoria/${categoriaId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            selectDespesa.innerHTML = '<option value="">Selecione uma despesa...</option>';
            
            if (data.length === 0) {
                selectDespesa.innerHTML = '<option value="">Nenhuma despesa encontrada para esta categoria</option>';
    return;
  }
  
            data.forEach(despesa => {
                const option = document.createElement('option');
                option.value = despesa.id_despesa;
                option.textContent = despesa.nome;
                if (despesaIdSelecionada && despesa.id_despesa == despesaIdSelecionada) {
                    option.selected = true;
                }
                if (despesa.valor_medio) {
                    option.setAttribute('data-valor-medio', despesa.valor_medio.toFixed(2).replace('.', ','));
                }
                selectDespesa.appendChild(option);
            });
            
            // Se uma despesa foi pré-selecionada, verificar se é de alimentação
            if (despesaIdSelecionada) {
                // Usar setTimeout para garantir que o DOM foi atualizado
                setTimeout(() => {
                    verificarDespesaAlimentacaoModal();
                }, 100);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar despesas:', error);
            selectDespesa.innerHTML = '<option value="">Erro ao carregar despesas</option>';
        });
}

// Funções de valor médio removidas - agora gerenciadas pelo arquivo valor-medio-despesas.js



// Função para verificar se a despesa selecionada no modal é de alimentação
function verificarDespesaAlimentacaoModal() {
    console.log('🔍 === INICIANDO VERIFICAÇÃO MODAL ===');
    
    const despesaSelect = document.getElementById('modal_despesa_item');
    const camposAlimentacao = document.getElementById('modal-campos-alimentacao');
    const qtdDiasInput = document.getElementById('modal_qtd_dias');
    const qtdPessoasInput = document.getElementById('modal_qtd_pessoas');
    
    console.log('📋 Elementos encontrados:', {
        despesaSelect: !!despesaSelect,
        camposAlimentacao: !!camposAlimentacao,
        qtdDiasInput: !!qtdDiasInput,
        qtdPessoasInput: !!qtdPessoasInput
    });
    
    const despesaId = despesaSelect ? despesaSelect.value : 'ELEMENTO_NAO_ENCONTRADO';
    console.log('🎯 Despesa ID selecionada:', despesaId);
    
    if (despesaId && despesaId != '0') {
        console.log('🔄 Fazendo requisição para API...');
        
        // Buscar informações da despesa selecionada
        fetch(`/api/despesa-detalhes/${despesaId}`)
            .then(response => {
                console.log('📡 Resposta da API recebida:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('📊 Dados da API:', data);
                
                if (data.flag_alimentacao) {
                    console.log('✅ É despesa de alimentação! Mostrando campos...');
                    
                    // Mostrar campos de quantidade
                    if (camposAlimentacao) {
                        console.log('🟡 Aplicando estilo ao elemento modal-campos-alimentacao...');
                        camposAlimentacao.style.display = 'block';
                        camposAlimentacao.style.backgroundColor = '#ffffcc'; // Destaque amarelo para debug
                        camposAlimentacao.style.border = '2px solid #ffc107'; // Borda amarela visível
                        camposAlimentacao.style.padding = '15px'; // Padding para visibilidade
                        camposAlimentacao.style.marginTop = '10px'; // Margem
                        console.log('✅ Campos exibidos com destaque AMARELO');
                        console.log('🔍 Estado atual do elemento:', {
                            display: camposAlimentacao.style.display,
                            backgroundColor: camposAlimentacao.style.backgroundColor,
                            visibility: getComputedStyle(camposAlimentacao).visibility
                        });
                    } else {
                        console.error('❌ Elemento modal-campos-alimentacao não encontrado!');
                    }
                    
                    // Tornar campos obrigatórios
                    if (qtdDiasInput) {
                        qtdDiasInput.setAttribute('required', 'required');
                        console.log('✅ Campo qtd_dias marcado como obrigatório');
                    }
                    if (qtdPessoasInput) {
                        qtdPessoasInput.setAttribute('required', 'required');
                        console.log('✅ Campo qtd_pessoas marcado como obrigatório');
                    }
                } else {
                    console.log('❌ NÃO é despesa de alimentação. Escondendo campos...');
                    
                    // Esconder campos de quantidade
                    if (camposAlimentacao) {
                        camposAlimentacao.style.display = 'none';
                    }
                    
                    // Remover obrigatoriedade e limpar valores
                    if (qtdDiasInput) {
                        qtdDiasInput.removeAttribute('required');
                        qtdDiasInput.value = '';
                    }
                    if (qtdPessoasInput) {
                        qtdPessoasInput.removeAttribute('required');
                        qtdPessoasInput.value = '';
                    }
                }
            })
            .catch(error => {
                console.error('❌ Erro ao verificar despesa:', error);
                
                // Em caso de erro, esconder campos
                if (camposAlimentacao) {
                    camposAlimentacao.style.display = 'none';
                }
                if (qtdDiasInput) qtdDiasInput.removeAttribute('required');
                if (qtdPessoasInput) qtdPessoasInput.removeAttribute('required');
            });
    } else {
        console.log('⚠️ Nenhuma despesa selecionada ou despesa inválida. Escondendo campos...');
        
        // Nenhuma despesa selecionada, esconder campos
        if (camposAlimentacao) {
            camposAlimentacao.style.display = 'none';
        }
        if (qtdDiasInput) {
            qtdDiasInput.removeAttribute('required');
            qtdDiasInput.value = '';
        }
        if (qtdPessoasInput) {
            qtdPessoasInput.removeAttribute('required');
            qtdPessoasInput.value = '';
        }
    }
    
    console.log('🏁 === FIM DA VERIFICAÇÃO MODAL ===');
}

// Função para adicionar receita do evento
function adicionarReceitaEvento(event) {
    event.preventDefault();
    
    var form = event.target;
    var formData = new FormData(form);
    
    // Converter valor formatado para número
    var valorFormatado = formData.get('valor');
    var valorNumerico = converterMoedaParaNumero(valorFormatado);
    
    // Preparar dados para envio
    var dados = {
        receita_id: parseInt(formData.get('receita_id')),
        data: formData.get('data'),
        valor: valorNumerico.toString(),
        observacoes: formData.get('observacoes') || ''
    };
    
    // Desabilitar botão durante envio
    var submitBtn = form.querySelector('button[type="submit"]');
    var originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>Adicionando...';
    
    // Salvar evento primeiro se necessário
    salvarEventoSeNecessario()
        .then(eventoId => {
            return fetch(`/eventos/${eventoId}/salvar-receita`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
                body: JSON.stringify(dados)
            });
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
                // Fechar modal
                var modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                modal.hide();
                
                // Recarregar a página
                window.location.reload();
    } else {
      alert('Erro: ' + result.message);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
            alert('Erro ao adicionar receita: ' + error);
        })
        .finally(() => {
            // Reabilitar botão
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
}

// Função para adicionar despesa do evento
function adicionarDespesaEvento(event) {
    event.preventDefault();
    
    var form = event.target;
    var formData = new FormData(form);
    
    // Verificar se é edição ou nova despesa
    const isEditing = form.getAttribute('data-editing') === 'true';
    const despesaEventoId = form.getAttribute('data-despesa-evento-id');
    
    if (isEditing) {
        // Lógica de edição
        editarDespesaEvento(form, despesaEventoId);
        return;
    }
    
    // Desabilitar botão durante envio
    var submitBtn = form.querySelector('button[type="submit"]');
    var originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>Adicionando...';
    
    // Salvar evento primeiro se necessário
    salvarEventoSeNecessario()
        .then(eventoId => {
            // Usar FormData diretamente para suporte a arquivos
            return fetch(`/eventos/${eventoId}/salvar-despesa`, {
                method: 'POST',
                body: formData  // FormData já inclui o arquivo e outros dados
            });
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Fechar modal
                var modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                modal.hide();
                
                // Recarregar a página
                window.location.reload();
            } else {
                alert('Erro: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao adicionar despesa: ' + error);
        })
        .finally(() => {
            // Reabilitar botão
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
}

// Função para salvar receita individual
function salvarReceita(receitaId) {
    var data = document.getElementById('receita_data_' + receitaId).value;
    var valor = document.getElementById('receita_valor_' + receitaId).value;
    var observacoes = document.getElementById('receita_obs_' + receitaId).value;
    
    if (!data || !valor) {
        alert('Data e valor são obrigatórios!');
        return;
    }
    
    // Salvar evento primeiro se necessário
    salvarEventoSeNecessario()
        .then(eventoId => {
            var dados = {
                receita_id: receitaId,
                data: data,
                valor: valor,
                observacoes: observacoes
            };
            
            return fetch('/eventos/' + eventoId + '/salvar-receita', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dados)
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mudar a cor da linha para verde
                var linha = document.getElementById('receita_row_' + receitaId);
                linha.className = 'table-success';
                
                // Criar objeto com os dados da receita para passar para a função
                var dadosReceita = {
                    data: document.getElementById('receita_data_' + receitaId).value,
                    valor: document.getElementById('receita_valor_' + receitaId).value,
                    observacoes: document.getElementById('receita_obs_' + receitaId).value
                };
                
                // Esconder campos de entrada e mostrar valores
                esconderCamposReceita(receitaId, data.receita_nome, dadosReceita.data, dadosReceita.valor, dadosReceita.observacoes);
                
                // Trocar botões: esconder salvar, mostrar editar
                var btnSalvar = linha.querySelector('.btn-success');
                var btnEditar = linha.querySelector('.btn-outline-primary');
                btnSalvar.style.display = 'none';
                btnEditar.style.display = 'inline-block';
            } else {
                alert('Erro ao salvar receita: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro: ' + error);
        });
}

// Função para esconder campos da receita e mostrar valores
function esconderCamposReceita(receitaId, nome, data, valor, obs) {
    var linha = document.getElementById('receita_row_' + receitaId);
    var cells = linha.querySelectorAll('td');
    
    // Data
    cells[1].innerHTML = '<small>' + formatarDataBR(data) + '</small>';
    
    // Valor
    cells[2].innerHTML = '<small>R$ ' + valor + '</small>';
    
    // Observações
    cells[3].innerHTML = '<small>' + (obs || '-') + '</small>';
}

// Função para editar receita
function editarReceita(receitaId) {
    var linha = document.getElementById('receita_row_' + receitaId);
    var cells = linha.querySelectorAll('td');
    
    // Restaurar campos de entrada
    cells[1].innerHTML = '<input type="date" class="form-control form-control-sm" id="receita_data_' + receitaId + '" style="font-size: 11px;">';
    cells[2].innerHTML = '<input type="text" class="form-control form-control-sm" id="receita_valor_' + receitaId + '" placeholder="0,00" oninput="formatarMoeda(this)" style="font-size: 11px;">';
    cells[3].innerHTML = '<input type="text" class="form-control form-control-sm" id="receita_obs_' + receitaId + '" placeholder="Observações" style="font-size: 11px;">';
    
    // Trocar botões: esconder editar, mostrar salvar
    var btnSalvar = linha.querySelector('.btn-success');
    var btnEditar = linha.querySelector('.btn-outline-primary');
    btnSalvar.style.display = 'inline-block';
    btnEditar.style.display = 'none';
    
    // Voltar cor para cinza
    linha.className = 'table-light';
}

// Função para salvar despesa individual
function salvarDespesa(despesaId, isFixa) {
    var data = document.getElementById('despesa_data_vencimento_' + despesaId).value;
    var valor = document.getElementById('despesa_valor_' + despesaId).value;
    var valorPagoSocrates = document.getElementById('despesa_valor_pago_socrates_' + despesaId).value;
    var fornecedor = document.getElementById('despesa_fornecedor_' + despesaId).value;
    var status = document.getElementById('despesa_status_' + despesaId).value;
    var forma = document.getElementById('despesa_forma_' + despesaId).value;
    var pagoPor = document.getElementById('despesa_pago_por_' + despesaId).value;
    var observacoes = document.getElementById('despesa_obs_' + despesaId).value;
    var despesaCabeca = document.getElementById('despesa_cabeca_' + despesaId).checked;
    
    if (!data || !valor) {
        alert('Data e valor são obrigatórios!');
    return;
  }
  
    // Salvar evento primeiro se necessário
    salvarEventoSeNecessario()
        .then(eventoId => {
            var dados = {
    despesa_id: despesaId,
                data: data,
                valor: valor,
                valor_pago_socrates: valorPagoSocrates,
                id_fornecedor: fornecedor || null,
                status_pagamento: status,
                forma_pagamento: forma,
                pago_por: pagoPor,
                observacoes: observacoes,
                is_fixa: isFixa,
                despesa_cabeca: despesaCabeca
            };
            
            return fetch('/eventos/' + eventoId + '/salvar-despesa', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
                body: JSON.stringify(dados)
            });
  })
  .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mudar a cor da linha
                var linha = document.getElementById('despesa_row_' + despesaId);
                if (isFixa) {
                    linha.className = 'table-primary'; // Azul para fixas já cadastradas
                } else {
                    linha.className = 'table-success'; // Verde para variáveis cadastradas
                }
                
                // Criar objeto com os dados da despesa para passar para a função
                var dadosDespesa = {
                    data_vencimento: document.getElementById('despesa_data_vencimento_' + despesaId).value,
                    valor: document.getElementById('despesa_valor_' + despesaId).value,
                    status_pagamento: document.getElementById('despesa_status_' + despesaId).value,
                    forma_pagamento: document.getElementById('despesa_forma_' + despesaId).value,
                    pago_por: document.getElementById('despesa_pago_por_' + despesaId).value,
                    observacoes: document.getElementById('despesa_obs_' + despesaId).value
                };
                
                // Esconder campos e mostrar valores
                esconderCamposDespesa(despesaId, dadosDespesa);
                
                console.log('Despesa salva:', data);
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro: ' + error);
        });
}

// Função para esconder campos da despesa e mostrar valores
function esconderCamposDespesa(despesaId, dadosDespesa, fornecedorNome) {
    var linha = document.getElementById('despesa_row_' + despesaId);
    var displays = linha.querySelectorAll('.despesa-display');
    var edits = linha.querySelectorAll('.despesa-edit');
    
    // Esconder campos de edição
    edits.forEach(function(edit) {
        edit.classList.add('d-none');
    });
    
    // Mostrar e atualizar displays
    displays.forEach(function(display) {
        display.classList.remove('d-none');
    });
    
    // Atualizar conteúdo dos displays
    var cells = linha.querySelectorAll('td');
    
    // Data (índice 1)
    cells[1].querySelector('.despesa-display').innerHTML = formatarDataBR(dadosDespesa.data_vencimento);
    
    // Valor Real (índice 2)
    cells[2].querySelector('.despesa-display').innerHTML = 'R$ ' + dadosDespesa.valor;
    
    // Valor Pago SO (índice 3)
    cells[3].querySelector('.despesa-display').innerHTML = dadosDespesa.valor_pago_socrates ? 
        'R$ ' + dadosDespesa.valor_pago_socrates : '<span class="text-muted">-</span>';
    
    // Status (índice 4)
    var statusBadge = dadosDespesa.status_pagamento === 'pago' ? 'success' : 'warning';
    cells[4].querySelector('.despesa-display').innerHTML = 
        '<span class="badge bg-' + statusBadge + '" style="font-size: 10px;">' + 
        dadosDespesa.status_pagamento.charAt(0).toUpperCase() + dadosDespesa.status_pagamento.slice(1) + '</span>';
    
    // Despesa da Cabeça (índice 5)
    var despesaCabecaCheckbox = cells[5].querySelector('.despesa-display input[type="checkbox"]');
    despesaCabecaCheckbox.checked = dadosDespesa.despesa_cabeca;
    
    // Observações (índice 6)
    cells[6].querySelector('.despesa-display').innerHTML = dadosDespesa.observacoes || '-';
}

// Função para formatar data para formato brasileiro
function formatarDataBR(dataISO) {
    if (!dataISO) return '-';
    var parts = dataISO.split('-');
    return parts[2] + '/' + parts[1] + '/' + parts[0];
}

// Função para editar despesa fixa
function editarDespesaFixa(despesaId) {
    var linha = document.getElementById('despesa_row_' + despesaId);
    
    // Esconder elementos de display e mostrar campos de edição
    var displays = linha.querySelectorAll('.despesa-display');
    var edits = linha.querySelectorAll('.despesa-edit');
    
    displays.forEach(function(display) {
        display.classList.add('d-none');
    });
    
    edits.forEach(function(edit) {
        edit.classList.remove('d-none');
    });
    
    // Trocar botões: esconder editar, mostrar salvar
    var btnEditar = linha.querySelector('.despesa-btn-editar');
    var btnSalvar = linha.querySelector('.despesa-btn-salvar');
    btnEditar.classList.add('d-none');
    btnSalvar.classList.remove('d-none');
    
    // ✅ CONFIGURAR VALIDAÇÃO EM TEMPO REAL PARA EDIÇÃO INLINE
    const valorInput = document.getElementById('despesa_valor_' + despesaId);
    if (valorInput && typeof buscarValorMedio === 'function' && typeof validarVariacaoValorMedioInput === 'function') {
        // Buscar valor médio e configurar validação
        buscarValorMedio(despesaId).then(response => {
            if (response.success && response.valor_medio) {
                // Armazenar valor médio
                valorInput.dataset.valorMedio = response.valor_medio;
                
                // Aplicar validação inicial
                validarVariacaoValorMedioInput(valorInput, response.valor_medio);
                
                // Remover listeners anteriores
                const novoInput = valorInput.cloneNode(true);
                valorInput.parentNode.replaceChild(novoInput, valorInput);
                
                // Adicionar listener para validação em tempo real
                novoInput.addEventListener('input', function() {
                    const valorMedio = parseFloat(this.dataset.valorMedio);
                    if (valorMedio) {
                        validarVariacaoValorMedioInput(this, valorMedio);
                    }
                });
                
                console.log('✅ Validação em tempo real configurada para edição inline fixa');
            }
        }).catch(error => {
            console.log('ℹ️ Erro ao configurar validação inline fixa:', error);
        });
    }
}

// Função para editar despesa variável
function editarDespesaVariavel(despesaId) {
    var linha = document.getElementById('despesa_row_' + despesaId);
    
    // Mostrar campos de edição e esconder displays
    var displays = linha.querySelectorAll('.despesa-display');
    var edits = linha.querySelectorAll('.despesa-edit');
    
    displays.forEach(function(display) {
        display.classList.add('d-none');
    });
    
    edits.forEach(function(edit) {
        edit.classList.remove('d-none');
    });
    
    // Trocar botões: esconder editar, mostrar salvar
    var btnEditar = linha.querySelector('.despesa-btn-editar');
    var btnSalvar = linha.querySelector('.despesa-btn-salvar');
    btnEditar.classList.add('d-none');
    btnSalvar.classList.remove('d-none');
    
    // ✅ CONFIGURAR VALIDAÇÃO EM TEMPO REAL PARA EDIÇÃO INLINE
    const valorInput = document.getElementById('despesa_valor_' + despesaId);
    if (valorInput && typeof buscarValorMedio === 'function' && typeof validarVariacaoValorMedioInput === 'function') {
        // Buscar valor médio e configurar validação
        buscarValorMedio(despesaId).then(response => {
            if (response.success && response.valor_medio) {
                // Armazenar valor médio
                valorInput.dataset.valorMedio = response.valor_medio;
                
                // Aplicar validação inicial
                validarVariacaoValorMedioInput(valorInput, response.valor_medio);
                
                // Remover listeners anteriores
                const novoInput = valorInput.cloneNode(true);
                valorInput.parentNode.replaceChild(novoInput, valorInput);
                
                // Adicionar listener para validação em tempo real
                novoInput.addEventListener('input', function() {
                    const valorMedio = parseFloat(this.dataset.valorMedio);
                    if (valorMedio) {
                        validarVariacaoValorMedioInput(this, valorMedio);
                    }
                });
                
                console.log('✅ Validação em tempo real configurada para edição inline variável');
            }
        }).catch(error => {
            console.log('ℹ️ Erro ao configurar validação inline variável:', error);
        });
    }
    
    // Voltar cor para cinza
    linha.className = 'table-light';
}

// Função para excluir receita
function excluirReceita(receitaEventoId) {
    if (confirm('Tem certeza que deseja excluir esta receita?')) {
        var eventoId = obterEventoId();
        if (!eventoId) {
            alert('Erro: Não foi possível identificar o evento');
            return;
        }
        
        fetch('/eventos/' + eventoId + '/excluir-receita/' + receitaEventoId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Receita excluída com sucesso!');
                // Recarregar a página para atualizar a lista
                window.location.reload();
            } else {
                alert('Erro ao excluir receita: ' + data.message);
    }
  })
  .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir receita: ' + error);
        });
    }
}

// Função para excluir despesa
function excluirDespesa(despesaEventoId) {
    if (confirm('Tem certeza que deseja excluir esta despesa?')) {
        var eventoId = obterEventoId();
        if (!eventoId) {
            alert('Erro: Não foi possível identificar o evento');
            return;
        }
        
        fetch('/eventos/' + eventoId + '/excluir-despesa/' + despesaEventoId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Despesa excluída com sucesso!');
                // Recarregar a página para atualizar a lista
                window.location.reload();
            } else {
                alert('Erro ao excluir despesa: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir despesa: ' + error);
        });
    }
}

// Função para editar receita já salva
function editarReceitaSalva(receitaEventoId) {
    var linha = document.getElementById('receita_salva_row_' + receitaEventoId);
    
    // Esconder elementos de display e mostrar campos de edição
    var displays = linha.querySelectorAll('.receita-display');
    var edits = linha.querySelectorAll('.receita-edit');
    
    displays.forEach(function(display) {
        display.classList.add('d-none');
    });
    
    edits.forEach(function(edit) {
        edit.classList.remove('d-none');
    });
    
    // Trocar botões: esconder editar, mostrar salvar
    var btnEditar = linha.querySelector('.receita-btn-editar');
    var btnSalvar = linha.querySelector('.receita-btn-salvar');
    btnSalvar.classList.add('d-none');
    btnEditar.classList.remove('d-none');
}

// Função para salvar receita já cadastrada (edição)
function salvarReceitaSalva(receitaEventoId) {
    var eventoId = obterEventoId();
  if (!eventoId) {
        alert('Erro: Não foi possível identificar o evento');
    return;
  }
  
    // Coletar dados dos campos de edição
    var data = document.getElementById('receita_salva_data_' + receitaEventoId).value;
    var valor = document.getElementById('receita_salva_valor_' + receitaEventoId).value;
    var observacoes = document.getElementById('receita_salva_obs_' + receitaEventoId).value;
    
    if (!data || !valor) {
        alert('Data e valor são obrigatórios');
    return;
  }
  
    // Preparar dados para envio
    var dadosReceita = {
    data: data,
    valor: valor,
        observacoes: observacoes
    };
    
    // Enviar para o backend (usando endpoint de atualização)
    fetch('/eventos/' + eventoId + '/atualizar-receita/' + receitaEventoId, {
        method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
        body: JSON.stringify(dadosReceita)
  })
  .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Receita atualizada com sucesso!');
            
            // Esconder campos e mostrar valores atualizados
            esconderCamposReceita(receitaEventoId, dadosReceita);
            
            // Trocar botões: esconder salvar, mostrar editar
            var linha = document.getElementById('receita_salva_row_' + receitaEventoId);
            var btnSalvar = linha.querySelector('.receita-btn-salvar');
            var btnEditar = linha.querySelector('.receita-btn-editar');
            btnSalvar.classList.add('d-none');
            btnEditar.classList.remove('d-none');
    } else {
            alert('Erro ao atualizar receita: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Erro:', error);
        alert('Erro: ' + error);
    });
}

// Função para esconder campos da receita e mostrar valores
function esconderCamposReceita(receitaEventoId, dadosReceita) {
    var linha = document.getElementById('receita_salva_row_' + receitaEventoId);
    var displays = linha.querySelectorAll('.receita-display');
    var edits = linha.querySelectorAll('.receita-edit');
    
    // Esconder campos de edição
    edits.forEach(function(edit) {
        edit.classList.add('d-none');
    });
    
    // Mostrar e atualizar displays
    displays.forEach(function(display) {
        display.classList.remove('d-none');
    });
    
    // Atualizar conteúdo dos displays
    var cells = linha.querySelectorAll('td');
    
    // Data (índice 0)
    cells[0].querySelector('.receita-display').innerHTML = formatarDataBR(dadosReceita.data);
    
    // Valor (índice 3)
    cells[3].querySelector('.receita-display').innerHTML = 'R$ ' + dadosReceita.valor;
    
    // Observações (índice 4)
    cells[4].querySelector('.receita-display').innerHTML = dadosReceita.observacoes || '-';
}

// Validação de formulário
document.addEventListener('DOMContentLoaded', function() {
    
    // Event listeners para mudanças nas categorias dos modais
    var modalReceitaCategoria = document.getElementById('modal_receita_categoria');
    var modalDespesaCategoria = document.getElementById('modal_despesa_categoria');
    
    if (modalReceitaCategoria) {
        modalReceitaCategoria.addEventListener('change', function() {
            carregarReceitasPorCategoriaModal(this.value);
        });
    }
    
    if (modalDespesaCategoria) {
        modalDespesaCategoria.addEventListener('change', function() {
            carregarDespesasPorCategoriaModal(this.value);
            // Limpar campo de valor quando trocar categoria
            const inputValor = document.getElementById('modal_despesa_valor');
            if (inputValor) {
                inputValor.value = '';
                inputValor.placeholder = '0,00';
            }
        });
    }
    
    // Event listener para verificar despesa de alimentação quando item for selecionado
    var modalDespesaItem = document.getElementById('modal_despesa_item');
    console.log('🎯 Configurando event listener para modal_despesa_item:', !!modalDespesaItem);
    
    if (modalDespesaItem) {
        modalDespesaItem.addEventListener('change', function() {
            console.log('🔄 Event listener DISPARADO - Valor selecionado:', this.value);
            console.log('🔄 Chamando verificarDespesaAlimentacaoModal...');
            verificarDespesaAlimentacaoModal();
            
            // A validação de valor médio é gerenciada pelo arquivo valor-medio-despesas.js
        });
        console.log('✅ Event listener configurado com sucesso!');
        

    } else {
        console.error('❌ Elemento modal_despesa_item NÃO ENCONTRADO!');
    }
    
    var forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
            form.classList.add('was-validated');
        }, false);
    });
});

// Função para ver detalhes da receita
function verDetalhesReceita(receitaEventoId, nome, data, valor, observacoes) {
    document.getElementById('detalhe_receita_nome').textContent = nome;
    document.getElementById('detalhe_receita_data').textContent = data;
    document.getElementById('detalhe_receita_valor').textContent = 'R$ ' + valor;
    document.getElementById('detalhe_receita_obs').textContent = observacoes || 'Sem observações';
    
    var modal = new bootstrap.Modal(document.getElementById('modalDetalhesReceita'));
    modal.show();
}

// Função para ver detalhes da despesa
function verDetalhesDespesa(despesaId, nome, data, valor, fornecedor, status, forma, pagoPor, observacoes, tipo) {
    document.getElementById('detalhe_despesa_nome').textContent = nome + ' (' + tipo + ')';
    document.getElementById('detalhe_despesa_data').textContent = data;
    document.getElementById('detalhe_despesa_valor').textContent = 'R$ ' + valor;
    document.getElementById('detalhe_despesa_fornecedor').textContent = fornecedor || 'Não informado';
    
    // Status com badge
    var statusBadge = status === 'pago' ? 
        '<span class="badge bg-success">Pago</span>' : 
        '<span class="badge bg-warning">Pendente</span>';
    document.getElementById('detalhe_despesa_status').innerHTML = statusBadge;
    
    document.getElementById('detalhe_despesa_forma').textContent = forma ? forma.charAt(0).toUpperCase() + forma.slice(1) : 'Não informado';
    document.getElementById('detalhe_despesa_pago_por').textContent = pagoPor || 'Não informado';
    document.getElementById('detalhe_despesa_obs').textContent = observacoes || 'Sem observações';
    
    var modal = new bootstrap.Modal(document.getElementById('modalDetalhesDespesa'));
    modal.show();
}

// Funções para busca de fornecedores
function abrirBuscaFornecedor() {
    // Obter cidade e estado do evento
    const cidade = document.getElementById('cidade').value;
    const estado = document.getElementById('estado').value;
    
    // Atualizar informação da cidade no modal
    document.getElementById('cidade_evento_info').textContent = cidade && estado ? `${cidade}/${estado}` : 'do evento';
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalBuscaFornecedor'));
    modal.show();
    
    // Carregar fornecedores iniciais
    buscarFornecedores();
    
    // Focar no campo de busca
    setTimeout(() => {
        document.getElementById('busca_fornecedor_input').focus();
    }, 500);
}

function buscarFornecedores() {
    const termoBusca = document.getElementById('busca_fornecedor_input').value;
    const cidade = document.getElementById('cidade').value;
    const estado = document.getElementById('estado').value;
    
    // Mostrar loading
    document.getElementById('loading_fornecedores').classList.remove('d-none');
    document.getElementById('lista_fornecedores').classList.add('d-none');
    document.getElementById('no_fornecedores').classList.add('d-none');
    
    // Construir URL da API
    const params = new URLSearchParams();
    if (termoBusca) params.append('q', termoBusca);
    if (cidade) params.append('cidade', cidade);
    if (estado) params.append('estado', estado);
    
    fetch(`/api/fornecedores-busca?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            // Esconder loading
            document.getElementById('loading_fornecedores').classList.add('d-none');
            
            if (data.success && data.fornecedores.length > 0) {
                exibirListaFornecedores(data.fornecedores);
        } else {
                document.getElementById('no_fornecedores').classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Erro ao buscar fornecedores:', error);
            document.getElementById('loading_fornecedores').classList.add('d-none');
            document.getElementById('no_fornecedores').classList.remove('d-none');
        });
}

function exibirListaFornecedores(fornecedores) {
    const lista = document.getElementById('lista_fornecedores');
    lista.innerHTML = '';
    
    fornecedores.forEach(fornecedor => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.style.cursor = 'pointer';
        
        // Destacar fornecedores locais
        if (fornecedor.is_local) {
            item.classList.add('list-group-item-success');
        }
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">
                        ${fornecedor.nome}
                        ${fornecedor.is_local ? '<span class="badge bg-success ms-2">Local</span>' : ''}
                    </h6>
                    <p class="mb-1 text-muted small">
                        ${fornecedor.categoria ? `Categoria: ${fornecedor.categoria}` : ''}
                    </p>
                    <small class="text-muted">
                        ${fornecedor.cidade && fornecedor.estado ? `${fornecedor.cidade}/${fornecedor.estado}` : 'Localização não informada'}
                        ${fornecedor.telefone ? ` • Tel: ${fornecedor.telefone}` : ''}
                    </small>
                </div>
            </div>
        `;
        
        item.onclick = () => selecionarFornecedor(fornecedor);
        lista.appendChild(item);
    });
    
    lista.classList.remove('d-none');
}

function selecionarFornecedor(fornecedor) {
    // Preencher campos
    document.getElementById('modal_despesa_fornecedor').value = fornecedor.id;
    document.getElementById('modal_despesa_fornecedor_nome').value = fornecedor.nome;
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalBuscaFornecedor'));
    modal.hide();
    
    // Limpar busca
    document.getElementById('busca_fornecedor_input').value = '';
}

function limparFornecedor() {
    document.getElementById('modal_despesa_fornecedor').value = '';
    document.getElementById('modal_despesa_fornecedor_nome').value = '';
}

// Adicionar evento de clique no campo de fornecedor
document.addEventListener('DOMContentLoaded', function() {
    const campoFornecedor = document.getElementById('modal_despesa_fornecedor_nome');
    if (campoFornecedor) {
        campoFornecedor.addEventListener('click', abrirBuscaFornecedor);
    }
});

// Função para editar despesa via modal
function editarDespesaModal(button) {
    // Obter dados do botão
    const despesaEventoId = button.getAttribute('data-despesa-evento-id');
    const despesaId = button.getAttribute('data-despesa-id');
    const categoriaId = button.getAttribute('data-categoria-id');
    const nome = button.getAttribute('data-nome');
    const categoriaNome = button.getAttribute('data-categoria-nome');
    const isFixa = button.getAttribute('data-is-fixa') === 'true';
    const data = button.getAttribute('data-data');
    const valor = button.getAttribute('data-valor');
    const valorPagoSocrates = button.getAttribute('data-valor-pago-socrates');
    const fornecedor = button.getAttribute('data-fornecedor');
    const fornecedorId = button.getAttribute('data-fornecedor-id');
    const status = button.getAttribute('data-status');
    const forma = button.getAttribute('data-forma');
    const pagoPor = button.getAttribute('data-pago-por');
    const obs = button.getAttribute('data-obs');
    const despesaCabeca = button.getAttribute('data-despesa-cabeca') === 'True';
    
    // Debug logs
    console.log('=== DEBUG MODAL EDIÇÃO ===');
    console.log('Despesa Evento ID:', despesaEventoId);
    console.log('Despesa ID:', despesaId);
    console.log('Categoria ID:', categoriaId);
    console.log('Nome:', nome);
    console.log('Categoria Nome:', categoriaNome);
    console.log('É Fixa:', isFixa);
    console.log('Data:', data);
    console.log('Valor:', valor);
    console.log('Valor Pago Sócrates:', valorPagoSocrates);
    console.log('Fornecedor:', fornecedor);
    console.log('Fornecedor ID:', fornecedorId);
    console.log('Status:', status);
    console.log('Forma:', forma);
    console.log('Pago Por:', pagoPor);
    console.log('Obs:', obs);
    console.log('Despesa da Cabeça:', despesaCabeca);
    console.log('Valor bruto do atributo:', button.getAttribute('data-despesa-cabeca'));
    
    // Limpar formulário
    const form = document.querySelector('#modalAdicionarDespesa form');
    form.reset();
    
    // Preencher dados no modal
    document.getElementById('modal_despesa_categoria').value = categoriaId;
    document.getElementById('modal_despesa_data_vencimento').value = data;
    document.getElementById('modal_despesa_valor').value = valor ? valor.replace('.', ',') : '';
    document.getElementById('modal_despesa_valor_pago_socrates').value = valorPagoSocrates ? valorPagoSocrates.replace('.', ',') : '';
    document.getElementById('modal_despesa_fornecedor_nome').value = fornecedor || '';
    document.getElementById('modal_despesa_fornecedor').value = fornecedorId || '';
    document.getElementById('modal_despesa_status').value = status || 'pendente';
    document.getElementById('modal_despesa_forma').value = forma || 'débito';
    document.getElementById('modal_despesa_pago_por').value = pagoPor || '';
    document.getElementById('modal_despesa_obs').value = obs || '';
    
    // Preencher campos de quantidade se existirem
    const qtdDias = button.getAttribute('data-qtd-dias');
    const qtdPessoas = button.getAttribute('data-qtd-pessoas');
    
    console.log('Qtd Dias:', qtdDias);
    console.log('Qtd Pessoas:', qtdPessoas);
    console.log('Despesa da Cabeça:', despesaCabeca);
    
    // Preencher campos de quantidade
    document.getElementById('modal_qtd_dias').value = qtdDias || '';
    document.getElementById('modal_qtd_pessoas').value = qtdPessoas || '';
    
    // Preencher campo despesa da cabeça
    document.getElementById('despesa_cabeca_novo_evento').checked = despesaCabeca;
    console.log('✅ Campo despesa_cabeca_novo_evento marcado como:', despesaCabeca);
    
    // Verificar se deve mostrar campos de alimentação
    // Se já temos valores de quantidade, mostrar os campos imediatamente
    if ((qtdDias && qtdDias.trim() !== '') || (qtdPessoas && qtdPessoas.trim() !== '')) {
        console.log('🟡 Despesa já tem valores de alimentação, mostrando campos...');
        const camposAlimentacao = document.getElementById('modal-campos-alimentacao');
        if (camposAlimentacao) {
            camposAlimentacao.style.display = 'block';
            camposAlimentacao.style.backgroundColor = '#ffffcc';
            camposAlimentacao.style.border = '2px solid #ffc107';
            camposAlimentacao.style.padding = '15px';
            camposAlimentacao.style.marginTop = '10px';
            
            // Tornar campos obrigatórios
            const qtdDiasInput = document.getElementById('modal_qtd_dias');
            const qtdPessoasInput = document.getElementById('modal_qtd_pessoas');
            if (qtdDiasInput) qtdDiasInput.setAttribute('required', 'required');
            if (qtdPessoasInput) qtdPessoasInput.setAttribute('required', 'required');
            
            console.log('✅ Campos de alimentação exibidos para edição');
        }
    }
    
    // Limpar campo de comprovante e exibir comprovante atual se existir
    const comprovanteField = document.getElementById('modal_despesa_comprovante');
    if (comprovanteField) {
        comprovanteField.value = '';
    }
    
    // Verificar se há comprovante atual e exibir informações
    const comprovanteAtual = button.getAttribute('data-comprovante');
    const comprovanteInfo = document.getElementById('comprovante_atual_info');
    const comprovanteNome = document.getElementById('comprovante_atual_nome');
    const comprovanteArquivo = document.getElementById('comprovante_atual_arquivo');
    
    if (comprovanteAtual && comprovanteAtual.trim() !== '') {
        comprovanteInfo.classList.remove('d-none');
        comprovanteNome.textContent = comprovanteAtual;
        comprovanteArquivo.value = comprovanteAtual;
    } else {
        comprovanteInfo.classList.add('d-none');
        comprovanteArquivo.value = '';
    }
    
    // Carregar despesas da categoria e selecionar a correta
    if (categoriaId && despesaId) {
        carregarDespesasPorCategoriaModal(categoriaId, despesaId);
    }
    
    // Alterar título do modal
    const titulo = document.querySelector('#modalAdicionarDespesa .modal-title');
    titulo.innerHTML = '<i class="bi bi-pencil me-2"></i>Editar: ' + nome + ' (' + (isFixa ? 'Fixa' : 'Variável') + ')';
    
    // Alterar texto do botão
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Atualizar Despesa';
    
    // Adicionar atributo para identificar que é edição
    form.setAttribute('data-editing', 'true');
    form.setAttribute('data-despesa-evento-id', despesaEventoId);
    
    // ✅ VALIDAÇÃO DE VALOR MÉDIO PARA EDIÇÃO
    // Aguardar um pouco para garantir que os campos foram preenchidos, depois aplicar validação
    setTimeout(() => {
        // Limpar alertas anteriores
        if (typeof limparAlertasValorMedio === 'function') {
            limparAlertasValorMedio();
        }
        
        // Buscar valor médio e aplicar validação se a função existir
        if (typeof buscarValorMedio === 'function' && despesaId) {
            buscarValorMedio(despesaId).then(response => {
                if (response.success && response.valor_medio) {
                    console.log('🔄 Valor médio encontrado para edição:', response.valor_medio_formatado);
                    
                                            // Aplicar validação no valor atual se a função existir
                        const valorInput = document.getElementById('modal_despesa_valor');
                        if (valorInput && typeof validarVariacaoValorMedioInput === 'function') {
                            // Armazenar valor médio atual para validação
                            window.valorMedioAtual = response.valor_medio;
                            
                            // Aplicar validação no valor atual
                            validarVariacaoValorMedioInput(valorInput, response.valor_medio);
                            
                            // ✅ CONFIGURAR VALIDAÇÃO EM TEMPO REAL
                            // Remover listeners anteriores para evitar duplicação
                            const novoInput = valorInput.cloneNode(true);
                            valorInput.parentNode.replaceChild(novoInput, valorInput);
                            
                            // Adicionar novo listener para validação em tempo real
                            novoInput.addEventListener('input', function() {
                                if (window.valorMedioAtual) {
                                    validarVariacaoValorMedioInput(this, window.valorMedioAtual);
                                }
                            });
                            
                            console.log('✅ Validação de valor médio aplicada na edição com tempo real');
                        }
                }
            }).catch(error => {
                console.log('ℹ️ Erro ao buscar valor médio para edição:', error);
            });
        }
    }, 300);
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalAdicionarDespesa'));
    modal.show();
}

// A lógica de edição foi integrada na função adicionarDespesaEvento original

// Função para visualizar comprovante atual
function visualizarComprovante() {
    const nomeArquivo = document.getElementById('comprovante_atual_arquivo').value;
    if (nomeArquivo) {
        window.open(`/uploads/comprovantes/${nomeArquivo}`, '_blank');
    }
}

// Função para excluir comprovante atual
function excluirComprovanteAtual() {
    if (!confirm('Tem certeza que deseja excluir o comprovante atual? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    // Obter ID do evento e despesa evento
    const form = document.querySelector('#modalAdicionarDespesa form');
    const despesaEventoId = form.getAttribute('data-despesa-evento-id');
    const eventoId = obterEventoId();
    
    if (!eventoId || !despesaEventoId) {
        alert('Erro: Não foi possível identificar o evento ou despesa');
        return;
    }
    
    // Desabilitar botão durante exclusão
    const excluirBtn = document.querySelector('[onclick="excluirComprovanteAtual()"]');
    const originalText = excluirBtn.innerHTML;
    excluirBtn.disabled = true;
    excluirBtn.innerHTML = '<i class="bi bi-clock"></i>';
    
    // Fazer requisição AJAX para excluir
    fetch(`/eventos/${eventoId}/excluir-comprovante/${despesaEventoId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Esconder interface do comprovante
            document.getElementById('comprovante_atual_info').classList.add('d-none');
            document.getElementById('comprovante_atual_arquivo').value = '';
            
            // Mostrar mensagem de sucesso
            mostrarToast(result.message, 'success');
            console.log('✅ Comprovante excluído com sucesso');
        } else {
            alert('Erro: ' + result.message);
            console.error('❌ Erro:', result.message);
        }
    })
    .catch(error => {
        console.error('❌ Erro na requisição:', error);
        alert('Erro de conexão ao excluir comprovante');
    })
    .finally(() => {
        // Reabilitar botão
        excluirBtn.disabled = false;
        excluirBtn.innerHTML = originalText;
    });
}

// Função para editar despesa do evento
function editarDespesaEvento(form, despesaEventoId) {
    const formData = new FormData(form);
    
    // Desabilitar botão durante envio
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>Atualizando...';
    
    // Obter ID do evento
    const eventoId = obterEventoId();
    if (!eventoId) {
        alert('Erro: Não foi possível identificar o evento');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        return;
    }
    
    // Enviar para o backend usando FormData para suportar arquivo
    fetch(`/eventos/${eventoId}/editar-despesa/${despesaEventoId}`, {
        method: 'PUT',
        body: formData  // FormData já inclui o arquivo e outros dados
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();
            
            // Recarregar a página
            window.location.reload();
        } else {
            alert('Erro: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar despesa: ' + error);
    })
    .finally(() => {
        // Reabilitar botão e limpar atributos de edição
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Adicionar Despesa';
        form.removeAttribute('data-editing');
        form.removeAttribute('data-despesa-evento-id');
        
        // Restaurar título do modal
        const titulo = document.querySelector('#modalAdicionarDespesa .modal-title');
        titulo.innerHTML = '<i class="bi bi-credit-card me-2"></i>Adicionar Despesa';
    });
}

// Função para atualizar despesa da cabeça automaticamente
function atualizarDespesaCabeca(checkbox) {
    const despesaEventoId = checkbox.getAttribute('data-despesa-evento-id');
    // Extrair ID do evento da URL
    const eventoId = window.location.pathname.match(/\/eventos\/editar\/(\d+)/)?.[1] || 
                     window.location.pathname.match(/\/eventos\/(\d+)/)?.[1];
    const despesaCabeca = checkbox.checked;
    
    console.log('=== ATUALIZANDO DESPESA CABEÇA ===');
    console.log('Despesa Evento ID:', despesaEventoId);
    console.log('Evento ID:', eventoId);
    console.log('Despesa Cabeça:', despesaCabeca);
    
    // Desabilitar o checkbox temporariamente
    checkbox.disabled = true;
    
    // Fazer requisição AJAX
    fetch(`/eventos/${eventoId}/atualizar-despesa-cabeca/${despesaEventoId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            despesa_cabeca: despesaCabeca
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Resposta do servidor:', data);
        
        if (data.success) {
            // Mostrar mensagem de sucesso discreta
            mostrarToast(data.message, 'success');
            console.log(`✅ ${data.message}`);
        } else {
            // Reverter o checkbox em caso de erro
            checkbox.checked = !despesaCabeca;
            mostrarToast(data.message || 'Erro ao atualizar despesa', 'error');
            console.error('❌ Erro:', data.message);
        }
    })
    .catch(error => {
        console.error('❌ Erro na requisição:', error);
        // Reverter o checkbox em caso de erro
        checkbox.checked = !despesaCabeca;
        mostrarToast('Erro de conexão ao atualizar despesa', 'error');
    })
    .finally(() => {
        // Reabilitar o checkbox
        checkbox.disabled = false;
    });
}

// Função para mostrar toast/notificação discreta
function mostrarToast(mensagem, tipo = 'info') {
    // Criar elemento de toast
    const toast = document.createElement('div');
    toast.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Adicionar ao body
    document.body.appendChild(toast);
    
    // Remover automaticamente após 3 segundos
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// Função para coletar despesas cabeça e adicionar ao formulário
function incluirDespesaCabecaNoFormulario() {
    // Limpar campos hidden existentes
    const container = document.getElementById('despesas-cabeca-hidden');
    container.innerHTML = '';
    
    // Coletar todos os checkboxes de despesa_cabeca marcados
    const checkboxes = document.querySelectorAll('.despesa-cabeca:checked');
    console.log('=== INCLUINDO DESPESAS CABEÇA NO FORMULÁRIO ===');
    console.log('Checkboxes marcados encontrados:', checkboxes.length);
    
    checkboxes.forEach((checkbox, index) => {
        const despesaEventoId = checkbox.getAttribute('data-despesa-evento-id');
        if (despesaEventoId) {
            // Criar campo hidden
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'despesa_cabeca_evento[]';
            hiddenInput.value = despesaEventoId;
            container.appendChild(hiddenInput);
            
            console.log(`Despesa cabeça ${index + 1}: ID ${despesaEventoId}`);
        }
    });
    
    console.log('Total de despesas cabeça incluídas:', container.children.length);
}

// Interceptar submit do formulário principal para incluir despesas cabeça
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="POST"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Incluir despesas cabeça antes do submit
            incluirDespesaCabecaNoFormulario();
            
            console.log('=== FORMULÁRIO SENDO ENVIADO ===');
            console.log('Despesas cabeça incluídas no formulário');
        });
    }
});

var forms = document.querySelectorAll('.needs-validation');

// TESTE FINAL - VERIFICA SE SCRIPT CHEGOU ATÉ O FIM
console.log('🏁 SCRIPT COMPLETAMENTE CARREGADO - Final do arquivo JavaScript');
console.log('📋 Total de elementos form encontrados:', forms.length);
</script>

<!-- Script de cidades dinâmicas -->
<script src="{{ url_for('static', filename='js/cidades.js') }}"></script>

<!-- Estilos CSS para destacar cabeçalhos das categorias -->
<style>
/* Cabeçalhos das categorias mais destacados com melhor contraste */
.card-header.bg-success {
    background-color: #198754 !important;
    color: #ffffff !important;
    border: 2px solid #155724 !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
}

.card-header.bg-danger {
    background-color: #dc3545 !important;
    color: #ffffff !important;
    border: 2px solid #721c24 !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
}

/* Barra superior colorida para destaque */
.card-header.bg-success::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background-color: #0d5132;
}

.card-header.bg-danger::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background-color: #58151c;
}

/* Texto dos cabeçalhos com melhor contraste */
.card-header h5 {
    color: #ffffff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
    font-weight: 700 !important;
    letter-spacing: 0.8px !important;
    margin: 0 !important;
    padding: 4px 0 !important;
}

/* Ícones dos cabeçalhos */
.card-header h5 i {
    font-size: 1.1em;
    margin-right: 8px;
    color: #ffffff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
}

/* Efeito hover nos cards */
.card:hover .card-header.bg-success {
    background-color: #157347 !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
}

.card:hover .card-header.bg-danger {
    background-color: #bb2d3b !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
}

/* Melhorar contraste dos cards */
.card {
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* Estilo responsivo para dispositivos móveis */
@media (max-width: 768px) {
    .card-header h5 {
        font-size: 13px !important;
        letter-spacing: 0.5px !important;
    }
    
    .card-header h5 i {
        font-size: 1em;
        margin-right: 6px;
    }
}
</style>

<!-- Script do Modal Unificado -->
<script src="{{ url_for('static', filename='js/modal-despesa-unificado.js') }}"></script>

<!-- Configurar modal para contexto de novo evento -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Aguardar carregamento do modal unificado
    setTimeout(() => {
        if (modalDespesaUnificado) {
            // Configurar contexto específico para novo evento
            modalDespesaUnificado.contexto = 'novo_evento';
            
            // Substituir botões que abriam o modal antigo
            const botoesAdicionarDespesa = document.querySelectorAll('[onclick*="abrirModalDespesa"]');
            botoesAdicionarDespesa.forEach(botao => {
                const onclickOriginal = botao.getAttribute('onclick');
                // Manter a chamada original, pois já atualizamos a função
            });
        }
    }, 100);
});
</script>

{% endblock %}

{% endblock %} 